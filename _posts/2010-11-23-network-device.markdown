---

title: Network device
abstract: A network multifunction peripheral includes an NIC that conducts communication with a LAN and a recording unit that can be put in a normal power state and a low-power consumption state. The recording unit processes received data when the recording unit is in the normal power state. The NIC includes a transmit-receive unit that transmits and receives data, a power state determining unit that determines the power state of the recording unit, a start-up signal output unit that outputs a start-up signal when a session establishment request signal is received from a PC and when determined that the recording unit is in the low-power consumption state, and a persistent connection control unit that performs persistent connection control to prohibit the PC from transmitting the data while a session is maintained with the PC until the recording unit is started up.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08793513&OS=08793513&RS=08793513
owner: Murata Machinery, Ltd
number: 08793513
owner_city: Kyoto
owner_country: JP
publication_date: 20101123
---
This application claims priority under 35 U.S.C. 119 to Japanese Patent Application No. 2009 270812 filed on Nov. 27 2009 which application is hereby incorporated by reference in its entirety.

The present invention relates to a network device that is used while connected to a network particularly to a network device that can be put in a low power consumption state.

Recently from a viewpoint of COemission reduction there is a social demand for low power consumption of an electric instrument. For example in a network device connected to a network such as a LAN there is known a network device in which only a Network Interface Controller hereinafter referred to as NIC connected directly to the network is operated while power supplies of a CPU and a hard disk are stopped during standby thereby realizing power saving. An example of the network device is a network printer that transitions to the low power consumption state in which the supply of the power to a printer controller a printer engine and the like are stopped during standby. In a configuration of such a network printer only the NIC is operated to wait for print data transmitted from an external host computer hereinafter also referred to as communication terminal when the network printer is in the low power consumption state and the printer controller and the like are returned from the low power consumption state to a normal power state when the print data is received.

In this case print data processing cannot be performed when the printer controller and the like are being started up. In order not to receive the print data during the start up there is considered a configuration in which a session is not established with the communication terminal when starting up the printer controller and the like. However with such a configuration the communication terminal repeatedly transmits a session establishment request at predetermined time intervals. Therefore even if the start up of the printer controller and the like is ended to be able to establish the session with the communication terminal the session cannot be established until the communication terminal transmits the session establishment request again. Therefore the receive processing and the print data processing cannot be started although the print data processing can be performed which causes a problem in that the start of the processing is delayed. Further when the session is timed out because a response is not received for a predetermined time or more a determination is made that the session cannot be established to possibly generate an error on the communication terminal side.

In order to solve the above problems for example there is a multifunction peripheral that prohibits the data transmission by continuously transmitting a denial signal NACK to a source communication terminal of a print request until a confirmation that a PDL board returns to an operable state can be obtained. In the multifunction peripheral when a main board receives a print request from a terminal device through an interface in an energy saving mode a function of a power supply circuit is activated to start the return to the normal mode from the energy saving mode through a standby mode. At the same time a control unit of the main board monitors the state of the PDL board and the control unit transmits the denial signal NACK to the source of the print request to prohibit the terminal device from performing the data transmission until a confirmation that the return of the PDL board to the operable state is completed can be obtained. When the completion of the return is confirmed a signal ACK for permitting the print request is transmitted to the source to permit the data transmission.

However in a network communication control a protocol that can use the signal NACK is limited to a specific protocol such as an LPR protocol Line Printer daemon protocol . Moreover even if the LPR protocol is used the signal NACK is ignored and will not function effectively when a host computer adopts Windows registered trademark hereinafter the same as an Operating System OS . Accordingly the control method performed by the above multifunction peripheral does not function effectively for the communication terminal in which a protocol except the LPR protocol is used and the communication terminal in which Windows is adopted as the OS. That is the conventional network device has poor versatility.

The present invention has been made to overcome the problems described above. An object of the present invention is to provide a network device in which during start up from a second power state data transmission performed by a communication terminal can be controlled while unconstrained by a protocol used and an OS of the communication terminal that is a data source.

A network device of the present invention includes a communication unit and a processing unit. The communication unit is connected to the communication terminal through a network and conducts communication with a communication terminal. The processing unit is connected to the communication unit through a communication channel the processing unit that is put in a first power state and a second power state whose power consumption is smaller than that of the first power state and the processing unit processes received data received from the communication unit when the processing unit is in the first power state. Further the communication unit includes a transmit receive unit a determination unit a transition unit and a persistent connection control unit. The transmit receive unit transmits and receives data to and from the communication terminal through the network. The determination unit determines the power state of the processing unit. The transition unit outputs a transition signal for causing the power state of the processing unit to transition to the first power state when the transmit receive unit receives the data from the communication terminal and when the determination unit determines that the processing unit is in the second power state. The persistent connection control unit establishes a session with the communication terminal when the transmit receive unit receives a session establishment request signal from the communication terminal and when the transition unit outputs a transition signal and the persistent connection control unit performs persistent connection control to prohibit the communication terminal from transmitting data while the session is maintained until the power state of the processing unit transitions to the first power state.

The network device according to the present invention includes the communication unit and the processing unit. For example during standby the processing unit is put into the second power state low power consumption state in which the power consumption becomes less and only the communication unit runs to perform the data waiting operation. During the waiting period for the data the power consumption can be set at less than that of the first power state except for apart of the network device that is the communication unit. Therefore the power consumption of the network device can be reduced. When the session establishment request signal is received through the network the session is established with the communication terminal and the transition signal is outputted to the processing unit. Until the power state of the processing unit transitions to the first power state start up the persistent connection control is performed to prohibit the communication terminal from transmitting the data while the session is maintained. Therefore when the processing unit is being started up from the second power state the data transmission performed by the communication terminal can be controlled while unconstrained by the protocol used and the OS of the communication terminal that is the data source.

The above network device is preferably configured as follows. That is the communication unit includes a receive buffer in which received data received from the communication terminal is temporarily stored. The transmit receive unit transmits a receivable data amount corresponding to a free space of the receive buffer to the communication terminal according to a predetermined communication protocol. The persistent connection control unit decreases a data amount read from the receive buffer compared with non persistent connection control such that the receivable data amount is smaller than a minimum transmittable data amount of the communication terminal until the determination unit determines that the power state of the processing unit has transitioned to the first power state.

Accordingly until the power state of the processing unit transitions to the first power state start up the data amount read from the receive buffer is decreased compared with the non persistent connection control that is the normal control such that the receivable data amount is smaller than the minimum transmittable data amount of the communication terminal. Therefore since the data amount read from the receive buffer is smaller than the data amount received from the communication terminal the free space of the receive buffer is reduced and a value typically zero smaller than the minimum transmittable data amount of the communication terminal is transmitted as the receivable data amount to the communication terminal. As a result while the session is maintained the data transmission performed by the communication terminal can be suppressed that is the persistent connection control can be realized.

The above network device is preferably configured as follows. That is the persistent connection control unit ends the persistent connection control to permit the communication terminal that has transmitted the session establishment signal to transmit the data when the determination unit determines that the power state has transitioned to the first power state.

In this case the persistent connection control is ended when the transition start up of the power state of the processing unit to the first power state is completed to be able to perform the data processing of the received data. Therefore the communication terminal is permitted to transmit the data. Because the session is already maintained at the time the persistent connection control is released the data communication can be rapidly started.

The above network device is preferably configured as follows. That is the persistent connection control unit increases the data amount read from the receive buffer compared with the persistent connection control such that the receivable data amount is larger than the minimum transmittable data amount of the communication terminal when ending the persistent connection control to permit the communication terminal that has transmitted the session establishment signal to transmit the data.

In this case when the power state of the processing unit transitions to the first power state start up to end the persistent connection control the data amount read from the receive buffer is increased compared with the persistent connection control and the free space that is the receivable data amount of the receive buffer is set larger than the minimum transmittable data of the communication terminal. The data size corresponding to the free space is transmitted as the receivable data amount to the communication terminal that has transmitted the session establishment request signal. Therefore the communication terminal can transmit the transmitted data and the transition from the persistent connection control to the normal control can smoothly be made after the power state of the processing unit has transitioned to the first power state.

The above network device is preferably configured as follows. That is the predetermined communication protocol is TCP IP.

The above network device is preferably configured as follows. That is the transmit receive unit transmits a value of zero as the receivable data amount to the communication terminal when the free space of the receive buffer is smaller than a predetermined value while the persistent connection control unit performs the persistent connection control.

The above network device is preferably configured as follows. That is the communication unit includes a storage unit in which the received data read from the receive buffer is stored. In the above network device the received data stored in the storage unit is transferred to the processing unit when the determination unit determines that the power state of the processing unit has transitioned to the first power state.

The above network device is preferably configured as follows. That is the communication unit includes a transition determination unit for determining whether the power state of the processing unit needs to be transitioned to the first power state when the data is received by the transmit receive unit and when the determination unit determines that the processing unit is in the second power state. The transition unit outputs the transition signal when the transition determination unit determines that the power state of the processing unit needs to be transitioned to the first power state and the persistent connection control unit prohibits the communication terminal from transmitting the data while the session is maintained until the power state of the processing unit transitions to the first power state when the transition determination unit determines that the power state of the processing unit needs to be transitioned to the first power state.

In this case the power state of the processing unit transitions to the first power state only when the power state of the processing unit needs to be transitioned to the first power state start up . Therefore the running time of the processing unit can be suppressed to the minimum and the power consumption of the network device can further be reduced.

The above network device is preferably configured as follows. That is the communication unit includes a production unit for producing a response to the data received by the transmit receive unit when the transition determination unit determines that the power state of the processing unit need not be transitioned to the first power state. The transmit receive unit outputs the response produced by the production unit to the communication terminal when the transition determination unit determines that the power state of the processing unit need not be transitioned to the first power state.

Accordingly when the power state of the processing unit need not be transitioned to the first power state start up the power state of the processing unit does not transition to the first power state and a response to the received data is performed on the communication unit side. Therefore the unnecessary transition of the power state of the processing unit to the first power state can be suppressed and the power consumption of the network device can further be reduced.

The above network device is preferably configured as follows. That is in the network device according to the present invention the processing unit is a printer that prints out print data received by the communication unit onto a sheet.

The above network device is preferably configured as follows. That is the persistent connection control unit controls the transmit receive unit such that a value smaller than a minimum transmittable data amount of the communication terminal is transmitted as the receivable data amount to the communication terminal according to a predetermined communication protocol until the determination unit determines that the power state of the processing unit has transitioned to the first power state.

Accordingly the persistent connection control can be realized without adjusting the read amount from the receive buffer by directly manipulating the receivable data amount included in the transmitted data.

The above network device is preferably configured as follows. That is the communication unit includes a receive buffer in which received data received from the communication terminal is temporarily stored. The transmit receive unit transmits a receivable data amount corresponding to a free space of the receive buffer to the communication terminal according to a predetermined communication protocol. The persistent connection control unit controls the transmit receive unit such that a value smaller than a minimum transmittable data amount of the communication terminal is transmitted as a receivable data amount irrespective of the receivable data amount according to a predetermined communication protocol until the determination unit determines that the power state of the processing unit has transitioned to the first power state.

According to the present invention when the processing unit is being started up from the low power consumption state the data transmission performed by the communication terminal can be controlled while unconstrained by the protocol used and the OS of the communication terminal that is the data source.

Other features elements processes steps characteristics and advantages of the present invention will become more apparent from the following detailed description of preferred embodiments of the present invention with reference to the attached drawings.

Hereinafter preferred embodiments of the present invention will be described with reference to the drawings. In the drawings the same constituent is designated by the same reference numeral and overlapping description will not be given. A network multifunction peripheral MFP is described as an example of a network device according to an embodiment. A network system in which the network multifunction peripheral is connected to a personal computer hereinafter referred to as PC and corresponds to a communication terminal described in the claims through a LAN is described by way of example. A configuration of the network system described by way of example is simplified for the sake of easy understanding. First an entire configuration of a network multifunction peripheral will be described with reference to . is a block diagram illustrating the entire configuration of the network multifunction peripheral connected to a LAN . is a block diagram illustrating a configuration of a transmit receive unit of an NIC constituting the network multifunction peripheral .

The network multifunction peripheral is a network multifunction peripheral that can be put in a low power consumption state energy saving mode during standby. The network multifunction peripheral includes a scanner function of reading a document to produce image data a copy function of recording the image data onto a sheet a FAX receiving function of recording the image data received through facsimile communication onto the sheet and a PC print function of recording the image data received from a PC connected through the LAN onto the sheet. In addition to a FAX transmitting function of transmitting a facsimile of the read image data the network multifunction peripheral includes a PC FAX function of transmitting the facsimile of the image data received from the external PC . The network multifunction peripheral further includes an Internet FAX IFAX function of transmitting and receiving the image data through an IP network by utilizing an electronic mail.

In order to realize these functions the network multifunction peripheral includes the NIC a control unit a recording unit a manipulation unit a display unit a read unit a codec an image storage unit a modem an NCU an IFAX control unit and a Web server . The units are connected through a bus which corresponds to a communication channel described in the claims such as Peripheral Component Interconnect PCI and PCI Express while being able to conduct communication to each other. In this case the NIC corresponds to a communication unit described in the claims and other units from the control unit to the Web server except the NIC correspond to a processing unit described in the claims. Hereinafter there will be described a case where by way of example the recording unit is put in a low power consumption state which corresponds to a second power state described in the claims and a normal power state which corresponds to a first power state described in the claims and print data is transmitted from the PC through the LAN .

The NIC is a network interface that performs transmit receive control processing to various communication protocols and data analysis processing and data production processing on various communication protocols. The NIC is connected to the PC through the LAN and the NIC can conduct data communication with the PC according to for example TCP IP. Electric power is supplied to the NIC even if the network multifunction peripheral is in the standby state that is the low power consumption state energy saving mode .

The NIC includes a microprocessor that performs an operation a ROM in which a program for causing the microprocessor to perform each piece of processing is stored a communication chip IC that is controlled by the microprocessor to perform the communication processing and a RAM in which received data is temporarily stored. The received data is received by the communication chip and is read from the communication chip. The NIC may be configured using a microcomputer in which the microprocessor the communication chip the ROM and the RAM are accommodated in one chip.

In the NIC a transmit receive unit a storage unit a power state determining unit a start up necessity determining unit a start up signal output unit a response data producing unit and a persistent connection control unit are structured by a combination of the above described hardware and software.

For example the transmit receive unit receives a network packet such as print data from the PC through the LAN . The transmit receive unit outputs response data and the like produced by the response data producing unit and the like to the PC through the LAN . As illustrated in the transmit receive unit includes a LAN device unit a receive buffer a transmit buffer and a TCP IP protocol stack

The LAN device unit includes a PHY PHYsical Layer unit that converts a logic signal and an electric signal in the interface such as Ethernet registered trademark hereinafter the same and a MAC unit that includes a transmit TX unit and a receive RX unit . The MAC unit takes out received data Ethernet frame from the PHY unit through the receive unit and stores the received data in a receive buffer specified by a receive descriptor. The MAC unit outputs transmitted data Ethernet frame to the PHY unit through the transmit unit from a transmit buffer specified by a transmit descriptor. Herein each of the receive buffer and the transmit buffer has a ring structure or a chain structure . A beginning address or the like of the receive buffer in which the received data is stored is recorded in the receive descriptor and a beginning address or the like of the transmit buffer in which the pieces of data waiting for its turn of transmission are stored is recorded in the transmit descriptor.

The TCP IP protocol stack is a software group in which protocols necessary to realize the functions on the network are stacked in a hierarchical state. The TCP IP protocol stack includes an application layer a transport layer an Internet protocol IP layer and a physical layer. When the packet passes through the TCP IP protocol stack the protocol of each layer adds a field to a basic header or deletes the field from the basic header. A recv function of a TCP IP protocol stack Application Programming Interface API is used to read receiving manipulation received data TCP data from the receive buffer through the TCP IP protocol stack . The transmitted data can be obtained through the recv function. On the other hand a send function of the TCP IP protocol stack API is used to transmit data through a socket in which the connection is established. The transmitted data can be written transmitting operation in the transmit buffer through the TCP IP protocol stack by utilizing the send function.

For example the power state determining unit determines the power state of the recording unit based on a level Hi or Low of a port connected to the recording unit . Specifically the power state determining unit determines that the recording unit is in the normal power state normal mode when the port level is Hi 5 V and determines that the recording unit is in the low power consumption state energy saving mode when the port level is Low 0 V . That is the power state determining unit acts as a determination unit described in the claims.

The start up necessity determining unit determines whether the recording unit needs to be started up that is the power state of the recording unit transitions to the normal power state when the transmit receive unit receives the network packet data and when the power state determining unit determines that the recording unit is in the low power consumption state. That is the start up necessity determining unit corresponds to a transition determination unit described in the claims. In this case the determination as to whether the recording unit needs to be started up is made based on whether a response can be performed only by the NIC . Examples of the case where the response can be performed only by the NIC include a Get Printer Attribute response an ARP response an SNMP response an ICMP response for example Ping packet response of IPP which are TCP IP level commands regularly transmitted from the PC to the NIC . On the other hand network print control in which TCP IP such as LPD Port and IPP is used is cited as an example of the case where the response cannot be performed only by the NIC .

When the start up necessity determining unit determines that the recording unit needs to be started up the start up signal output unit outputs a start up signal which causes the recording unit to transition from the low power consumption state to the normal power state to the recording unit or a power control unit that controls the supply of the power. That is the start up signal output unit acts as a transition unit described in the claims. The supply of the power to the recording unit is started when the start up signal output unit outputs the start up signal. Start up processing such as program load is performed in the recording unit thereby starting up the recording unit . The port level is set to Hi when the start up of the recording unit is completed.

The response data producing unit produces response data with respect to the data received by the transmit receive unit when the start up necessity determining unit determines that the recording unit need not be started up. For example the response data producing unit produces the response data with respect to the Get Printer Attribute ARP SNMP and ICMP. That is the response data producing unit acts as a production unit described in the claims. The response data produced by the response data producing unit is outputted to the transmit receive unit .

For example the persistent connection control unit establishes a session with the PC that has transmitted a session establishment request signal when the transmit receive unit receives the session establishment request signal from the PC . The persistent connection control unit then determines whether the recording unit is in the normal power state that is the recording unit is in the state in which the print processing can be performed based on the determination result of the power state determining unit . When the recording unit is in the low power consumption state that is the recording unit is in the state in which the print processing cannot be performed the persistent connection control unit performs persistent connection control keep alive to prohibit the PC from transmitting the data while the session is maintained until the power state determining unit determines that the recording unit has transitioned from the low power consumption state to the normal power state. On the other hand when the recording unit is in the normal power state the persistent connection control unit permits the PC to transmit the data without performing the persistent connection control. That is the persistent connection control unit acts as a persistent connection control unit described in the claims.

As described above the transmit receive unit constituting the NIC includes the receive buffer having a capacity of for example about 4 K bytes in which the received data received from the PC and the like through a predetermined port is temporarily stored and the transmit receive unit transmits to the PC and the like a receivable data amount corresponding to a free space of the receive buffer according to TCP IP. When the free space of the receive buffer becomes a predetermined value or less for example a half or less the transmit receive unit may transmit a value of zero as the receivable data amount. When the recording unit is determined to be in the low power consumption state the persistent connection control unit decreases the data amount for example several bytes to several ten of bytes read from the receive buffer using the recv function compared with non persistent connection control that is the normal control such that the receivable data amount becomes smaller than a minimum transmittable data amount of the PC until the recording unit is determined to have transitioned from the low power consumption state to the normal power state. Thus the persistent connection control unit adjusts the data amount read from the receive buffer through TCP IP protocol stack thereby realizing the persistent connection control.

In performing the persistent connection control the persistent connection control unit ends the persistent connection control when the recording unit is determined to have transitioned from the low power consumption state to the normal power state that is when the recording unit is started up and the persistent connection control unit permits the PC that has transmitted the session establishment request signal to transmit the data. In this case when ending the persistent connection control to permit the PC to transmit the data the persistent connection control unit increases the data amount for example several hundred bytes to several thousand bytes read from the receive buffer using the recv function compared with the persistent connection control such that the receivable data amount is larger than the minimum transmittable data amount of the PC thereby realizing the transition to the normal control non persistent connection control .

Returning to the control unit includes a microprocessor that performs an operation a ROM in which a program for causing the microprocessor to perform each piece of processing is stored a RAM in which various pieces of data such as operation result is temporarily stored and a backup RAM in which backup data is stored. The control unit executes the program stored in the ROM thereby wholly controlling the hardware constituting the network multifunction peripheral .

The recording unit is an electrophotographic printer. For example the recording unit prints out print data such as PDL data received from the external PC connected through the LAN onto the sheet. The recording unit also prints out the image data read and produced by the read unit and the image data received by FAX and IFAX onto the sheet. Therefore the recording unit includes a printer controller and a printer engine . When the print out is not performed for a predetermined time the power of the control unit and the recording unit are cut off to become the low power consumption state. On the other hand as described above the supply of the power is started in response to the start up signal outputted from the start up signal output unit and the control unit and the recording unit become the normal power state.

The printer controller includes a microprocessor that performs an operation a nonvolatile flash memory ROM in which a language processing program and font data are stored and a RAM. The language processing program causing the microprocessor to perform processing and the font data are loaded from the flash memory and stored in the RAM and various pieces of data such as the operation result are temporarily stored in the RAM. The printer controller executes the language processing program and the like loaded on the RAM thereby realizing a function of expanding the print data PDL data to raster data and a function of controlling the printer engine . The printer controller outputs the expanded raster data to the printer engine

The printer engine is a print mechanism that performs printing. The printer engine is controlled by the printer controller and prints the raster data inputted from the printer controller onto the sheet. More particularly the printer engine prints the raster data by performing printing processes such as sheet feed charging of a drum laser irradiation toner application and transferring and fixing of an image to a sheet.

The manipulation unit includes a plurality of keys such as a numerical keypad an abbreviated key a start key a stop key and various function keys which are used to utilize each function of the network multifunction peripheral . The display unit is a display device in which an LCD or the like is used and displays an operating state of the network multifunction peripheral and or various setting contents. The read unit includes a light source and a CCD. The read unit reads a document such as a paper document in each line according to set sub scanning line density to produce the image data.

The codec compression codes the image data read by the read unit and decodes the compression coded image data. The image storage unit includes a DRAM. The image data compression coded by the codec the FAX received image data and the image data that is received from the external PC and compression coded are stored in the image storage unit .

The modem modulator demodulator modulates and demodulates between a digital signal and an analog signal. The modem generates and detects various pieces of function information such as a digital command signal DCS . The Network Control Unit NCU is connected to the modem to control the connection between the modem and a Public Switched Telephone Network PSTN . The NCU includes a function of transmitting a calling signal corresponding to a facsimile number of a destination and a function of detecting the incoming facsimile number.

The IFAX control unit controls an IFAX function that utilizes an Internet environment. The IFAX control unit includes a function of transmitting an electronic mail according to a Simple Mail Transfer Protocol SMTP and a function of receiving the electronic mail according to a Post Office Protocol POP . The IFAX control unit attaches to the electronic mail a transmitted document as the image data in a TIFF format or the like and transmits the electronic mail to a mail address SMTP server . The IFAX control unit receives the electronic mail from a POP server in every set time to print out the attached file. The Web server can access pieces of data such as a home page described in HTML a log in page and a facsimile manipulation page from the PC to perform a predetermined HTTP task.

An operation of the network multifunction peripheral will be described below with reference to . is a first page of a flowchart illustrating a first processing procedure of communication processing persistent connection control processing performed by the network multifunction peripheral . is a second page of the flowchart. is a sequence diagram illustrating a communication procedure between the NIC and the PC in the first processing procedure.

In step S a determination is made as to whether an SYN signal is received that is whether a session establishment request SYN signal exists. When the SYN signal is not received the processing in step S is repeatedly performed until the SYN signal is received. On the other hand when the SYN signal is received the processing proceeds to step S.

In step S a determination is made as to whether a destination port of the SYN signal is a port number of the protocol supported by the network multifunction peripheral . The processing proceeds to step S when the destination port of the SYN signal is the port number of the protocol supported by the network multifunction peripheral . On the other hand when the destination port of the SYN signal is the port number of the protocol that is not supported by the network multifunction peripheral the processing proceeds to step S to perform the pieces of processing in steps S and S again.

In step S a determination is made as to whether the protocol needs to return from the low power consumption state based on received data. When it is determined that the protocol needs to return from the low power consumption state the processing proceeds to step S. On the other hand when it is determined that the protocol need not return from the low power consumption state the processing proceeds to step S of .

In step S an ACK SYN signal is transmitted in response to the received SYN signal. Subsequently in step S a determination is made as to whether the ACK signal is received from the PC as a response to the transmitted ACK SYN signal. When the ACK signal is received the session is established with the source and the processing proceeds to step S. On the other hand when the ACK signal is not yet received the processing in step S is repeatedly performed until the ACK signal is received.

When the session is established the TCP IP data print data receive processing is performed in step S. Subsequently in step S the received TCP IP data is stored in the storage unit . Then in step S the NIC performs response processing to the data.

Next in step S a determination is made as to whether a FIN signal is received from the PC . When the FIN signal is not received the processing in step S is repeatedly performed until the FIN signal is received. On the other hand when the FIN signal is received an ACK FIN signal is returned to the PC in step S. Then in step S a determination is made as to whether the ACK signal is received from the PC . When the ACK signal is not received the processing in step S is repeatedly performed until the ACK signal is received. On the other hand when the ACK signal is received the session is released to end the processing.

On the other hand when the affirmative determination is made in step S that is when it is determined that the protocol needs to return from the low power consumption state in step S a determination is made as to whether the recording unit network multifunction peripheral is in the low power consumption state. When it is determined that the recording unit is in the normal power state the processing proceeds to step S of . On the other hand when it is determined that the recording unit is in the low power consumption state the processing proceeds to step S.

In step S the ACK SYN signal is transmitted as a response to the received SYN signal. Subsequently in step S a determination is made as to whether the ACK signal is received from the PC as the response to the transmitted ACK SYN signal. When the ACK signal is received the session is established with the PC and the processing proceeds to step S. On the other hand when the ACK signal is not yet received the processing in step S is repeatedly performed until the ACK signal is received.

When the session is established the receive processing of the TCP IP data is performed in step S. Subsequently in step S the received TCP IP data is stored in the storage unit . Then in step S the received data stored in the storage unit is transferred to the recording unit .

Next in step S a determination is made as to whether the FIN signal is received from the PC . When the FIN signal is not received the processing proceeds to step S and the pieces of processing in steps S to S are repeatedly performed. On the other hand when the FIN signal is received the ACK FIN signal is returned to the source in step S. Then in step S a determination is made as to whether the ACK signal is received from the source. When the ACK signal is not received the processing in S is repeatedly performed until the ACK signal is received. On the other hand when the ACK signal is received the session is released to end the processing.

When it is determined that the recording unit network multifunction peripheral is in the low power consumption state in step S the ACK SYN signal is transmitted as the response to the received SYN signal in step S. When the ACK SYN signal is not returned the PC that has transmitted the session establishment request repeatedly transmits the session establishment request while a transmission interval is gradually increased for example 6 seconds 12 seconds 24 seconds 48 seconds and 72 seconds. When the ACK SYN signal is not returned after the elapse of 72 seconds the session establishment request processing is terminated. Subsequently in step S a determination is made as to whether the ACK signal is received from the PC as the response to the transmitted ACK SYN signal. When the ACK signal is received the session is established with the PC and the processing proceeds to step S. On the other hand when the ACK signal is not yet received the processing in step S is repeatedly performed until the ACK signal is received.

In step S the start up signal is outputted to start up the recording unit and the supply of the power to the recording unit is started. Subsequently in step S the received data is read in each several bytes for example ten bytes from the receive buffer using the recv function. The receivable data amount corresponding to the free space of the receive buffer is transmitted to the PC according to TCP IP ACK win xxxx and ACK win yyyy illustrated in where xxxx and yyyy represent the receivable data amount and xxxx yyyy .

In step S the received data read from the receive buffer is stored in the storage unit . Subsequently in step S a determination is made as to whether the recording unit has transitioned from the low power consumption state to the normal power state that is whether the recording unit is started up to become the state in which the print processing can be performed . When the recording unit has transitioned to the normal power state that is when the start up of the recording unit is completed to be able to perform the print processing the processing proceeds to step S. On the other hand when the recording unit has not transitioned to the normal power state that is when the print processing cannot be performed because the recording unit is being started up the processing proceeds to step S and the pieces of processing in steps S to S are repeatedly performed. Meanwhile because the data amount read from the receive buffer becomes smaller than the data amount received from the PC the free space of the receive buffer is gradually decreased with elapse of time and the value of zero or a value close to zero is transmitted as the receivable data amount to the PC after the elapse of a predetermined time ACK win 0 illustrated in . More particularly the ACK is returned to the PC as the NIC reads the received data. When receiving the ACK the PC transmits the next data in one time or in a plurality of times . At this time the PC transmits the data while a packet size is set smaller than the received receivable data amount. Therefore when the read of the received data is performed once the data is received one time or a plurality of times . Thus in step S the received data is read such that the one read amount is smaller than the received data amount per one ACK. As a result the transition is made to the persistent connection control in which transmission of the data transmitted from the PC is suppressed while the session is maintained and the persistent connection control is continuously performed until the recording unit is started up.

More specifically as illustrated in when the network multifunction peripheral returns the ACK win 0 whose windows size is zero the PC regularly transmits a signal TCP Zero Window Probe win 0 to ask whether the receive buffer becomes empty. In response to this signal the NIC returns a signal TCP Zero Window Probe ACK win 0 indicating that the free space does not exist in the receive buffer while the persistent connection control is continued. That is while the persistent connection control is maintained the signal TCP Zero Window Probe ACK win 0 is returned in response to the signal TCP Zero Window Probe win 0 . More particularly when the free space of the receive buffer is smaller than a predetermined value for example a half of the capacity of the receive buffer the correct free space is not transmitted as the receivable data amount but the value of zero is transmitted as the receivable data amount. Accordingly even immediately after the transition is made from the persistent connection control to the normal control the value of zero is transmitted as the receivable data amount until the free space reaches the predetermined value. Then the correct free space is transmitted as the receivable data amount after the free space reaches the predetermined value. Instead of the value of zero a value smaller than the minimum transmittable data amount of the PC may be set to the receivable data amount.

When the start up of the recording unit is completed the received data stored in the storage unit is transferred to the recording unit in step S. Subsequently in step S the persistent connection control is released and the normal receive processing the processing of reading the received data in each several K bytes from the receive buffer is performed to the TCP IP data. Therefore the free space of the receive buffer is rapidly increased to release the persistent connection control and the PC is permitted to transmit the data. More specifically when the persistent connection control is released the read amount from the receive buffer is considerably increased compared with the persistent connection control and instead of the signal TCP Zero Window Probe ACK win 0 the ACK win xxxx indicating the receivable data amount is returned to the signal TCP Zero Window Probe win 0 as illustrated in . Therefore the PC starts the data transmission.

Next in step S the received TCP IP data is stored in the storage unit . In step S the received data stored in the storage unit is transferred to the recording unit .

Subsequently in step S a determination is made as to whether the FIN signal is received from the PC . When the FIN signal is not received the processing proceeds to step S and the pieces of processing in steps S to S are repeatedly performed. On the other hand when the FIN signal is received the ACK FIN signal is returned to the source in step S. Then in step S a determination is made as to whether the ACK signal is received from the source. When the ACK signal is not received the processing in step S is repeatedly performed until the ACK signal is received. On the other hand when the ACK signal is received the session is released and the processing proceeds to step S.

In step S a signal instructing the recording unit network multifunction peripheral to transition to the low power consumption state is outputted to stop cut off the supply of the power to the recording unit network multifunction peripheral except the NIC . Then the processing is ended.

According to the present embodiment the network multifunction peripheral includes the NIC the control unit and the recording unit to the Web server . For example during standby the recording unit and the like transition to the low power consumption state energy saving mode and only the NIC runs to perform the data waiting operation. Therefore during the waiting for the data because the network multifunction peripheral can transition to the low power consumption state except for a part of the network multifunction peripheral that is the NIC the power consumption of the network multifunction peripheral can be reduced. When the session establishment request signal is received through the LAN the session is established with the PC and the start up signal is outputted to the recording unit . Until the recording unit is started up the persistent connection control that prohibits the PC from transmitting the data is performed while the session is maintained. Therefore irrespective of the protocol used and the OS of the PC that is the data source the data transmission from the PC can be controlled prohibited permitted when the recording unit is being started up from the low power consumption state.

According to the present embodiment until the recording unit is started up the data amount read from the receive buffer is decreased compared with the non persistent connection control that is the normal control such that the receivable data amount is smaller than the minimum transmittable data amount of the PC . Therefore because the data amount read from the receive buffer becomes smaller than the data amount received from the PC the free space of the receive buffer is reduced and the value typically zero smaller than the minimum transmittable data amount of the PC is transmitted as the receivable data amount to the PC . As a result transmission of the data transmitted from the PC can be suppressed that is the persistent connection control can be realized while the session is maintained.

Further according to the present embodiment the persistent connection control is ended when the recording unit is started up to be able to print out the print data. Therefore the PC is permitted to transmit the data. Because the session is already maintained at the end of the persistent connection control the data communication can be rapidly started.

Moreover according to the present embodiment when the recording unit is started up to end the persistent connection control the data amount read from the receive buffer is increased compared with the persistent connection control and the free space that is the receivable data amount of the receive buffer is set larger than the minimum transmittable data amount of the PC . The data size corresponding to the free space is transmitted as the receivable data amount to the PC that has transmitted the session establishment request signal. Therefore the PC can transmit the transmitted data and the transition from the persistent connection control to the normal control is smoothly made after the recording unit is started up.

Moreover according to the present embodiment the recording unit is started up only when the recording unit needs to be started up. Therefore because the running time of the recording unit can be suppressed to the minimum level the power consumption of the network multifunction peripheral can further be reduced.

Moreover according to the present embodiment when the recording unit does not need to be started up the response to the received data is performed on the side of the NIC without starting up the recording unit . Therefore since the unnecessary start up of the recording unit can be prevented the power consumption of the network multifunction peripheral can further be reduced.

In the above described control mode the persistent connection control unit adjusts the amount that is the receivable data amount of received data read from the receive buffer thereby realizing the persistent connection control. However the persistent connection control may also be realized by transmitting the value for example zero smaller than the minimum transmittable data amount of the PC as the receivable data amount of the network multifunction peripheral to the PC irrespective of the actual receivable data amount until it is determined that the recording unit is started up. A second control mode of the persistent connection control will be described below with reference to . is a flowchart illustrating a second processing procedure of the communication processing persistent connection control processing performed by the network multifunction peripheral . is a sequence diagram illustrating a communication procedure between the NIC and the PC in the second processing procedure.

In step S TCP IP API Bind is performed using an IP address of the NIC and a waiting port number. Therefore a socket that accepts a job is correlated that is bound with a local address that includes the IP address and the port number. Subsequently in step S TCP IP API Listen is performed to put the NIC in the state in which the session can be established. Therefore the socket bound in step S can wait for the session establishment request connection request .

Subsequently in step S a determination is made as to whether TCP IP API Accept processing is performed. The TCP IP API Accept processing is performed to accept the session establishment request thereby establishing the session. More specifically as illustrated in the session is established by returning the ACK SYN signal in response to the SYN signal. Then the processing proceeds to step S. On the other hand when the TCP IP API Accept processing is not performed the processing in step S is repeatedly performed until the TCP IP API Accept processing is performed.

In step S information on the PC in which the session is established and the port number of the NIC are retained in the storage unit . Subsequently in step S a determination is made as to whether the new received data Ethernet frame is stored in the receive buffer receive descriptor . When the new received data is not stored in the receive buffer the processing in step S is repeatedly performed until the new received data is stored. On the other hand when the new received data is stored the processing proceeds to step S.

In step S a determination is made as to whether the data of the receive buffer receive descriptor is the received data from the PC in which the session is established. When the data of the receive buffer is not the received data from the PC in which the session is established the received data is transferred to a TCP IP protocol stack in step S and the processing is at once ended. On the other hand when the data of the receive buffer is the received data from the PC in which the session is established the processing proceeds to step S.

In step S the received data Ethernet frame is retained in the storage unit . Subsequently in step S the start up signal is outputted to the recording unit in the low power consumption state in order to start up the recording unit and the supply of the power to the recording unit is started.

Then in step S the ACK data Ethernet frame whose windows size is zero is produced and stored in the transmit buffer transmit descriptor and the ACK data is returned ACK Window Size 0 illustrated in .

Next in step S a determination is made as to whether the signal TCP Zero Window Probe win 0 is received from the PC . The signal TCP Zero Window Probe win 0 is used to ask whether the receive buffer is empty. When the signal is not received the processing in step S is repeatedly performed until the signal is received. On the other hand when the signal is received the processing proceeds to step S.

In step S a determination is made as to whether the recording unit has transitioned from the low power consumption state to the normal power state that is whether the recording unit is started up to become the state in which the print processing can be performed. When the recording unit has not transitioned to the normal power state that is when the print processing cannot be performed because the recording unit is being started up the processing proceeds to step S. On the other hand when the recording unit has transitioned to the normal power state that is when the start up of the recording unit is completed to be able to perform the print processing the processing proceeds to step S.

When the recording unit is being started up the persistent connection control is continuously performed. That is the NIC returns the signal ACK Window Size 0 indicating that the free space does not exist in the receive buffer see . That is the signal ACK Window Size 0 is returned in response to the signal TCP Zero Window Probe while the persistent connection control is maintained. In this case the value of zero is transmitted as the receivable data amount irrespective of the actual free space receivable data amount of the receive buffer . Then the processing proceeds to step S and the pieces of processing in steps S to S are repeatedly performed to perform the persistent connection control until the recording unit is started up.

When the recording unit transitions to the normal power state that is when the start up is completed to be able to perform the print processing the received data Ethernet frame that is received and stored in the storage unit is transferred to the recording unit through the TCP IP protocol stack in step S. The persistent connection control is released to perform normal return processing ACK window size 1460 illustrated in . Then the processing is at once ended.

According to the present embodiment the persistent connection control can be achieved by directly manipulating the receivable data amount included in the transmitted data without adjusting the read amount from the receive buffer . Therefore irrespective of the protocol used and the OS of the PC that is the data source the data transmission from the PC can be more properly controlled prohibited permitted when the recording unit is being started up from the low power consumption state.

Although the embodiment of the present invention has been described above the present invention is not limited to the above embodiment but various modifications can be made. In the above embodiment the network multifunction peripheral is described as the network device according to the present invention by way of example. However the network device of the present invention is not limited to the network multifunction peripheral. For example the network device of the present invention may be a network home electrical appliance such as a television a machine tool an industrial machine and an unmanned carrier that are used while connected to the network.

In the above embodiment the recording unit that can be put in the low power consumption state is described by way of example. However the similar processing may be performed to the IFAX control unit the Web server and the like. In the above embodiment the recording unit network multifunction peripheral can be put in the low power consumption state energy saving mode and the normal power state normal mode . Alternatively the recording unit may be put in more power states for example the recording unit may further be put in a standby state standby mode as an intermediate state. In this case after the transition from the low power consumption state to the standby state is made to perform the data processing in the standby state the transition from the standby state to the low power consumption state may be made.

In the above embodiment the PC is used as the communication terminal. However the communication terminal is not limited to the PC. For example the network multifunction peripheral may be used as the communication terminal. In addition the communication protocol used is not limited to that of the above embodiment.

In the above embodiment when the network multifunction peripheral is in the low power consumption state the power is supplied to the whole of the NIC . However the present invention is not limited to such a configuration. For example the NIC may include a plurality of portions and the power may be supplied to only a part of the NIC while the supply of the power to other portions of the NIC is stopped when the network multifunction peripheral is in the low power consumption state.

While the present invention has been described with respect to preferred embodiments thereof it will be apparent to those skilled in the art that the disclosed invention maybe modified in numerous ways and may assume many embodiments other than those specifically set out and described above. Accordingly it is intended by the appended claims to cover all modifications of the present invention that fall within the true spirit and scope of the present invention.

