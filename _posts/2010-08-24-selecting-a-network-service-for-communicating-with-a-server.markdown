---

title: Selecting a network service for communicating with a server
abstract: The Domain Name System (DNS) can be used to query for security information in real time. A security module on a client detects a network connection and sends a test probe as a DNS resolution request to a DNS server associated with a security server via the network connection. The test probe requests resolution of a domain name for which the DNS server is authoritative. The security module analyzes a response to the test probe to determine whether the response is valid based on testing information included in the DNS response. Responsive to whether a valid response to the test probe is received, the security module selects a network service for subsequent communications via the network connection.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08407471&OS=08407471&RS=08407471
owner: Symantec Corporation
number: 08407471
owner_city: Mountain View
owner_country: US
publication_date: 20100824
---
The disclosure generally relates to computer security and in particular to exchanging information using Domain Name System DNS queries.

The Domain Name System DNS can be used to query for information in real time. While the DNS was originally intended to support domain name resolution services the DNS server resolving the query can include arbitrary information in the response. Moreover the DNS is designed to work quickly. Therefore the DNS is used to support types of queries beyond name resolution. For example a security vendor can use DNS queries to provide security related information to clients.

One difficulty with using the DNS to provide non standard information is that the data exchange between the client and intended DNS server might fail. Clients often connect to the Internet through Internet Service Providers ISPs and some ISPs manipulate DNS traffic to their own ends. Some ISPs block DNS traffic destined to non ISP controlled servers. In addition some ISPs perform non standard caching of DNS responses by e.g. ignoring Time To Live TTL values and caching prior responses for longer than the responses specified validity periods.

More problematically some ISPs transparently proxy DNS queries. Such proxied queries appear to the querying client to have been answered by the authoritative DNS server but in fact are handled by the ISP s own DNS server. This transparent proxying cannot be detected by the clients because the standard DNS provides no way of verifying that the true authoritative DNS server responded to the DNS query. As a result applications on the client can fail because the DNS query appears to resolve normally yet the response from the DNS server contains outdated or otherwise incorrect information.

Therefore there is a need for securely detecting transparently proxied DNS connections as well as for detecting other situations that might interfere with DNS queries.

The above and other needs are met by methods computer readable storage media and systems for selecting a network service for communicating with a server via a network connection.

One aspect provides a computer implemented method for selecting a network service for communication with a server. Embodiments of the method comprise detecting a network connection at a client and sending a test probe as DNS resolution request from the client to a DNS server associated with the server via the network connection. Responsive to receiving a response to the test probe the method analyzes the response to determine whether the response is valid. The method further selects a network service for subsequent communications with the server via the network connection responsive to whether a valid response to the test probe was received.

Another aspect provides a non transitory computer readable storage medium storing executable computer program instructions for selecting a network service for communication with a server. The computer readable storage medium stores computer program instructions for detecting a network connection at a client and for sending a test probe as DNS resolution request from the client to a DNS server associated with the server via the network connection. The computer readable storage medium further comprises computer program instructions for determining a received response to the test probe is valid. The computer readable storage medium further comprises computer program instructions for selecting a network service for subsequent communications with a server via the network connection responsive to whether a valid response to the test probe was received.

Still another aspect provides a computer system for selecting a network service for communication with a server. The system comprises a non transitory computer readable storage medium storing executable computer program modules including a network service initiation module a probe generation module a response analysis module and a network service selection module. The network service initiation module is for detecting a network connection at a client and the probe generation module is for sending a test probe as a DNS resolution request from the client to a DNS server associated with the server via the network connection. The response analysis module is for responsive to receiving a response to the test probe analyzing the response to determine whether the response is valid. The network service selection module is for selecting a network service for subsequent communications with a server via the network connection responsive to whether a valid response to the test probe was received.

The features and advantages described in the specification are not all inclusive and in particular many additional features and advantages will be apparent to one of ordinary skill in the art in view of the drawings specification and claims. Moreover it should be noted that the language used in the specification has been principally selected for readability and instructional purposes and may not have been selected to delineate or circumscribe the inventive subject matter.

Reference will now be made in detail to several embodiments examples of which are illustrated in the accompanying figures. It is noted that wherever practicable similar or like reference numbers may be used in the figures and may indicate similar or like functionality. The figures depict embodiments for purposes of illustration only. One skilled in the art will readily recognize from the following description that alternative embodiments of the structures and methods illustrated herein may be employed without departing from the principles described herein.

The client is used by a user to perform security related and other tasks. In one embodiment the client is a personal computer PC such as a desktop or notebook computer. In other embodiments the client is a mobile telephone personal digital assistant or other electronic device. For purposes of this description the term client also includes computers such as servers and gateways that perform security related tasks and interact with the security server .

The client executes a security module that detects malware residing at the client. The security module makes queries to the security server for security information. For example the security module can identify a file on the client and query the security server to request the reputation of the file e.g. whether the file is malicious or legitimate .

The security module can use a variety of network services to query the security server . For example the security module can send the query using the DNS by e.g. appending a hash of a file to a domain name for which a DNS server associated with the security server is authoritative and sending the query as a DNS resolution request. Similarly the security module can use the hypertext transport protocol HTTP the file transfer protocol FTP or other network services for the query.

In one embodiment the security module uses the DNS if it is operable. To determine whether the DNS is operable for querying the security server the security module sends a test probe to the security server via the DNS and analyzes the response. The test probe can request resolution of a domain name incorporating a hash of a file at the client of a domain name incorporating a hash value known to the security server DNS server to be used for testing and or incorporating other values. If the response is valid the security module continues to use the DNS to obtain security information from the security server . If the response is invalid the security module falls back on the other services for communicating with the security server .

The ISP provides clients with network access and related services. In addition the ISP operates a DNS proxy server for responding to DNS requests from the clients . While the ISP may provide the clients with unimpeded access to the network for most network services the ISP may handle DNS traffic using ISP specific policies. For example the ISP might block all DNS traffic to non ISP DNS servers or transparently route all client side DNS traffic to a DNS proxy server . In addition the DNS proxy server might not follow convention and ignore DNS parameters such as TTL that describe how long to cache DNS data. In addition the DNS proxy server might modify DNS responses received from authoritative servers before sending the responses to the clients .

The security server interacts with the clients via the network to provide security information. The security server operates a DNS server that responds to DNS queries from the clients . If a DNS resolution request is received by the DNS server associated with the security server the security server causes the DNS server to send a DNS response that includes the requested security information. If the security server receives a client query via a different network service e.g. HTTP the security server provides the requested security information using that network service.

The DNS server includes testing information in DNS responses that allows the security modules of the clients to determine whether the ISP is interfering with the DNS communications. For example in one embodiment the DNS server includes a timestamp in a DNS response that indicates the time that the response was sent. The DNS server also includes a TTL parameter in the response indicating for how long the response is valid. In addition the DNS server encrypts and digitally signs the testing information in the response using a private key having a public counterpart known to the client security modules . Depending upon the embodiment the DNS server can include the testing information in all DNS responses or in only a subset of DNS responses such as responses to DNS queries incorporating hash values known to be used for testing. The security modules of the clients can decrypt the responses from the DNS server to determine whether it is valid or whether the ISP is interfering with DNS communications.

The network enables communications among the clients ISP and the security server and can comprise the Internet. In one embodiment the network uses standard communications technologies and or protocols. Thus the network can include links using technologies such as Ethernet 802.11 worldwide interoperability for microwave access WiMAX 3G digital subscriber line DSL asynchronous transfer mode ATM InfiniBand PCI Express Advanced Switching etc. Similarly the networking protocols used on the network can include multiprotocol label switching MPLS the transmission control protocol Internet protocol TCP IP the User Datagram Protocol UDP the HTTP the simple mail transfer protocol SMTP the FTP etc. The data exchanged over the network can be represented using technologies and or formats including the hypertext markup language HTML the extensible markup language XML etc. In addition all or some of links can be encrypted using conventional encryption technologies such as secure sockets layer SSL transport layer security TLS virtual private networks VPNs Internet Protocol security IPsec etc. In another embodiment the entities can use custom and or dedicated data communications technologies instead of or in addition to the ones described above.

The storage device is any non transitory computer readable storage medium such as a hard drive compact disk read only memory CD ROM DVD or a solid state memory device. The memory holds instructions and data used by the processor . The pointing device may be a mouse track ball or other type of pointing device and is used in combination with the keyboard to input data into the computer system . The graphics adapter displays images and other information on the display . The network adapter couples the computer system to the network .

As is known in the art a computer can have different and or other components than those shown in . In addition the computer can lack certain illustrated components. For example a computer acting as a security server can lack a keyboard pointing device graphics adapter and or display . Moreover the storage device can be local and or remote from the computer such as embodied within a storage area network SAN .

As is known in the art the computer is adapted to execute computer program modules for providing functionality described herein. As used herein the term module refers to computer program logic utilized to provide the specified functionality. Thus a module can be implemented in hardware firmware and or software. In one embodiment program modules are stored on the storage device loaded into the memory and executed by the processor .

The network service initiation module monitors the client to detect when the client is connected to a network and whether the network is recognized. In one embodiment the initiation module detects when a new network connection is established at the client . For example a new connection can be established when the client is booted up when the client connects to a wireless access point and or when a network cable is plugged into the client . The initiation module can make the detection by registering with the client operating system for callbacks related to networking services by using available application programming interfaces APIs to enumerate available network connections and or by periodically probing any known network connections to detect changes.

Upon detecting a new or changed network connection an embodiment of the network service initiation module determines whether the network is recognized. In one embodiment the initiation module identifies the IP address assigned to the client by the network connection and uses this address to recognize the network. Sometimes a given network connection uses a fixed IP address and the initiation module can recognize the network based on whether the connection has the fixed address. Other network connections use variable IP addresses. However a client that repeatedly connects to the Internet via the same ISP will often receive IP addresses within the same range. Thus the initiation module can use the IP address to determine whether the network connection is through the same ISP by determining whether the IP address is within the range previously observed for that ISP.

The probe generation module generates test probes of network connections to determine if the network connections permit communications with the DNS server operated by the security server . In one embodiment the probe generation module probes unrecognized networks identified by the initiation module . Embodiments of the probe generation module can also periodically probe recognized network connections. In one embodiment the probe generation module probes by sending a DNS query to the DNS server operated by the security server . For example the probe generation module can send a DNS query requesting resolution of an address incorporating a hash of a file stored on the client or a predetermined hash used for test probes and a domain name for which the DNS server is known to be authoritative. If the ISP does not interfere with DNS requests the DNS query will be forwarded to and answered by the DNS server .

The response analysis module analyzes a DNS response to the test probe to determine whether the response is from the DNS server operated by the security server . In one embodiment the response analysis module verifies the digital signature of testing information contained within the response. The response analysis module also attempts to decrypt the testing information in the DNS response using the decryption key e.g. the public key counterpart to the private encryption key used by the DNS server . If the response analysis module cannot verify and or decrypt the testing information then it is likely that the DNS response was either handled by a transparently proxied DNS proxy server at the ISP or the response was otherwise modified by the ISP.

If the analysis module successfully verifies and decrypts the testing information it obtains the TTL value and timestamp contained therein. The analysis module compares the timestamp with the current time i.e. the time of the analysis and evaluates the TTL value to determine whether the DNS response is still valid. That is the analysis module evaluates whether the delta from the timestamp to the current time exceeds the TTL value. If the DNS response is invalid because the TTL is exceeded then it is likely that the ISP is transparently proxying DNS requests and caching DNS responses from authoritative servers for longer than it should. Otherwise if the response is valid i.e. the signature is verified the testing information is decrypted and the TTL is not exceeded then an embodiment of the analysis module concludes that the response is from the DNS server operated by the security server . The analysis can differ in other embodiments. For example in some embodiments the testing information is not signed and or encrypted and thus the response is valid if the TTL is not exceeded.

The network service selection module selects the network service that the security module uses to communicate with the security server . As mentioned above in one embodiment the selection module selects the DNS as the network service if it is available and otherwise uses another type of service. To this end the selection module receives the results of the analysis performed by the response analysis module and determines whether the DNS response was valid. If so the ISP is likely not blocking DNS traffic to external DNS servers and not operating its own DNS servers as transparent proxies. Therefore the selection module selects the DNS as the network service used for communications with the security server . If the DNS response was invalid the selection module selects an alternative network service for the communications such as HTTP.

In one embodiment the network service selection module uses the result of the ISP determination made by the network service initiation module to select the network service. The selection module stores which network service was previously selected for a given ISP and uses this network service next time the client connects to the network using that ISP. Thus the selection module can cache ISP network service associations and use the associated service when the client connects to the network using a given ISP.

In another embodiment the security module does not send an explicit test probe but rather treats each DNS query it sends to the DNS server operated by the security server as an implicit test probe. The security module initially selects DNS as the network service used for communications with the security server and the security module uses DNS to query for security information. The DNS server includes encrypted TTL and timestamp information in each response to the security modules of the clients . When the security module of the client receives a DNS response the security module decrypts and analyzes the TTL timestamp information to validate the DNS response. The security module continues to use DNS to query for security information unless it receives an invalid DNS response. If the security module receives an invalid response it switches to an alternative network service for the communications such as HTTP.

If the ISP is not recognized the security module generates a test probe and sends the probe to the security server via the DNS. For example the security module can hash a file stored on the client and send a DNS resolution request to hash.security server.com where hash is the hash of the file security server.com is a domain name of the security server and the DNS server operated by the security server is authoritative for such domain names. The security module analyzes the response to the probe if one is received to determine whether it is valid. If the DNS response is valid then the ISP likely does not block or transparently proxy DNS requests. Therefore an embodiment of the security module selects the DNS as the network service and uses DNS for subsequent communications with the security server . If the response is not received or is invalid then the ISP is likely blocking or using a transparent proxy for DNS requests. Accordingly an embodiment of the security module selects a different network service such as HTTP and uses the selected network service to communicate with the security server . The security module then performs actions such as generating a hash of a local file on the client sending the hash in a request for security information to the security server using the selected network service and receiving the security information from the security server in response to the request. The security module can use the security information to detect remediate and report malware at the client .

Some portions of above description describe the embodiments of the invention in terms of algorithms and symbolic representations of operations on information. These algorithmic descriptions and representations are commonly used by those skilled in the data processing arts to convey the substance of their work effectively to others skilled in the art. These operations while described functionally computationally or logically are understood to be implemented by computer programs or equivalent electrical circuits microcode or the like. Furthermore it has also proven convenient at times to refer to these arrangements of operations as modules without loss of generality. The described operations and their associated modules may be embodied in software firmware hardware or any combinations thereof.

As used herein any reference to one embodiment or an embodiment means that a particular element feature structure or characteristic described in connection with the embodiment is included in at least one embodiment. The appearances of the phrase in one embodiment in various places in the specification are not necessarily all referring to the same embodiment.

As used herein the terms comprises comprising includes including has having or any other variation thereof are intended to cover a non exclusive inclusion. For example a process method article or apparatus that comprises a list of elements is not necessarily limited to only those elements but may include other elements not expressly listed or inherent to such process method article or apparatus. Further unless expressly stated to the contrary or refers to an inclusive or and not to an exclusive or. For example a condition A or B is satisfied by any one of the following A is true or present and B is false or not present A is false or not present and B is true or present and both A and B are true or present .

In addition use of the a or an are employed to describe elements and components of the embodiments herein. This is done merely for convenience and to give a general sense of the invention. This description should be read to include one or at least one and the singular also includes the plural unless it is obvious that it is meant otherwise.

Upon reading this disclosure those of skill in the art will appreciate still additional alternative structural and functional designs for a system and a process for spam detection and analysis through the disclosed principles herein. Thus while particular embodiments and applications have been illustrated and described it is to be understood that the present invention is not limited to the precise construction and components disclosed herein and that various modifications changes and variations which will be apparent to those skilled in the art may be made in the arrangement operation and details of the method and apparatus of the present invention disclosed herein without departing from the spirit and scope of the invention as defined in the appended claims.

