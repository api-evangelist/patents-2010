---

title: Method and apparatus for mirroring frames to a remote diagnostic system
abstract: Apparatuses and methods to mirror frames received at an input port or provided by an output port to a port not connected to the device performing the mirroring operation. A frame being sent to a diagnostic system has a mirror header added to allow the frame to be routed through any intervening switches in the same fabric. The final switch or the diagnostic system removes the mirror header. If the diagnostic system is attached in a different fabric, encapsulation and inter-fabric routing headers are added as needed to the frame containing the mirror header. This allows the frame to traverse multiple fabrics to reach the diagnostic system. The encapsulation and inter-fabric routing headers are removed as done normally. This allows a diagnostic system to be connected to any switch in the network, either in the same or a different fabric.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08996720&OS=08996720&RS=08996720
owner: Brocade Communications Systems, Inc.
number: 08996720
owner_city: San Jose
owner_country: US
publication_date: 20100316
---
Embodiments according to the invention relate to a method and apparatus for frame mirroring in a network environment. More particularly embodiments according to the invention relate to mirroring frames to a diagnostic system not connected to the device performing the mirror operation.

Effectively deploying multiple devices in a network environment becomes an increasingly complex task as transmission data rates processor speeds and storage capacities increase. Storage area networks SANs have been developed as specialized high speed networks referred to as fabrics to connect computer systems control software and storage devices over the fabric. A SAN typically allows block level input output I O rather than file level access. Thus every device connected to a SAN fabric appears as a locally attached device to other devices on the fabric.

Data rates of the switches which form the SAN are currently very high such as 8 Gbps. At these rates diagnostics become very difficult. This makes simple trace capture inside the switch difficult as the needed memory could easily exceed that needed for normal switch operations. Protocol analyzers are readily available but their operation commonly requires that they be connected in series with the input or output port being tested. This makes connection of a conventional protocol analyzer troublesome in many instances. One approach that has been used to alleviate this problem is to mirror selected frames to a designated port connected to a diagnostic system. However this approach has been limited because of a requirement that the diagnostic system be directly connected to the switch performing the mirroring. In a practical sense this meant that the diagnostic system had to be connected to either the same switch as the frame source or the frame destination. While better than being required to be in series this direct connection requirement still limited the flexibility of the SAN configuration unduly requiring reconfiguration should the diagnostic system not be connected to one of the necessary switches assuming that the switches can perform the mirror approach.

One or more embodiments according to the invention relate to remote port mirroring which includes apparatuses and methods to mirror frames received at an input port or provided by an output port to a port not connected to the device performing the mirroring operation. A frame being sent to the diagnostic system has a mirror header added to allow the frame to be routed through any intervening switches in the same fabric to the diagnostic device. Either the final switch or the diagnostic system removes the mirror header and then the diagnostic system can analyze the mirrored frame as needed. If the diagnostic system is attached in a different fabric encapsulation and inter fabric routing headers are added as needed to the frame containing the mirror header. This allows the frame to traverse multiple fabrics to reach the diagnostic system. The encapsulation and inter fabric routing headers are removed as done normally leaving only the mirror header for routing in the final fabric. This allows a diagnostic system to be connected to any switch in the network either in the same or a different fabric.

Reference will now be made in detail to several embodiments of the invention examples of which are illustrated in the accompanying drawings. Reference in the specification to one embodiment or to an embodiment means that a particular feature structure or characteristic described in connection with the embodiments is included in at least one embodiment of the invention. The appearances of the phrase in one embodiment in various places in the specification are not necessarily all referring to the same embodiment. Wherever practicable the same reference numbers will be used throughout the drawings to refer to the same or like parts.

The switch ASIC has four basic modules port groups a frame data storage system a control subsystem and a system interface . The port groups perform the lowest level of packet transmission and reception. Generally frames are received from a media interface and provided to the frame data storage system by the port groups . Further frames are received from the frame data storage system and provided to the media interface for transmission out a port by the port groups . The frame data storage system includes a set of receive FIFOs and a set of transmit FIFOs which interface with the port groups and a frame memory which stores the received frames and frames to be transmitted. A loop back port is connected to the transmit FIFOs and receive FIFOs to allow frames to be processed in multiple passes. The frame data storage system provides initial portions of each frame typically the frame header and a payload header for FCP frames to the control subsystem . The control subsystem has router block frame editor block filter block and queuing block . The frame editor block examines the frame header and performs any necessary address translations such as those which will happen when a frame is mirrored as described herein. There can be various embodiments of the frame editor block with examples of translation operation provided in U.S. patent application Ser. No. 10 695 408 and U.S. Pat. No. 7 120 728 both of which are incorporated by reference. Those examples also provide examples of the control data path splitting of operations. The router block examines the frame header and selects the desired output port for the frame. The filter block examines the frame header and the payload header in some cases to determine if the frame should be transmitted. The queuing block schedules the frames for transmission based on various factors including quality of service priority and the like.

This is one embodiment for performing the required frame translations and routing to accomplish mirroring as described herein. Other embodiments and different architectures can be used.

As shown in port mirror APIs enable the switch to configure the port mirroring feature. These APIs are configured to associate and disassociate input and output ports to define an address for the diagnostic system to define frames of interest to be mirrored such as between a specific source and destination and to otherwise manage the port mirror operations.

In step the filter block detects the frame and forwards it to the transmit FIFO which in turn passes the frame to the loop back port . This causes the mirror frame to be rerouted back through the control subsystem . The loop back port modifies the FID value to indicate a second pass in step . In this second pass in step the router block routes the frame mirror to the proper port to reach the diagnostic system and places the routing instruction in the FID. In step the frame editor block adds an encapsulation ENC header and inter fabric routing IFR if the diagnostic system is in a different fabric from the switch . The IFR header is added in all cases and the ENC header is added if a backbone or intermediate fabric is present. For further understanding of inter fabric routing please refer to FC IFR the inter fabric routing standard from T11. The latest version is Revision 1.05 T11 09 354v1 dated Oct. 6 2009 and is available from the T11 website www.t11.org.

In step the mirror frame is provided from the TX FIFO to the proper port group and a copy is also placed in the TX FIFO to be provided to the loop back port . In step the loop back port strips the mirror header and the ENC and IFR headers if present and marks the FID to indicate a normal frame. This results in the original frame ready to be passed through the control subsystem . In this third pass in step the router block evaluates the original frame and directs it to the proper port by placing the routing value in the FID. In step the frame editor block adds any additional headers needed for inter fabric routing of the original frame such as the ENC and IFR headers. If no inter fabric routing is needed no headers are added. In step the original frame is then provided out of the switch to be provided to the destination.

In step the frame is provided from the TX FIFO to the loop back port to start a second pass. In step the frame editor block detects the frame as an output mirror frame by reviewing the FID and adds a mirror header. As the frame is marked as an outgoing mirror frame it is automatically provided through the TX FIFO to the loop back port . On the third pass in step the loop back port marks the FID to indicate this is the third pass. In step the router block routes the mirror frame. In step the frame editor block adds the ENC and IFR headers if needed to the mirror frame. In step the finished mirror frame is transmitted to the diagnostic system .

By providing a mirror header and any other headers necessary for inter fabric routing a diagnostic system can be located as desired in the fabric and not be required to be reconnected for each diagnostic test. This greatly simplifies performing diagnostics on a fabric.

While a Fibre Channel network has been used in the exemplary embodiments it is understood that other network protocols can be used according to the present invention. For example in an Ethernet and IP network Ethernet and IP mirror headers could be added to the frames being mirrored and routed similarly. As another example in an InfiniBand network an additional header could also be added that included the necessary routing information.

While the present invention has been described with respect to a limited number of embodiments those skilled in the art will appreciate numerous modifications and variations therefrom. It is intended that the appended claims cover all such modifications and variations as fall within the true spirit and scope of this present invention.

