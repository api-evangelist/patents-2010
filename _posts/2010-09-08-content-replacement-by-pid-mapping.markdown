---

title: Content replacement by PID mapping
abstract: A method of content substitution involves receiving an ordered stream of packets containing content marked by a first packet identifier (PID) and one or more substitute content portions marked by one or more secondary PIDs, where the number and placement of packets marked by secondary PIDs ahead of packets marked by the first PID in the stream is retained during transmission of the ordered stream of packets; the ordered stream of packets have an odd or even number of packets with the PIDs after a packet with a first PID; initiating processing for display or storage of content contained in packets having the first PID; initiating processing for display or storage of content contained in packets having a selected secondary PID that meets a substitution criterion; and either deleting or processing the content having the first PID depending upon a number of received intervening packets having secondary PIDs that reside between the packets having the first PID and the packets having the selected secondary PID that meets the substitution criterion, where deleting or processing is determined by whether the number of packets is an odd or an even number. This abstract is not to be considered limiting, since other embodiments may deviate from the features described in this abstract.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08453172&OS=08453172&RS=08453172
owner: Sony Electronics Inc.
number: 08453172
owner_city: Park Ridge
owner_country: US
publication_date: 20100908
---
This application is a continuation of U.S. patent application Ser. No. 12 283 377 filed Sep. 11 2008 now U.S. Pat. No. 7 882 517 which is a continuation of Ser. No. 10 319 066 filed Dec. 13 2002 now U.S. Pat. No. 7 765 567 which is a continuation in part of patent applications entitled Critical Packet Partial Encryption to Unger et al. Ser. No. 10 038 217 now U.S. Pat. No. 7 336 787 patent applications entitled Time Division Partial Encryption to Candelore et al. Ser. No. 10 038 032 now U.S. Pat. No. 7 139 398 entitled Elementary Stream Partial Encryption to Candelore Ser. No. 10 037 914 now U.S. Pat. No. 7 124 303 entitled Partial Encryption and PID Mapping to Unger et al. Ser. No. 10 037 499 now U.S. Pat. No. 7 151 831 and entitled Decoding and Decrypting of Partially Encrypted Information to Unger et al. Ser. No. 10 037 498 now U.S. Pat. No. 7 127 619 all of which were filed on Jan. 2 2002 and which is also related to and claims priority benefit of U.S. Provisional patent application Ser. No. 60 409 675 filed Sep. 9 2002 entitled Generic PID Remapping for Content Replacement to Candelore and this application is also related to and is a continuation in part of U.S. patent application Ser. No. 10 273 905 filed Oct. 18 2002 now U.S. Pat No. 7 376 233 to Candelore et al. entitled Video Slice and Active Region Based Dual Partial Encryption Ser. No. 10 273 903 filed Oct. 18 2002 now U.S. Pat. No. 7 302 059 to Candelore et al. entitled Star Pattern Partial Encryption Ser. No. 10 274 084 filed Oct. 18 2002 now U.S. Pat. No. 7 155 012 to Candelore et al. entitled Slice Mask and Moat Pattern Partial Encryption Ser. No. 10 274 019 filed Oct. 18 2002 now U.S. Pat. No. 7 292 690 to Candelore et al. entitled Video Scene Change Detection which are hereby incorporated by reference. Each of the above documents is hereby incorporated by reference herein.

A portion of the disclosure of this patent document contains material which is subject to copyright protection. The copyright owner has no objection to the facsimile reproduction of the patent document or the patent disclosure as it appears in the Patent and Trademark Office patent file or records but otherwise reserves all copyright rights whatsoever.

This invention relates generally to the field of video on digital video. More particularly this invention relates to a method and apparatus for providing selective replacement of digital video content.

Conventional digital video content such as MPEG video can take the form of a single program movie or other content with no opportunity for a service provider or a user to modify the viewing experience by selecting alternative content. Various mechanisms have been proposed for providing interactive content but usually such proposals have been expensive to implement can take up large amounts of bandwidth and may require expensive specialized equipment including servers and or other support equipment. Therefore although there is a demand for interactive applications which allow an end viewer of video content to tailor what they watch and manipulate the content no commercially viable system has yet appeared in the marketplace.

While this invention is susceptible of embodiment in many different forms there is shown in the drawings and will herein be described in detail specific embodiments with the understanding that the present disclosure is to be considered as an example of the principles of the invention and not intended to limit the invention to the specific embodiments shown and described. In the description below like reference numerals are used to describe the same similar or corresponding parts in the several views of the drawings.

The terms scramble and encrypt and variations thereof are used synonymously herein. The term video may be used herein to embrace not only true visual information but also in the conversational sense e.g. video tape recorder to embrace not only video signals but also associated audio and data. The present document generally uses the example of a dual selective encryption embodiment but those skilled in the art will recognize that the present invention can be utilized to realize multiple partial encryption without departing from the invention. The terms partial encryption and selective encryption are used synonymously herein. Also the terms program and television program and similar terms can be interpreted in the normal conversational sense as well as a meaning wherein the term means any segment of A V content that can be displayed on a television set or similar monitor device. The term legacy as used herein refers to existing technology used for existing cable and satellite systems. The exemplary embodiments disclosed herein are decoded by a television Set Top Box STB but it is contemplated that such technology will soon be incorporated within television receivers of all types whether housed in a separate enclosure alone or in conjunction with recording and or playback equipment or Conditional Access CA decryption module or within a television set itself. The present document generally uses the example of a dual partial encryption embodiment but those skilled in the art will recognize that the present invention can be utilized to realize multiple partial encryption without departing from the invention. The term package medium and similar terms as used herein are intended to embrace a recording medium such as a Digital Versatile Disc DVD Compact Disc CD or other magnetic optical or other recorded medium that is generally merchandised as a package that contains the electronic storage medium and is sold as a retail commodity as contrasted to an electronically downloadable data stream.

The above referenced commonly owned patent applications describe inventions relating to various aspects of methods generally referred to herein as partial encryption or selective encryption. More particularly systems are described wherein selected portions of a particular selection of digital content are encrypted using two or more encryption techniques while other portions of the content are left unencrypted. The encrypted portions are identified and distinguished from one another by use of multiple packet identifiers. By properly selecting the portions to be encrypted the content can effectively be encrypted for use under multiple decryption systems without the necessity of encryption of the entire selection of content. In some embodiments only a few percent of data overhead is needed to effectively encrypt the content using multiple encryption systems. This results in a cable or satellite system being able to utilize Set top boxes or other implementations of conditional access CA receivers from multiple manufacturers in a single system thus freeing the cable or satellite company to competitively shop for providers of Set top boxes.

The partial encryption processes described in the above patent applications utilize any suitable encryption method. However these encryption techniques are selectively applied to the data stream rather than encrypting the entire data stream using techniques described in the above referenced patent applications. In general but without the intent to be limiting the selective encryption process utilizes intelligent selection of information to encrypt so that the entire program does not have to undergo dual encryption. By appropriate selection of data to encrypt the program material can be effectively scrambled and hidden from those who desire to hack into the system and illegally recover commercial content without paying. MPEG or similar format data that are used to represent the audio and video data does so using a high degree of reliance on the redundancy of information from frame to frame. Certain data can be transmitted as anchor data representing chrominance and luminance data. That data is then often simply moved about the screen to generate subsequent frames by sending motion vectors that describe the movement of the block. Changes in the chrominance and luminance data are also encoded as changes rather than a recoding of absolute anchor data. Thus encryption of this anchor data for example or other key data can effectively render the video un viewable.

In accordance with certain embodiments consistent with the above inventions the selected video data to be encrypted may be any individual one or combination of the following described in greater detail in the above applications video slice headers appearing in an active region of a video frame data representing an active region of a video frame data in a star pattern within the video frame data representing scene changes I Frame packets packets containing motion vectors in a first P frame following an I Frame packets having an intra slice flag indicator set packets having an intra slice indicator set packets containing an intra coded macroblock data for a slice containing an intra coded macroblock data from a first macroblock following the video slice header packets containing video slice headers anchor data and P Frame data for progressively refreshed video data data arranged in vertical and or horizontal moat patterns on the video frame and any other selected data that renders the video and or audio difficult to utilize. Several such techniques as well as others are disclosed in the above referenced patent applications any of which or other techniques can be utilized with the present invention to encrypt only a portion of the content.

In order to distinguish between the two or more digital television signals encrypted using the multiple encryption algorithms in accordance with the above inventions multiple packet identifiers PIDs are utilized. Normally a single set of packet identifiers is used to identify a particular television program. When a television signal is encrypted under the multiple selective encryption arrangement described in the above referenced applications the clear content is assigned a first set of PIDs and each set of encrypted content is assigned another set of PIDs one set of encrypted content may share the same PID with the unencrypted content in certain embodiments . The receiving STB then remaps all of the appropriate content to a single PID for playback. This process is described in detail in the above patent applications.

The present invention utilizes multiple PIDs associated with a single item of content as a mechanism to provide content substitution. Content substitution can be used to provide an enhanced level of customization of television programming in any number of ways. For example content substitution can be used to provide targeted advertising to an audience by substitution of one advertisement for another. Content substitution can also be used to provide multiple endings plots or other segments for a program or to provide multiple views in a sportscast or other program. Other applications for the content substitution of the present invention will be discussed during the course of this discussion. Each of these applications as well as others can be facilitated using the present invention without need for dramatic increases in bandwidth and at reasonable cost for the hardware.

Referring now to an overall content substitution process consistent with certain embodiments of the present invention is shown starting at . The content is received at having portions identified by multiple PIDs e.g. PID A and PID B in this example which represent multiple possibilities for the content e.g. multiple advertisements logos plots endings characters etc. . This content could be received as a stream of content as in a cable or satellite television transmission or could be present in packaged media or a downloaded file. In any case at a processing operation such as playback or transmission of the content is initiated generally using a main portion of the content designated with a particular packet identifier e.g. PID A . At the content is examined to determine if a prescribed substitution criterion has been met. Such criterion might be for example presence of a national advertisement watermark or logo that a local content distributor wishes to replace with a local or regional advertisement watermark or logo or such criterion might entail selection by an end user of a particular plot character or ending.

If the criterion is not met at the processing of the main content PID A continues at . If the criterion is met at a content substitution is carried out at e.g. by substitution of content with PID B for content with PID A or by carrying out any of the other content substitution operations described herein including but not limited to one for one substitution one for one insertion or multiple for one insertion deletion . Such substitution may entail a remapping of the PID values so that a decoder or other processor merely continues processing content with the same PID. Alternately a decoder can be programmed to select the substituted content when present in preference to the main content. From or control passes to where the content is examined to determine if the end has been reached. If not control returns to processing content at . If the end is reached the process stops at .

Thus a method of content substitution consistent with certain embodiments of the present invention involve receiving data representing content the data having at least first and second packet identifiers PIDs associated with first and second portions of content playing content having the first PID determining that a substitution criterion has been met and substituting content having the second PID for content having the first PID.

In accordance with this process for example a local cable operator can receive a program that contains multiple sets of advertisements commercials . Depending on the geographic location of the local operator the main content can be retransmitted along with an appropriate one of several regional advertisements that are more appropriate to the geographic location or marketplace of the local cable operator. In another example a movie with multiple selectable endings can be broadcast from a cable operator to its subscribers. The subscriber can then decide before or during the viewing of the movie which ending is preferred and make a selection. The subscriber sends a command to the STB which selects the alternative ending desired by the subscriber by selecting the ending associated with a particular PID and remapping that PID to the main program s PID. Numerous other examples will occur to those skilled in the art upon consideration of the present teachings.

Referring now to an exemplary cable system is depicted as . In this system a satellite antenna receives a multiplexed stream of content from a satellite transmission such as a HITS Headend In The Sky feed. The received stream of content is received demodulated and decrypted at a satellite receiver and the content that is to have substitutable information is passed along to a PID mapper and flag inserter the function of which will become clear in view of discussions to follow. Additional content may be retrieved from a local content database or other sources of content. Alternatively the content with multiple PID encoded substitutable portions may be directly received from the satellite system. The PID mapper and flag inserter maps the incoming content from whatever source to a set of main PIDs for the main content and a set of secondary or shadow PIDs for the substitutable content at in one embodiment. In another embodiment where the incoming data already has multiple PID encoded content the PID mapper may be instructed to remap the PIDs to select only the desired content. Flags may be inserted into the content at to identify a location where a substitution of content is to start and end.

The content then passes to a PSI PMT inserter that inserts Program Specific Information PSI and Program Map Tables PMT into the stream of content for use by the decoding side in decoding the programming. If the content is to be encrypted it may be passed through an encrypter prior to modulation at a modulator such as a QAM modulator . The modulated stream of content is then transmitted via the cable plant to the end users with decoder boxes such as Set top boxes and . The operation of the cable head end including but not limited to the PID mapping for content substitution is carried out under control of a control computer .

Such a system can be used to form a content substitution encoder consistent with certain embodiments of the invention in which input data is received representing main content and representing substitution content. A packet identifier PID mapper assigns a primary PID to the main content and assigns a secondary PID to the substitution content. A private data generator generates user private data that identifies the main content by the primary PID and substitution content by the secondary PID. The private data the main content mapped to the primary PID and the substitution content mapped to the secondary PID are then assembled into a data stream.

The process of can be carried out on any suitable programmed general purpose computer operating as control computer of . Computer has one or more central processor units CPU with one or more associated buses used to connect the central processor unit to Random Access Memory and Non Volatile Memory in a known manner. Output devices such as a display and printer are provided in order to display and or print output for the use of the MSO multiple service operator as well as to provide a user interface such as a Graphical User Interface GUI . Similarly input devices such as keyboard mouse and removable media readers may be provided for the input of information by the operator. Computer also incorporates internal and or external attached disc or other mass storage e.g. disc and or optical storage for storing large amounts of information including but not limited to the operating system and the content substitution process program as well as content which is most likely stored on massive attached storage such as local content database . The Computer system also has an interface for connection to the controlled devices in the cable system head end. While depicted as a single computer the digital content provider may utilize multiple linked computers to carry out the functions described herein.

The description above largely assumes that the substitutable content is to be inserted at the cable system head end but those skilled in the art will appreciate that the present content substitution concept can be implemented in many ways to permit content substitution at multiple levels to serve multiple purposes. For example if the cable customer is viewing an interactive television show the customer s selections e.g. from a remote controller can be used to establish the criterion for selection of a particular substitution e.g. ending selection . However the cable head end can also implement a content substitution in accord with certain embodiments consistent with the present invention for example by substitution of a local advertisement for a national advertisement or substitution of or addition of a local channel logo for a national logo.

Consider now an exemplary embodiment consistent with the present invention in which a content provider wishes to provide alternative advertisements to several groups of customers for example in a cable television system. In this example assume that the cable television customers can be divided into three categories based upon for example a customer profile stored at the cable system s head end. Now with reference to an exemplary television program with three separate advertisements and associated therewith is depicted. In order to segregate the three advertisements three separate sets of PIDs are utilized for simplicity assume that there is one PID per advertisement . In the case of the main advertisement directed to one viewing audience the advertisement can share the same PID e.g. with the program content.

The first alternative advertisement is identified by an alternative PID e.g. PID and the second alternative advertisement is identified by another alternative PID e.g. PID . Thus in order to present the main advertisement no special instructions need to be conveyed to the decoder e.g. the television STB since it is shared with the program content and will be shown by default. For decoders that are to decode the alternative advertisement an instruction is sent from the cable system head end to the decoders instructing them to substitute content with PID whenever this PID is encountered for PID . Similarly for decoders that are to decode the alternative advertisement an instruction is sent from the cable system head end to the decoders instructing them to substitute content with PID whenever this PID is encountered in place of PID . In one embodiment each packed of video data having PID has a corresponding packet with PID and PID . In other embodiments a one for one correlation is not required. In any event packet counts should be maintained in a manner that permits the proper ordered processing of packets at the decoder.

In this example the content is displayed side by side to illustrate the direct substitution that is the nature of the process. However as depicted in the content may be arranged as a sequence of packets which systematically present the main content followed by the first alternative content and then the second alternative content and then the sequence repeats. In various embodiments corresponding packets with primary and secondary PIDs may appear in order of primary followed by secondary or secondary followed by primary. Alternation of the packets avoids unnecessary delays in packet receipt and helps preserve the order of packets. Where a one for one correlation between primary and secondary packets exists each of the primary and secondary packets may retain a packet number that is used to establish the order of presentation. Such numbering may be altered by the decoding process to retain order in the received content. Other embodiments are also possible without deviating from the present invention.

In addition to providing targeted advertisement for sets of customers by the cable system MSO a similar technique can be implemented to provide networks with the ability to provide regional advertisement by embedding for example multiple regional advertisements into a single data stream and using a remapping of the PIDs at the local networks or cable operators to select the appropriate advertisement for a given region. Thus the three advertisements depicted in could equally well represent three regional advertisements such as one for the East coast of the U.S. one for the central portion of the U.S. and one for the West coast of the U.S. or any other suitable regional segregation with more or less alternative advertisements.

With reference to a program using a particular PID e.g. PID contains a blank section having PID with an alternative portion of information serving as a marker PID .

The content substitution using alternative PIDs as described above can be utilized for any number of purposes. depicts replacement of advertising banners and supplementation of logos or watermarks using the content substitution technique of the present invention. In this embodiment a segment of main content is depicted as a television screen divided into horizontal slices as such information would be encoded using MPEG digital coding. A first advertisement e.g. a national advertisement is depicted as appearing in several sequential slices of the image near the upper left of the screen. A logo or watermark appears in one slice near the bottom right of the image . Using content substitution a new screen can be created. Packets containing the advertisement can be replaced by packets containing a local or other alternative advertisement banner . Similarly the watermark could be replaced or supplemented by use of content substitution for certain packets within a slice of the video image. In this example a network logo might be supplemented by another logo such as a local channel or other logo by substitution of packets bearing the supplemental logo.

These are but a few examples of the types of content manipulation that can be facilitated using the PID mapping techniques of the present invention. Several other examples are listed in the table below but many more will occur to those skilled in the art upon consideration of the present discussion 

Turning now to a state diagram is shown which depicts one mechanism for implementing a decoder that decodes the transport stream with multiple PIDs consistent with certain embodiments of the present invention. The numbered paths of the state diagram are explained in the table below 

The replacement of the primary PID packet by the secondary PID packet is called Substitution Mode . Secondary PID packets may be inserted into the stream without replacement of a primary PID packet. This mode is called Insertion Mode. In fact the decoder may be used in a mode wherein both operations are active at the same time. This is called Insertion and Deletion Mode . All three discrete decoder modes are mutually exclusive and follow a series of state transitions that are specific to each mode. The active mode is signaled through the decoder specific variable mode. If the value of mode is set to zero decoding is not enabled and the transport decoder state machine is bypassed. If the value of mode is invalid not a specifically defined state then the same actions are taken as if mode was set to zero i.e. the transport decoder state machine is bypassed. The definition of the state transitions for each mode is detailed as followed.

The algorithm for decoding an encoded transport stream is embodied in the state machine of . The Petri net showing the states and the state equations actions can be derived from in combination with the above state table. The algorithm has four operating states with the system predominantly remaining is state . State is entered only when a packet containing a shadow PID not the main PID has been encountered. Depending upon the system mode as established through messaging in the PSI from the headend different paths to two entirely different second states can be taken.

The state machine can be implemented in either hardware or software depending upon the IC manufacturer s device architecture. A software implementation on a programmed processor can generally be expected to provide more flexibility in the design.

One error case identified illegal state transition . This error is a unique error that is in addition to MPEG transport layer errors like continuity count transport error etc. Error IRQn is the detection of two adjacent shadow packets without an intervening legacy packet with n representing the number of the specific decoder. Depending upon the setting of the decoder specific variable queue on error two different operations can occur. If the variable is set to true the decoder will process the second shadow packet PID B as in the non error case. If the variable is set to false the second shadow packet is discarded.

Whenever packets are inserted or deleted the continuity count CC of the primary stream PID A will be preserved by adjusting the CC as appropriate. The decode RSTn variable is a non latching bit that can be set through a configuration register or accessed by other functions to force the decoder state machine n to a known state.

One mode of operation of the decoder transport processing algorithm is referred to as the Substitution Mode. This mode is illustrated in wherein packets having PID B such as and are inserted into the transport stream by replacement of PID B with PID A to produce packets and for an MPEG compliant transport stream with the desired content packets containing a PID field matching A where A is a 13 bit value previously defined in a configuration register of the decoder. A no operation is carried out for PID A packets. In the home state state A packets such as become packets such as are sent to the transport filter output queue for further processing such as A V decompression and display. In mode the decoder state machine transitions from state to state A upon reception of a MPEG packet with the PID field matching B after receipt of a substitution flag . B is a 13 bit value previously defined in a configuration register of the decoder. B represents the secondary or shadow packet to be substituted for the next occurring legacy packet with PID matching A. The PID value of the B packet is changed to A before insertion into the stream. The substitution occurs because upon transition to state A the B packet content is sent to the transport filter output queue.

The return to state occurs when the next A PID is received. In this case it is not queued and is converted to the NULL 0x1fff PID value effectively erasing it from the stream without altering the overall stream timing as would have occurred if it were physically removed. The return to state can also be signaled by receipt of another substitution flag indicating termination of the substitute mode.

Another mode of operation of the decoder transport processing algorithm is referred to as the Insertion Mode which is depicted in for an MPEG compliant transport stream with the desired content packets containing a PID field matching A where A is a 13 bit value previously defined in a configuration register of the decoder. In the home state state A packets are sent to the transport filter output queue for further processing such as A V decompression and display. In mode the decoder state machine never transitions from state . Upon reception of a MPEG packet with the PID field matching B where B is a 13 bit value previously defined in a configuration register of the decoder B represents the secondary or shadow packet to be inserted into the stream with the PID value changed to A. In this mode transition from state to state B can occur due to receipt of an insertion flag . PID B packets such as and are inserted into the transport stream as PID A packets such as and . The insertion mode can terminate by receipt of the next insertion flag .

The decoder transport processing algorithm for the Insertion Deletion Mode for a MPEG compliant transport stream with the desired content packets containing a PID field matching A where A is a 13 bit value previously defined in a configuration register of the decoder is depicted in . In the home state state A packets such as are sent to the transport filter output queue for further processing such as A V decompression and display and become packets . In mode the decoder state machine transitions from state to state B upon reception of a MPEG packet with the PID field matching B where B is a 13 bit value previously defined in a configuration register of the decoder B represents the secondary or shadow packet to be inserted with PID changed to match A. Any packet received while in state B with the PID value matching A will result in a transition to state and the packet PID changed to NULL effectively removing it from the transport stream. All subsequent packets received with PID matching A while in state will result in their PID value also being changed to NULL such as packets and which become NULL as and . Transition to and from state can be initiated and terminated by an insertion deletion flag and respectively. While in state packets such as and with PID B are converted to packets with PID such as and .

The return to state B occurs when the next packet with a B PID value is received and it is queued and converted to the A PID value. Likewise return to the return to state from state B occurs when the next packet with a B PID value is received accordingly it is also queued and converted to the A PID value.

The method according to claim wherein the substituting comprises using private signaling to select a unit of content with the second PID and discarding a unit of content with the first PID.

In methods consistent with the present invention private signaling can be used to select a unit of content on the secondary PID while receiving content with the primary PID. Alternatively private signaling can be used to select multiple units of content with the secondary PID while discarding units of content with the primary PID. Similarly private signaling can be used to select multiple units of content with a secondary PID while receiving units of content with the primary PID. Also private signaling can be used to switch from a mode of selecting multiple units of content with the secondary PID while discarding units of content with the primary PID to a mode of selecting multiple units of content with the secondary PID while receiving content with the primary PID. Private signaling can also be used to switch from a mode of selecting multiple units of content with the secondary PID and receiving multiple units of content with the primary PID to a mode of selecting multiple units of content with the secondary PID while discarding units of content with the primary PID.

A unit of content with the secondary PID is sent before or after a corresponding unit of content with the primary PID. Substitution operations can be initiated and terminated by private signaling forming part of an adaptation layer of packets in a data stream. The adaptation layer can be in a packet with the secondary PID the primary PID or another PID.

For reference the following two tables are provided which call out the syntax used for an MPEG transport packet and an MPEG transport stream adaptation field respectively 

Much of the information used to configure and control the decoder module comes from the MPEG PSI data contained in the transport stream and decoded by the STB middleware. Configuration and control can be achieved using extensions to the MPEG PSI specification specific to the current decoder when needed. In certain embodiments consistent with the present invention the following table defines the extensions used and the private data syntax.

It may be possible to use adaptation and no payload as well as adaptation with payload to signal transition between states. Adaptation field only packets whether A B or C can be made null e.g. NOP or can simply be left in the stream.

In this document references to registers which may imply a hardware implementation can be freely interchanged with variable in a software or microcoded implementation. In either case a common decoder module command control structure and interface is desirable to achieve middleware compatibility across STB platforms of varying architecture and capability.

In certain preferred implementations each decoder module contains 19 registers or variables . Unless otherwise stated all registers are read write meaning that the current value can be read back through the same interface used to write. All registers will be sequentially offset from a common base value origin . The addresses in this specification are all relative to the base offset values . The registers can be mapped as shown in the table below 

Status registers are provided in accordance with the following table Interrupt Source Register Read Only Address 0x00 

If an interrupt is invoked the associated bit will be set to 1 . More than one bit may asserted simultaneously. If any bit is set the decoder interrupts the host controller based upon the value of the mask register. The contents of the source register is bitwise ANDed with the mask register and the result logically ORed to form a single IRQ output. Interrupt Conditions are tabulated as follows

A write only Interrupt Mask Register is at Address 0x00. When an Interrupt Mask Register bit is 1 the associated interrupt is unmasked and when 0 it is masked. Masked interrupts will not generate an interrupt output to the host processor. The interrupt flag bit s of masked interrupts will still be valid in the interrupt register. The default power up condition is for all interrupts to be masked all 0 s .

A primary PID register for Decoder 1 Read Write appears at Address 0x01 and is configured as follows.

A secondary PID register Secondary PID Register for decoder 1 Read Write appears at Address 0x02 and is configured as follows 

The Secondary PID is a 13 bit value stored right justified as a big endian MSB in bit value as shown above.

A primary PID register for Decoder 2 Read Write appears at Address 0x03 and is configured as follows 

A secondary PID register for decoder 2 Read Write appears at Address 0x04 and is configured as follows 

A primary PID register for decoder 3 Read Write appears at Address 0x05 and is configured as follows 

A secondary PID register for decoder 3 Read Write appears at Address 0x06 and is configured as follows 

A primary PID register for decoder 4 Read Write appears at Address 0x07 and is configured as follows 

A secondary PID register for decoder 4 Read Write appears at Address 0x08 and is configured as follows 

A primary PID register for decoder 5 Read Write appears at Address 0x09 and is configured as follows 

A secondary PID register for decoder 5 Read Write appears at Address 0x0A and is configured as follows 

A primary PID register for decoder 6 Read Write appears at Address 0x0B and is configured as follows 

A secondary PID register for decoder 6 Read Write appears at Address 0x0C and is configured as follows 

There is one error case identified illegal state transition . This error is a unique error and is in addition to MPEG transport layer errors like continuity count transport error etc. Error IRQn is the detection of two adjacent shadow packets without an intervening legacy packet with n representing the number of the specific decoder. Depending upon the setting of the decoder specific variable queue on error two different operations can occur. If the variable is set to true the decoder will process the second shadow packet PID B as in the non error case. If the variable is set to false the second shadow packet is discarded.

In some instances content that is to be replaced is placed on packet boundaries. Since some information may not fit neatly within the boundaries of a packet some additional content which is not specifically the content of interest may need to be duplicated to fill up the packet. In other cases the packet can simply be filled with null bytes e.g. all zeros . A typical video slice contains approximately 3 to 8 packets depending upon how much intra coded data is present. It is noted that some decoders may have difficulty with multiple slices on a single video line even though the MPEG2 specification allows for this.

It is also noted that there may be ending problems encountered if the substituted content is referenced from future frames. However this can be resolved by establishing a rule that says that the substituted content cannot be referenced by past frames. This is due to the possibility that the content may be different depending upon the choice made by a customer or the set top box. Reference to future frames might be allowed if the reference is all contained within the substitute content. Also since the encoder uses a specified set of quantization tables substitute content should be processed using the same quantization table so that correct decoding can take place.

The present content substitution can be carried out either on line or off line depending upon the application without limitation.

A decoder such as the above can be incorporated within a television STB or other television receiver and can be used to provide the end user with content substitution capabilities controlled either by the user or by the MSO. Referring now to an exemplary system configuration for a digital television Set top box is illustrated. Many configurations for such a STB are possible and the STB illustrated should only be considered as exemplary of such a STB configuration. In this exemplary set top box the transmission medium such as a coaxial cable is coupled by a suitable interface to a tuner . Tuner may for example include a broadcast in band tuner for receiving video content. A separate tuner not shown may be provided to receive conventional RF broadcast television channels. Modulated information formatted for example as MPEG 2 information is then demodulated at a demodulator . The demodulated information at the output of demodulator is provided to a PID decoder demultiplexer descrambler circuit where the information is separated into discrete channels of programming. The programming is divided into packets each packet having a PID that identifies the packet as containing a particular type of data e.g. audio video data relating to a particular program. The PID decoder demodulator descrambler circuit also decrypts encrypted information in accordance with a decryption algorithm to prevent unauthorized access to programming content for example. The PID decoder portion of can operate in a manner similar to that of the decoder described by the stated diagram of under program control to select content having a particular PID as will be described later.

Audio packets from the demultiplexer those identified with an audio PID are decrypted and forwarded to an audio decoder where they may be converted to analog audio to drive a speaker system e.g. stereo or home theater multiple channel audio systems or other audio system e.g. stereo or home theater multiple channel amplifier and speaker systems or may simply provide decoded audio out at . Video packets from the demultiplexer those identified with a video PID are decrypted and forwarded to a video decoder . In a similar manner data packets from the demultiplexer those identified with a data PID are decrypted and forwarded to a data decoder .

Decoded data packets from data decoder are sent to the set top box s computer system via the system bus . A control computer can thus access the decoded data from data decoder via the system bus as well as programs and data in memory . Video data decoded by video decoder is passed to a graphics processor which is a computer optimized to processes graphics information rapidly. Graphics processor is particularly useful in processing graphics intensive data associated with Internet browsing gaming and multimedia applications such as those associated with MHEG Multimedia and Hypermedia information coding Experts Group set top box applications. It should be noted however that the function of graphics processor may be unnecessary in some set top box designs having lower capabilities and the function of the graphics processor may be handled by the control computer in some applications where the decoded video is passed directly from the demultiplexer to a video encoder. Graphics processor is also coupled to the system bus and operates under the control of control computer .

Many set top boxes such as STB may incorporate a smart card reader for communicating with a so called smart card often serving as a Conditional Access Module CAM . The CAM typically includes a central processor unit of its own along with associated RAM and ROM memory. Such smart card based CAMs are conventionally utilized for authentication of the user and authentication of transactions carried out by the user as well as authorization of services and storage of authorized cryptography keys. For example the CAM can be used to provide the key for decoding incoming cryptographic data for content that the CAM determines the user is authorized to receive.

STB can operate in a bidirectional communication mode so that data and other information can be transmitted not only from the system s head end to the end user or from a service provider to the end user of the STB but also from the end user upstream using an out of band channel. In one embodiment such data passes through the system bus to a modulator through a diplexer forming part of tuner and out through the transmission medium . This capability is used to provide a mechanism for the STB and or its user to send information to the head end e.g. service requests or changes registration information etc. as well as to provide fast outbound communication with the Internet or other services provided at the head end to the end user.

Set top box may include any of a plurality of I O Input Output interfaces represented by I O interfaces that permit interconnection of I O devices to the set top box . By way of example and not limitation a serial RS 232 port can be provided to enable interconnection to any suitable serial device supported by the STB s internal software. Similarly communication with appropriately compatible devices can be provided via an Ethernet port a USB Universal Serial Bus port an IEEE 1394 so called Firewire or i link or IEEE 1394 wide port or S video port. An infrared interface provides communication with a remote controller . Such interfaces can be utilized to interconnect the STB with any of a variety of accessory devices such as storage devices audio visual devices gaming devices not shown Internet Appliances etc.

I O interfaces can also include a modem be it dial up cable DSL or other technology modem having a modem port to facilitate high speed or alternative access to the Internet or other data communication functions. In one preferred embodiment modem port is that of a DOCSIS Data Over Cable System Interface Specification cable modem to facilitate high speed network access over a cable system and port is appropriately coupled to the transmission medium embodied as a coaxial cable. Thus the STB can carry out bidirectional communication via the DOCSIS cable modem with the STB being identified by a unique IP address. The DOCSIS specification is publicly available.

A PS 2 or other keyboard mouse joystick interface can be provided to permit ease of data entry to the STB . Such inputs provide the user with the ability to easily enter data and or navigate using pointing devices. Pointing devices such as a mouse or joystick may be used in gaming applications.

Of course STB also may incorporate basic video outputs that can be used for direct connection to a television set instead of or in addition to an IEEE 1394 connection. In one embodiment the video output can provide composite video formatted as NTSC National Television System Committee video. In some embodiments the video output can be provided by a direct connection to the graphics processor or the demultiplexer descrambler rather than passing through the system bus as illustrated in the exemplary block diagram. S Video signals can be similarly provided without passing through the system bus if desired in other embodiments.

The infrared interface receives commands from an infrared remote control infrared keyboard or other infrared control device. Although not explicitly shown front panel controls may be used in some embodiments to directly control the operation of the STB through a front panel control interface as one of the provided interfaces. Selected interfaces such as those described above and others can be provided in STB in various combinations as required or desired.

In one illustrative embodiment consistent with the present invention the STB can be utilized to control multiple content as in for example selection from multiple endings. In one such scenario the main program content having a designated set of PIDS is played out in a normal manner until near the end of the program. At this point the viewer is presented with a menu selection on screen from which one of a plurality of endings is presented. As a simple example there may be three possible endings associated with three sets of PIDs as follows 1 PID A Boy gets girl good guys win 2 PID B Girl dies good guys win and 3 PID C Girl dies bad guys win.

Using the remote controller or any other suitable input mechanism the viewer selects from the possible endings. A limited time may be provided to make this selection prior to a default ending being shown e.g. a two minute pause in content to allow the selection of the ending . In response to the user s selection control computer programs PID decoder to select the ending chosen by the user. After this pause is completed the programming continues with the PID decoder making the appropriate PID remapping to cause the audio data and video for the selected ending to be played. Thus if the program is normally associated with PID A and the user selects ending three packets bearing PID C will be remapped to PID A for playback. Thus in this embodiment the user can make selections for playback of a particular segment of content that is substituted for the normal content.

Accordingly a decoder consistent with certain embodiments of the present invention has a receiver receiving data that represents content the data having at least first and second packet identifiers PIDs associated with first and second portions of content. A content decoder is configured to play content having the first PID. A controller determines that a substitution criterion has been met and a PID mapper maps content having the second PID to the first PID so that the content originally having the second PID is played.

Thus a method and apparatus for content substitution consistent with certain embodiments of the present invention involves receiving data representing content the data having at least first and second packet identifiers PIDs associated with first and second portions of content. The content having the first PID is placed into a data stream. An initiation flag is received indicating initiation of a PID mapping operation. The content having the second PID is then mapped to the first PID and the mapped content is placed into the data stream. A termination flag is received indicating termination of the PID mapping operation at which point the process returns to placing content having the first PID into the data stream. The content substitution process can be used to replace advertisements provide multiple plots multiple endings multiple views as well as other applications.

In certain implementations a method of content substitution involves receiving an ordered stream of packets containing content marked by a first packet identifier PID and one or more substitute content portions marked by one or more secondary PIDs where the number and placement of packets marked by secondary PIDs ahead of packets marked by the first PID in the stream is retained during transmission of the ordered stream of packets initiating processing for display or storage of content contained in packets having the first PID initiating processing for display or storage of content contained in packets having a selected secondary PID that meets a substitution criterion and either deleting or processing the content having the first PID depending upon a number of received intervening packets having secondary PIDs that reside between the packets having the first PID and the packets having the selected secondary PID that meets the substitution criterion.

In certain embodiments the content comprises one of streamed data a data file and a packaged medium containing a data file. In certain embodiments the method is carried out in a decoder forming a part of a television Set top box. In certain embodiments the method is carried out in at least one of a hardware state machine and a programmed processor. In certain embodiments the substitution criterion is met as a result of an interactive operator input from an operator viewing said content. In certain embodiments the content comprises at least one of audio and video content. In certain embodiments the substitution criterion is met as a result of at least one of an operator input signaling in a program map table PMT and signaling in an MPEG adaptation layer. In certain embodiments the content is substituted on a packet for packet basis. In certain embodiments multiple packets of content are substituted for a single packet. In certain embodiments the processing comprises playing the content. In certain embodiments the substituting comprises selecting a unit of content with the second PID and discarding a unit of content with the first PID. In certain embodiments the substituting comprises selecting a unit of content on the second PID while receiving content with the first PID. In certain embodiments the substituting comprises selecting multiple units of content with the second PID while discarding units of content with the first PID. In certain embodiments the substituting comprises selecting multiple units of content with a second PID while receiving units of content with the first PID. In certain embodiments the substituting comprises switching from a mode of selecting multiple units of content with the second PID while discarding units of content with the first PID to a mode of selecting multiple units of content with the second PID while receiving content with the first PID. In certain embodiments the substituting comprises switching from a mode of selecting multiple units of content with the second PID and receiving multiple units of content with the first PID to a mode of selecting multiple units of content with the second PID while discarding units of content with the first PID. In certain embodiments a unit of content with the second PID is sent before a corresponding unit of content with the first PID. In certain embodiments a unit of content with the second PID is sent after a corresponding unit of content with the first PID. In certain embodiments substitution is initiated and terminated by private signaling forming part of an adaptation layer of packets in a data stream. In certain embodiments the adaptation layer is in a packet with the second PID. In certain embodiments the adaptation layer is in a packet with the first PID. In certain embodiments the adaptation layer is in a packet that is neither the second nor the first PID. In certain embodiments the processing comprises playing back the content. A computer readable medium can be used for storing instructions which when executed on a programmed processor carry out any of the above content substitution methods.

Another method of triggering content substitution involves receiving an ordered stream of packets containing content marked by a first packet identifier PID and substitute content marked by a secondary PID and where the number and placement of packets marked by secondary PIDs ahead of packets marked by the first PID in the stream is retained during transmission of the ordered stream of packets determining if a number of intervening packets having secondary PIDs that reside between the packets having the first PID and the packets having a selected secondary PID is an odd number or an even number if the number is a first of either an odd number or an even number of intervening packets having secondary PIDs that reside between the packets having the first PID and the packets having the selected secondary PID is received interpreting receipt of said number of intervening packets as an instruction that triggers ignoring subsequent packets marked with a primary PID and mapping the portions of the content having the secondary PIDs to the primary PID and placing the mapped content into the data stream as a substitute for the first portion of the content if the number is the other of either an even number or an odd number of intervening packets having secondary PIDs that reside between the packets having the first PID and the packets having the selected secondary PID is received interpreting receipt of said number of intervening packets as an instruction that triggers processing subsequent packets marked with the primary PID.

In certain embodiments the method can be carried out in a decoder forming a part of a television set top box. In certain embodiments the method can be carried out in at least one of a hardware state machine and a programmed processor. In certain embodiments receipt of the initiation flag is indicative of meeting a substitution criterion such substitution criteria being met as a result of an interactive operator input from an operator viewing said content. In certain embodiments receipt of the initiation flag is indicative of meeting a substitution criterion. In certain embodiments the substitution criterion is met as a result of an operator input. In certain embodiments the content is substituted on a packet for packet basis. In certain embodiments multiple packets of content are substituted for a single packet. In certain embodiments the substituting comprises using private signaling to select a unit of content with the secondary PID and discarding a unit of content with the primary PID. In certain embodiments a unit of content with the second PID is sent before a corresponding unit of content with the first PID. In certain embodiments a unit of content with the second PID is sent after a corresponding unit of content with the first PID. In certain embodiments substitution is initiated and terminated by private signaling forming part of the adaptation layer of packets in a data stream. In certain embodiments the adaptation layer is in a packet with the one of the primary PID and the secondary PID. In certain embodiments the adaptation layer is in a packet that has neither the secondary nor the primary PID. A computer readable medium storing instructions which when executed on a programmed processor can carry out any of the content substitution methods above.

A content multiplexer which creates an ordered stream of packets with primary and substitute content has a circuit for receiving input data representing main content. Input data representing substitution content are received such substitution content being for replacement of at least a portion of the main content. A packet identifier PID mapper assigns a primary PID to the main content and assigns a secondary PID to the substitution content. A multiplexer multiplexes an even or odd number of packets with the secondary PID ahead of packets with the primary PID depending on whether the primary packets are to be ignored or processed by a receiving device. The content multiplexer can be implemented using a programmed computer.

A decoder consistent with certain embodiments has a receiver receiving an ordered stream of data that represents content ordered in a first and a second substitutable portion the data encoded using at least first and second packet identifiers PIDs associated with first and second substitutable portions of content. The receiver receives an odd or even number of packets with the PIDs after a packet with a primary PID wherein starting or stopping content substitution is determined by whether the number of packets is an odd or an even number. A content decoder is configured to play content having the first PID. A controller determines that a substitution criterion has been met by virtue of receipt of the content having the secondary PID. A PID mapper maps content from the received data content having the second PID to the received data content having the first PID so that the received data content originally having the second PID is played.

In certain embodiments the decoder resides in a television set top box. In certain embodiments the substitution criterion comprises an interactive user selection to play the second portion. In certain embodiments the second portion of content represents one of an alternative advertisement an alternative view an alternative ending and an alternative plot.

Those skilled in the art will recognize that the present invention has been described in terms of exemplary embodiments based upon use of a programmed processor e.g. computer . However the invention should not be so limited since the present invention could be implemented using hardware component equivalents such as special purpose hardware and or dedicated processors that are equivalents to the invention as described and claimed. Similarly general purpose computers microprocessor based computers micro controllers optical computers analog computers dedicated processors and or dedicated hard wired logic may be used to construct alternative equivalent embodiments of the present invention. Moreover although the present invention has been described in terms of a general purpose personal computer providing a playback mechanism the playback can be carried on a dedicated machine without departing from the present invention. Conversely the present decoder has been described in terms of a state machine and such state machine can be implemented as either a hardware or software based state machine. Moreover those skilled in the art will understand that the exact register configurations PID protocols and other details described in connection with the above exemplary embodiment should not be considered limiting but are presented by way of illustration.

Those skilled in the art will appreciate that the program steps and associated data used to implement the embodiments described above can be implemented using disc storage as well as other forms of storage such as for example Read Only Memory ROM devices Random Access Memory RAM devices optical storage elements magnetic storage elements magneto optical storage elements flash memory core memory and or other equivalent storage technologies without departing from the present invention. Such alternative storage devices should be considered equivalents.

The present invention as described in embodiments herein is implemented using a programmed processor executing programming instructions that are broadly described above form that can be stored on any suitable electronic storage medium or otherwise be present in any computer readable medium. However those skilled in the art will appreciate that the processes described above can be implemented in any number of variations and in many suitable programming languages without departing from the present invention. For example the order of certain operations carried out can often be varied additional operations can be added or operations can be deleted without departing from the invention. Error trapping can be added and or enhanced and variations can be made in user interface and information presentation without departing from the present invention. Such variations are contemplated and considered equivalent.

Software code and or data embodying certain aspects of the present invention may be present in any tangible computer readable medium or storage medium including but not limited to electronic storage devices such as those described above and other media that stores the code and or data. In the present exemplary embodiments MPEG compliant packets slices tables and other data structures are used but this should not be considered limiting since other data structures can similarly be used without departing from the present invention.

While the invention has been described in conjunction with specific embodiments it is evident that many alternatives modifications permutations and variations will become apparent to those skilled in the art in light of the foregoing description. Accordingly it is intended that the present invention embrace all such alternatives modifications and variations as fall within the scope of the appended claims..

