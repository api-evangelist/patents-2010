---

title: Distributed intelligent network
abstract: A network appliance () includes a processor () and a Host Bus Adapter (HBA-). The processor is configured to execute storage commands in one or more storage devices (A, B). The HBA is coupled to a network () so as to receive communication frames sent over the network to the network appliance, and is configured to filter the received communication frames so as to pass through to the processor only a subset of the received communication frames, which correspond to the storage commands that have been sent by one or more applications for processing by the network appliance.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09021124&OS=09021124&RS=09021124
owner: Axxana (Israel) Ltd.
number: 09021124
owner_city: Tel Aviv
owner_country: IL
publication_date: 20101125
---
This application claims the benefit of U.S. Provisional Patent Application 61 265 766 filed Dec. 2 2009 whose disclosure is incorporated herein by reference.

The present invention relates generally to computer networks and particularly to methods and systems for processing storage commands in computer networks.

Data storage systems use various network configurations and communication protocols for carrying out data storage operations. Some systems use Small Computer System Interface SCSI commands over a Fibre Channel FC protocol. SCSI and FC are specified for example by the American National Standards Institute ANSI and the International Committee for Information Technology Standards INCITS in ANSI INCITS standard 269 1996 entitled Information Technology SCSI 3 Fibre Channel Protocol FCP Apr. 8 1996 which is incorporated herein by reference.

An embodiment of the present invention that is described herein provides a network appliance including 

a Host Bus Adapter HBA which is coupled to a network so as to receive communication frames sent over the network to the network appliance and is configured to filter the received communication frames so as to pass through to the processor only a subset of the received communication frames which correspond to the storage commands that have been sent by one or more applications for processing by the network appliance.

In some embodiments the HBA is configured to filter the communication frames based on one or more attributes of the storage commands to which the communication frames belong. In some embodiments the attributes of a storage command include at least one parameter selected from a group of parameters consisting of a type of the storage command and a storage volume to which the storage command is applied.

In an embodiment each storage command is sent over the network in a respective sequence of the communication frames and the HBA is configured to identify the respective sequence of the communication frames belonging to each storage command so as to reassemble the respective storage commands and to filter the received communication frames by applying a filtering criterion to the reassembled storage commands. In an embodiment the filtering criterion is defined over one or more attributes that are specified only in a first frame of each sequence of the communication frames and the HBA is configured to identify the first frame of each sequence to extract the attributes from the first frame and to filter the communication frames based on the extracted attributes. In a disclosed embodiment the processor is configured to accept the filtering criterion over a Command Line Interface CLI or Graphical User Interface GUI and to forward the filtering criterion to the HBA.

In an embodiment the HBA is configured to receive the communication frames from a network switch and to redirect back to the network switch the communication frames that are not passed through to the processor. The HBA may be configured to receive the communication frames over a given port and to redirect the communication frames back to the network switch over the given port. Alternatively the HBA may be configured to receive the communication frames over a first port and to redirect the communication frames back to the network switch over a second port that is different from the first port. In another embodiment the HBA is configured to discard the communication frames that are not passed through to the processor.

There is additionally provided in accordance with an embodiment of the present invention a storage network including 

a network switch which is configured to receive from one or more applications communication frames that convey storage commands for execution in one or more storage devices and to forward the communication frames irrespective of the storage commands to which the frames belong and

In some embodiments the network switch is configured to redirect the communication frames to the network appliance. In an embodiment the network switch is configured to duplicate the communication frames so as to produce first and second streams of the communication frames to send the first stream for execution in one of the storage devices and to send the second stream to the network appliance for execution in another of the storage devices.

There is also provided in accordance with an embodiment of the present invention a storage method including 

in a network appliance that includes a Host Bus Adapter HBA and a processor receiving over a network communication frames for execution in one or more storage devices 

filtering the received communication frames in the HBA so as to pass through to the processor only a subset of the received communication frames corresponding to the storage commands that have been sent by one or more applications for processing by the network appliance and

There is further provided in accordance with an embodiment of the present invention a storage method including 

in a network switch receiving from one or more applications communication frames that convey storage commands for execution in one or more storage devices and forwarding the communication frames irrespective of the storage commands to which the frames belong 

receiving the forwarded communication frames in a network appliance that includes a Host Bus Adapter HBA and a processor 

filtering the received communication frames in the HBA of the network appliance so as to pass through to the processor only a subset of the received communication frames corresponding to the storage commands that have been sent by the one or more applications for processing by the network appliance and

The present invention will be more fully understood from the following detailed description of the embodiments thereof taken together with the drawings in which 

Embodiments of the present invention that are described herein provide improved methods and systems for data storage in intelligent storage networks. In an intelligent network tasks such as replication mirroring and virtualization are carried out by network switches network appliances or other network elements. The methods and systems described herein improve the performance of such networks by carrying out frame filtering in Host Bus Adapters HBAs of network appliances.

In some embodiments a storage network accepts storage commands from one or more servers for execution in one or more storage devices. Each storage command is typically sent over the network using a respective sequence of communication frames that is referred to as an exchange. The network comprises a network appliance which performs storage tasks such as replication or virtualization on some of the storage commands. The network further comprises a network switch that among other functions forwards communication frames to the network appliance. The switch may forward frames to the appliance using frame redirection or duplication.

The network appliance comprises a HBA and a processor and possibly other elements such as a memory. The HBA typically handles the physical interface with the network reassembles received communication frames into storage commands and provides the reassembled storage commands to the processor. The processor applies the appropriate storage tasks e.g. replication or virtualization to the storage commands provided by the HBA.

In some embodiments of the present invention the network switch is configured to forward communication frames to the network appliance indiscriminately i.e. not necessarily only frames that are intended for processing by the appliance. The HBA of the network appliance is configured to filter the received frames so as to retain only the frames corresponding to storage commands that are to be executed by the appliance. The retained frames are assembled by the HBA into storage commands and provided to the processor for execution. The frames that are filtered out by the HBA are discarded or sent back to the switch without involving or loading the processor.

The frame filtering function of the appliance HBA enables considerable improvement in storage network performance. With this filtering the switch can be relieved of the task of sending to the appliance only the frames that correspond to storage commands that are to be executed by the appliance. This sort of selective switching would typically require the switch to inspect and correlate each frame with the storage command to which it belongs a task that opposes the stateless frame by frame operation of most network switches. Adding frame filtering to the appliance HBA on the other hand does not add considerable processing because the HBA operation is usually already stateful. Since the HBA reassembles frames into storage commands it is inherently aware of the storage command to which each frame belongs.

Thus the methods and systems described herein improve the network switch performance and simplify its operation considerably while adding only negligible processing burden to the network appliance. As a result the overall complexity of the storage network is significantly reduced and its performance is improved.

Servers store and retrieve data by sending storage commands also referred to as Input Output I O commands to storage devices . Storage commands may comprise for example write commands and read commands. In the embodiments described herein SAN operates in accordance with the Fibre Channel FC protocol and servers send to storage devices Small Computer System Interface SCSI commands over FC. In alternative embodiments any other suitable storage standard or protocol can be used.

Each storage command is associated with one or more frame sequences that are referred to collectively as an exchange. A write command for example involves a frame sequence in one direction that carries the command and the data to be written and an acknowledgement that is sent in the opposite direction. The entire bidirectional communication is regarded as the exchange that corresponds to the write command and all the frames belonging to this exchange carry a unique exchange ID. The terms storage command and exchange the sequences of frames corresponding to the storage command are sometimes used interchangeably herein for the sake of clarity.

Some storage tasks in system are carried out by network elements of SAN rather than by servers or storage devices . SAN is therefore referred to as an intelligent network. Storage tasks that can be performed by elements of SAN comprise for example replication i.e. mirroring of data in two or more storage devices storage virtualization i.e. storage in physical storage devices that are managed by the SAN transparently to the servers caching and or any other suitable task. Although the examples described below refer mainly to replication tasks the disclosed techniques can be used for carrying out various other storage tasks as well.

SAN comprises an intelligent network switch and a network appliance . Switch accepts communication frames from servers and forwards the frames to appliance which in turn executes the storage commands in storage devices . In an example embodiment switch and appliance together carry out data replication i.e. mirror certain storage commands in two or more separate storage devices for protection.

In the example of switch duplicates forks the storage commands to be mirrored so as to produce two separate streams of frames. The switch sends one stream of frames for execution in storage device B and sends the other stream of frames to appliance for mirroring the storage commands in storage device A. Appliance executes the storage commands received from switch in storage device A directly or indirectly e.g. by forwarding storage commands to another appliance that executes them against the storage device . This configuration is referred to herein as forking. An alternative configuration in which appliance handles the mirrored storage in both storage devices is described in below. Typically each storage device comprises a respective HBA for communicating with SAN .

Appliance comprises a Host Bus Adapter HBA and a processor . HBA handles the physical interface of appliance with SAN e.g. translation between optical signals and communication frames and also reassembles the frames accepted from switch into storage commands. Processor executes the reassembled storage commands in one or more of storage devices .

In some embodiments HBA comprises one or more ports for receiving and transmitting frames. An exchange reconstruction module reassembles the frames accepted from switch into storage commands. In other words module associates each received frame with the storage command to which it belongs so as to reproduce the exchanges produced by servers . In some embodiments module also associates each frame with the storage volume to which it applies. Module may perform this association for example using a mapping between volumes and Initiator IDs target IDs and Logical Unit Numbers LUNs which is provided to the HBA. Module provides the reassembled storage commands to processor over a Direct Memory Access DMA interface .

In some embodiments HBA of appliance comprises a frame filter . Filter filters the frames that are received from switch so as to retain only the frames corresponding to storage commands that are to be processed by the appliance. The frames that are filtered out by filter i.e. the frames that do not correspond to storage commands that are to be processed by the appliance may be sent back from HBA to switch . Alternatively the filtered out frames may be discarded. In either case the filtered out frames are processed by HBA without involving or loading processor .

Frame filter is typically configured using a suitable Command Line Interface CLI or Application Programming Interface API with the desired filtering scheme. The filtering scheme for frame filter may be sent from processor to HBA using any suitable interface such as over DMA interface or over interface registers not shown in the figure between appliance and HBA .

Frame filter may filter frames according to any suitable filtering criteria that are defined over the corresponding storage commands. For example filter may retain storage commands that are directed to one or more particular storage volumes. The storage volumes in question may be defined for example by a SCSI nexus. As another example filter may retain storage commands that are of a particular type e.g. retain only write commands or only read commands. As yet another example filter may combine the two above described criteria e.g. retain only commands of a certain type that are directed to a particular storage volume. As noted above module is aware of the command type and storage volume associated with each frame and filter may use this association for filtering the frames.

Because of the frame filtering performed in HBA of appliance switch can be configured to send frames indiscriminately to appliance . In the present context the term sending frames indiscriminately means sending frames over a given path in the network regardless of the storage command to which the frames belong. As such switch is relieved of the need to inspect the content of each frame identify the storage command to which the frame belongs and switch the frame according to the respective command. Implementing this sort of selective switching in switch would be extremely computationally intensive and lime consuming.

For example in many protocols e.g. in SCSI over FC only the first frame in a given exchange indicates the command type and the applicable storage volume. Subsequent frames indicate only an identifier of the exchange denoted Fully Qualified Exchange identifier FQXID in SCSI over FC . Selective switching in switch would require the switch to maintain suitable data structures and processes for associating each frame with a respective exchange based on the exchange identifier and then switching the frame accordingly. This sort of process would typically cause severe performance degradation in the switch since most switches operate in a stateless frame by frame manner that does not inspect the frame content.

Implementing exchange based frame filtering in HBA on the other hand adds little or no computational load to the HBA. As noted above HBA reassembles the received frames into exchanges. Thus the HBA inherently operates in a stateful manner that is aware of the exchange to which each frame belongs. Filtering frames based on exchange based criteria in HBA e.g. based on command type or target volume can use the exchange reassembly functionality of module and therefore add little computational load if any.

As in the configuration of above switch is typically configured to send the frames indiscriminately to appliance . Configuration of switch can be performed using a suitable CLI or API. Unlike the scheme of in the configuration of the switch redirects the frames to appliance without duplicating them. Duplication is carried out in appliance .

Storage tasks such as mirroring can be performed using either the configuration of or the configuration of . The configuration of is particularly suitable for implementing tasks such as storage virtualization e.g. mapping of logical volumes specified in the storage commands to physical storage locations that are transparent to servers . Generally however any suitable storage task can be carried out in SAN using either the forking scheme of or the redirection scheme of . Typically although not necessarily in the forking configuration of HBA discards the filtered out frames and in the redirection configuration of HBA redirects the filtered out frames back to switch .

The configuration of systems and in and of system elements such as switch and appliance are example configurations that are chosen purely for the sake of conceptual clarity. In alternative embodiments any other suitable configurations can also be used. The components of switch and appliance can be implemented is hardware such as using one or more Field Programmable Gate Arrays FPGAs or Application Specific Integrated Circuits ASIC . Alternatively some components of switch and appliance can be implemented in software or using a combination of hardware and software elements.

Typically processor of appliance comprises a general purpose computer which is programmed in software to carry out the functions described herein. The software may be downloaded to the computer in electronic form over a network for example or it may alternatively or additionally be provided and or stored on non transitory tangible media such as magnetic optical or electronic memory.

In some embodiments HBA of appliance comprises multiple ports e.g. two or four ports. In an embodiment HBA may receive frames from switch over a given port and redirect the filtered out frames back to the switch over the same port. In an alternative embodiment the HBA may receive frames from switch on a given port and redirect the filtered out frames back to switch over a different port. The latter implementation can be used for example when the load on the port used for receiving the frames is high.

In some embodiments switch does not change the metadata or World Wide Name WWN addresses of the frames when it redirects or forks the frames to appliance . In an example embodiment switch is configured so that the ports connecting the switch to servers belong to one Virtual SAN VSAN and the ports connecting the switch to appliance and to storage devices belong to a different VSAN. In an alternative embodiment switch is configured so that the ports connecting the switch to servers belong to one FC zone and the ports connecting the switch to appliance and to storage devices belong to a different FC zone. When configuring the switch using different VSANs or different FC zones in this manner the metadata and WWN addresses of the redirected or forked frames can typically remain unchanged. When metadata changes are needed these changes are typically carried out by HBA .

Filter in HBA of appliance filters the received frames at a filtering step . The filter retains only the frames corresponding to storage commands that are to be processed by the appliance. Typically exchange reconstruction module reassembles the received frames into storage commands and filter filters the frames based on a filtering criterion that is defined over the storage commands. The retained frames reassembled into storage commands are provided to processor using DMA interface . The filtered out frames are sent back from HBA to switch or discarded.

Processor of appliance processes the storage commands corresponding to the retained frames at a command execution step . For example processor may perform data replication virtualization caching or any other applicable storage task.

When the storage commands are sent as SCSI commands over FC the first frame in a given exchange in a given frame sequence carrying a SCSI command has the following FC header 

The FC header may be followed by a SCSI command payload a data payload or other information. The S ID and D ID fields indicate the source and destination of the frame respectively typically corresponding to initiator and target WWNs. The OX ID and RX ID fields indicate a unique ID of the exchange to which this frame belongs as assigned by the initiator and the receiver respectively. The unique ID appears twice since the initiator and receiver may mark the frame by a different unique ID. These fields are defined when the command is first transmitted and acknowledged. All subsequent frames of the command indicate the same values in these fields.

A command payload that follows the above described header in the frame typically has the following format 

The FCP LUN field gives the Logical Unit Number addressed by the command the WWN is given in the basic frame header and the FCP CDB indicates the command itself.

Subsequent data frames in this exchange typically comprise exchange identifiers e.g. D ID S ID OX ID or RX ID but not the command type or applicable storage volume. These identifiers are referred to collectively as a Fully Qualified Exchange ID FQXID . In order to reassemble the SCSI command and its data and associate them with a single exchange module in HBA may look up the first frame in the exchange using the FQXID. Module typically extracts the command type and target storage volume from the first frame in the exchange. In some embodiments filter in HBA applies the above described filtering criteria based on the command type and storage volume information that are obtained by module from the first frame of the exchange.

The following table gives the header fields that can be used by HBA to reassemble the frames of a given exchange 

Although the embodiments described herein mainly address execution of storage tasks using HBAs of network appliances the methods and systems described herein can also be used in other applications such as for implementing a store and forward network or replication scheme using HBAs that are installed on the storage devices. In such schemes all frames that do not belong to a particular storage device are forwarded forked by the storage device s HBA to the next storage device.

It will thus be appreciated that the embodiments described above are cited by way of example and that the present invention is not limited to what has been particularly shown and described hereinabove. Rather the scope of the present invention includes both combinations and sub combinations of the various features described hereinabove as well as variations and modifications thereof which would occur to persons skilled in the art upon reading the foregoing description and which are not disclosed in the prior art.

