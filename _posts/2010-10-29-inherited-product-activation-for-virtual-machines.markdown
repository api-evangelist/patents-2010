---

title: Inherited product activation for virtual machines
abstract: Methods and systems are disclosed in which inherited activation opens a secure communication path from the host operating system (OS) to the guest (virtual machine) OS. The license state of the software on the host is passed through this channel, and software installed in the guest uses this information to inform its own product activation process. The virtualized (guest) software may then activate without any outside communication when the license requirements for the host are met.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08832686&OS=08832686&RS=08832686
owner: Microsoft Corporation
number: 08832686
owner_city: Redmond
owner_country: US
publication_date: 20101029
---
Virtualization enables the creation of a fully configured computer entirely out of software. For example when a guest computer system is emulated on a host computer system the guest computer system is said to be a virtual machine as the guest computer system exists in the host computer system as a software representation of the operation of one specific hardware architecture. Within a virtual machine an operating system may be installed just like it would be on physical hardware.

Virtual machines may use software applications that apply an activation mechanism. For example some applications may apply a licensing mechanism that allows users to use the applications on one or more virtual machines subject to certain terms and conditions. Product activation in this context describes the act of satisfying the licensing mechanism requirements allowing use of the software. In a virtual machine context unique challenges exist for applying software product activation mechanisms.

Software antipiracy solutions often operate by binding the software license to the individual computer hardware by creating a hardware based ID or thumbprint for the computer. Virtualization makes these solutions unreliable since the hardware is virtualized. The thumbprint can be edited or duplicated and thus can be exploited to bypass product activation and copy or steal the software. Furthermore typical server virtualization scenarios move the virtual machine from one host to another as needed. This legitimate use can can break software licensing solutions that bind to a hardware thumbprint.

Methods and systems are disclosed herein in which an inherited activation mechanism opens a secure communication path from the host operating system OS to the guest OS. The license state of the software on the host is passed through this channel and software installed in the guest uses this information to inform its own product activation process. The virtualized software may then activate without any outside communication when the license requirements for the host are met.

The foregoing is a summary and thus contains by necessity simplifications generalizations and omissions of detail. Those skilled in the art will appreciate that the summary is illustrative only and is not intended to be in any way limiting.

Certain specific details are set forth in the following description and figures to provide a thorough understanding of various embodiments of the invention. Certain well known details often associated with computing and software technology are not set forth in the following disclosure to avoid unnecessarily obscuring the various embodiments of the invention. Further those of ordinary skill in the relevant art will understand that they can practice other embodiments of the invention without one or more of the details described below. Finally while various methods are described with reference to steps and sequences in the following disclosure the description as such is for providing a clear implementation of embodiments of the invention and the steps and sequences of steps should not be taken as required to practice this invention.

It should be understood that the various techniques described herein may be implemented in connection with hardware or software or where appropriate with a combination of both. Thus the methods and apparatus of the invention or certain aspects or portions thereof may take the form of program code i.e. instructions embodied in tangible media such as floppy diskettes CD ROMs hard drives or any other machine readable storage medium wherein when the program code is loaded into and executed by a machine such as a computer the machine becomes an apparatus for practicing the invention. In the case of program code execution on programmable computers the computing device generally includes a processor a storage medium readable by the processor including volatile and non volatile memory and or storage elements at least one input device and at least one output device. One or more programs that may implement or utilize the processes described in connection with the invention e.g. through the use of an application programming interface API reusable controls or the like. Such programs are preferably implemented in a high level procedural or object oriented programming language to communicate with a computer system. However the program s can be implemented in assembly or machine language if desired. In any case the language may be a compiled or interpreted language and combined with hardware implementations.

A remote desktop system is a computer system that maintains applications that can be remotely executed by client computer systems. Input is entered at a client computer system and transferred over a network e.g. using protocols based on the International Telecommunications Union ITU T.120 family of protocols such as Remote Desktop Protocol RDP to an application on a terminal server. The application processes the input as if the input were entered at the terminal server. The application generates output in response to the received input and the output is transferred over the network to the client

Embodiments may execute on one or more computers. and the following discussion are intended to provide a brief general description of a suitable computing environment in which the disclosure may be implemented. One skilled in the art can appreciate that computer systems can have some or all of the components described with respect to computer of .

The term circuitry used throughout the disclosure can include hardware components such as hardware interrupt controllers hard drives network adaptors graphics processors hardware based video audio codecs and the firmware software used to operate such hardware. The term circuitry can also include microprocessors configured to perform function s by firmware or by switches set in a certain way or one or more logical processors e.g. one or more cores of a multi core general processing unit. The logical processor s in this example can be configured by software instructions embodying logic operable to perform function s that are loaded from memory e.g. RAM ROM firmware and or virtual memory. In example embodiments where circuitry includes a combination of hardware and software an implementer may write source code embodying logic that is subsequently compiled into machine readable code that can be executed by a logical processor. Since one skilled in the art can appreciate that the state of the art has evolved to a point where there is little difference between hardware software or a combination of hardware software the selection of hardware versus software to effectuate functions is merely a design choice. Thus since one of skill in the art can appreciate that a software process can be transformed into an equivalent hardware structure and a hardware structure can itself be transformed into an equivalent software process the selection of a hardware implementation versus a software implementation is trivial and left to an implementer.

A number of program modules may be stored on the hard disk magnetic disk optical disk ROM or RAM including an operating system one or more application programs other program modules and program data . A user may enter commands and information into the computer through input devices such as a keyboard and pointing device . Other input devices not shown may include a microphone joystick game pad satellite disk scanner or the like. These and other input devices are often connected to the processing unit through a serial port interface that is coupled to the system bus but may be connected by other interfaces such as a parallel port game port or universal serial bus USB . A display or other type of display device can also be connected to the system bus via an interface such as a video adapter . In addition to the display computers typically include other peripheral output devices not shown such as speakers and printers. The system of also includes a host adapter Small Computer System Interface SCSI bus and an external storage device connected to the SCSI bus .

The computer may operate in a networked environment using logical connections to one or more remote computers such as a remote computer . The remote computer may be another computer a server a router a network PC a peer device or other common network node a virtual machine and typically can include many or all of the elements described above relative to the computer although only a memory storage device has been illustrated in . The logical connections depicted in can include a local area network LAN and a wide area network WAN . Such networking environments are commonplace in offices enterprise wide computer networks intranets and the Internet.

When used in a LAN networking environment the computer can be connected to the LAN through a network interface or adapter . When used in a WAN networking environment the computer can typically include a modem or other means for establishing communications over the wide area network such as the Internet. The modem which may be internal or external can be connected to the system bus via the serial port interface . In a networked environment program modules depicted relative to the computer or portions thereof may be stored in the remote memory storage device. It will be appreciated that the network connections shown are examples and other means of establishing a communications link between the computers may be used. Moreover while it is envisioned that numerous embodiments of the disclosure are particularly well suited for computer systems nothing in this document is intended to limit the disclosure to such embodiments.

Referring now to another embodiment of an exemplary computing system is depicted. Computer system can include a logical processor e.g. an execution core. While one logical processor is illustrated in other embodiments computer system may have multiple logical processors e.g. multiple execution cores per processor substrate and or multiple processor substrates that could each have multiple execution cores. As shown by the figure various computer readable storage media can be interconnected by one or more system busses which couples various system components to the logical processor . The system buses may be any of several types of bus structures including a memory bus or memory controller a peripheral bus and a local bus using any of a variety of bus architectures. In example embodiments the computer readable storage media can include for example random access memory RAM storage device e.g. electromechanical hard drive solid state hard drive etc. firmware e.g. FLASH RAM or ROM and removable storage devices such as for example CD ROMs floppy disks DVDs FLASH drives external storage devices etc. It should be appreciated by those skilled in the art that other types of computer readable storage media can be used such as magnetic cassettes flash memory cards digital video disks Bernoulli cartridges.

The computer readable storage media provide non volatile storage of processor executable instructions data structures program modules and other data for the computer . A basic input output system BIOS containing the basic routines that help to transfer information between elements within the computer system such as during start up can be stored in firmware . A number of programs may be stored on firmware storage device RAM and or removable storage devices and executed by logical processor including an operating system and or application programs.

Commands and information may be received by computer through input devices which can include but are not limited to a keyboard and pointing device. Other input devices may include a microphone joystick game pad scanner or the like. These and other input devices are often connected to the logical processor through a serial port interface that is coupled to the system bus but may be connected by other interfaces such as a parallel port game port or universal serial bus USB . A display or other type of display device can also be connected to the system bus via an interface such as a video adapter which can be part of or connected to a graphics processor . In addition to the display computers typically include other peripheral output devices not shown such as speakers and printers. The exemplary system of can also include a host adapter Small Computer System Interface SCSI bus and an external storage device connected to the SCSI bus.

Computer system may operate in a networked environment using logical connections to one or more remote computers such as a remote computer. The remote computer may be another computer a server a router a network PC a peer device or other common network node and typically can include many or all of the elements described above relative to computer system .

When used in a LAN or WAN networking environment computer system can be connected to the LAN or WAN through a network interface card . The NIC which may be internal or external can be connected to the system bus. In a networked environment program modules depicted relative to the computer system or portions thereof may be stored in the remote memory storage device. It will be appreciated that the network connections described here are exemplary and other means of establishing a communications link between the computers may be used. Moreover while it is envisioned that numerous embodiments of the present disclosure are particularly well suited for computerized systems nothing in this document is intended to limit the disclosure to such embodiments.

A remote desktop system is a computer system that maintains applications that can be remotely executed by client computer systems. Input is entered at a client computer system and transferred over a network e.g. using protocols based on the International Telecommunications Union ITU T.120 family of protocols such as Remote Desktop Protocol RDP to an application on a terminal server. The application processes the input as if the input were entered at the terminal server. The application generates output in response to the received input and the output is transferred over the network to the client computer system. The client computer system presents the output data. Thus input is received and output presented at the client computer system while processing actually occurs at the terminal server. A session can include a shell and a user interface such as a desktop the subsystems that track mouse movement within the desktop the subsystems that translate a mouse click on an icon into commands that effectuate an instance of a program etc. In another example embodiment the session can include an application. In this example while an application is rendered a desktop environment may still be generated and hidden from the user. It should be understood that the foregoing discussion is exemplary and that the presently disclosed subject matter may be implemented in various client server environments and not limited to a particular terminal services product.

In most if not all remote desktop environments input data entered at a client computer system typically includes mouse and keyboard data representing commands to an application and output data generated by an application at the terminal server typically includes video data for display on a video output device. Many remote desktop environments also include functionality that extend to transfer other types of data.

Communications channels can be used to extend the RDP protocol by allowing plug ins to transfer data over an RDP connection. Many such extensions exist. Features such as printer redirection clipboard redirection port redirection etc. use communications channel technology. Thus in addition to input and output data there may be many communications channels that need to transfer data. Accordingly there may be occasional requests to transfer output data and one or more channel requests to transfer other data contending for available network bandwidth.

Turning to illustrated is an exemplary virtual machine server that can be used to generate virtual machines. In this embodiment hypervisor microkernel can be configured to control and arbitrate access to the hardware of computer system . Hypervisor microkernel can isolate processes in one partition from accessing another partition s resources. For example hypervisor microkernel can generate execution environments called partitions such as child partition through child partition N where N is an integer greater than 1 . In this embodiment a child partition is the basic unit of isolation supported by hypervisor microkernel . Each child partition can be mapped to a set of hardware resources e.g. memory devices logical processor cycles etc. that is under control of the hypervisor microkernel . In embodiments hypervisor microkernel can be a stand alone software product a part of an operating system embedded within firmware of the motherboard specialized integrated circuits or a combination thereof.

Hypervisor microkernel can enforce partitioning by restricting a guest operating system s view of the memory in a physical computer system. When hypervisor microkernel instantiates a virtual machine it can allocate pages e.g. fixed length blocks of memory with starting and ending addresses of system physical memory SPM to the virtual machine as guest physical memory GPM . In this embodiment the guest s restricted view of system memory is controlled by hypervisor microkernel . The term guest physical memory is a shorthand way of describing a page of memory from the viewpoint of a virtual machine and the term system physical memory is shorthand way of describing a page of memory from the viewpoint of the physical system. Thus a page of memory allocated to a virtual machine will have a guest physical address the address used by the virtual machine and a system physical address the actual address of the page .

A guest operating system may virtualize guest physical memory. Virtual memory is a management technique that allows an operating system to over commit memory and to give an application sole access to a contiguous working memory. In a virtualized environment a guest operating system can use one or more page tables to translate virtual addresses known as virtual guest addresses into guest physical addresses. In this example a memory address may have a guest virtual address a guest physical address and a system physical address.

In the depicted example parent partition component which can also be also thought of as similar to domain 0 of Xen s open source hypervisor can include a host . Host can be an operating system or a set of configuration utilities and host can be configured to provide resources to guest operating systems executing in the child partitions N by using virtualization service providers VSPs . VPSs which are typically referred to as back end drivers in the open source community can be used to multiplex the interfaces to the hardware resources by way of virtualization service clients VSCs typically referred to as front end drivers in the open source community or paravirtualized devices . As shown by the figures virtualization service clients execute within the context of guest operating systems. However these drivers are different than the rest of the drivers in the guest in that they may be supplied with a hypervisor not with a guest. In an exemplary embodiment the path used to by virtualization service providers to communicate with virtualization service clients and can be thought of as the virtualization path.

As shown by the figure emulators e.g. virtualized IDE devices virtualized video adaptors virtualized NICs etc. can be configured to run within host and are attached to resources available to guest operating systems and . For example when a guest OS touches a memory location mapped to where a register of a device would be or memory mapped to a device microkernel hypervisor can intercept the request and pass the values the guest attempted to write to an associated emulator. The resources in this example can be thought of as where a virtual device is located. The use of emulators in this way can be considered the emulation path. The emulation path is inefficient compared to the virtualized path because it requires more CPU resources to emulate device than it does to pass messages between VSPs and VSCs. For example the hundreds of actions on memory mapped to registers required in order to write a value to disk via the emulation path may be reduced to a single message passed from a VSC to a VSP in the virtualization path.

Each child partition can include one or more virtual processors and that guest operating systems and can manage and schedule threads to execute thereon. Generally the virtual processors are executable instructions and associated state information that provide a representation of a physical processor with a specific architecture. For example one virtual machine may have a virtual processor having characteristics of an Intel x86 processor whereas another virtual processor may have the characteristics of a PowerPC processor. The virtual processors in this example can be mapped to logical processors of the computer system such that the instructions that effectuate the virtual processors will be backed by logical processors. Thus in an embodiment including multiple logical processors virtual processors can be simultaneously executed by logical processors while for example other logical processor execute hypervisor instructions. The combination of virtual processors and memory in a partition can be considered a virtual machine.

Guest operating systems and can be any operating system such as for example operating systems from Microsoft Apple the open source community etc. The guest operating systems can include user kernel modes of operation and can have kernels that can include schedulers memory managers etc. Generally speaking kernel mode can include an execution mode in a logical processor that grants access to at least privileged processor instructions. Each guest operating system can have associated file systems that can have applications stored thereon such as terminal servers e commerce servers email servers etc. and the guest operating systems themselves. The guest operating systems can schedule threads to execute on the virtual processors and instances of such applications can be effectuated.

Referring now to illustrated is a virtual machine server based on an alternative architecture. depicts similar components to those of however in this example embodiment hypervisor can include a microkernel component and components similar to those in host of such as the virtualization service providers and device drivers while management operating system may contain for example configuration utilities used to configure hypervisor . In this architecture hypervisor can perform the same or similar functions as hypervisor microkernel of however in this architecture hypervisor can be configured to provide resources to guest operating systems executing in the child partitions. Hypervisor of can be a stand alone software product a part of an operating system embedded within firmware of the motherboard or a portion of hypervisor can be effectuated by specialized integrated circuits.

Turning now to illustrated is a high level block diagram of virtual desktop server . In an embodiment virtual desktop server can be configured to deploy virtual desktop sessions VDS to clients e.g. mobile devices such as smart phones computer systems having components similar to those illustrated in etc. Briefly virtual desktop technology allows a user to remotely interact with a guest operating system running in a virtual machine. Unlike a remote desktop session in a virtual desktop session only one user is logged into a guest operating system and can have total control of it e.g. the user can run as an administrator and can have full rights on the guest. In the illustrated example virtual desktop server can have components similar to computer system or of or . In the illustrated example virtualization platform is a logical abstraction of virtualization infrastructure components described above in and . The functionality described in the following sections as within virtualization platform can be implemented in one or more of the elements depicted in or . For example virtual desktop manager could be implemented in a host of . More specifically virtual desktop manager could be implemented in a host operating system running in the parent partition.

Starting a virtual desktop session requires instantiation of a guest operating system within a virtual machine. In an exemplary embodiment virtual desktop manager e.g. a module of processor executable instructions can start up virtual machine along with guest operating system in response to a request. Virtual desktop manager can execute on a logical processor and instruct virtualization platform e.g. microkernel hypervisor to allocate memory for a partition. Virtualization platform can execute and set virtual devices up within virtual machine and load a boot loader program into virtual machine memory. The boot loader program can execute on a virtual processor and load guest operating system . For example session manager can be loaded which can instantiate environment subsystems such as runtime subsystem that can include a kernel mode part such as operating system core . For example the environment subsystems in an embodiment can be configured to expose a subset of services to application programs and provide an access point to kernel . When guest operating system is loaded the boot loader program can exit and turn control of the virtual machine over to guest operating system . Guest operating system can execute the various modules illustrated in and configure itself to host a virtual desktop session. For example guest operating system can include registry values that cause remote presentation engine and or configuration service to start upon boot.

A virtual desktop session can start when guest operating system receives a connection request over a network from a client. A connection request can first be handled by remote presentation engine . The remote presentation engine can be configured to listen for connection messages and forward them to session manager . As illustrated by when sessions are generated the remote presentation engine can run a protocol stack instances for the session. Generally the protocol stack instance can be configured to route user interface output to an associated client and route user input received from the associated client to operating system core . Briefly operating system core can be configured to manage screen output collect input from keyboards mice and other devices.

A user credential e.g. a username password combination can be received by remote presentation engine and passed to session manager . Session manager can pass the credential to a logon procedure which can route the credential to authentication engine for verification. Authentication engine can generate a system token which can be used whenever a user attempts to execute a process to determine whether the user has the security credentials to run the process or thread. For example when a process or thread attempts to gain access e.g. open close delete and or modify an object e.g. a file setting or an application the thread or process can be authenticated by security subsystem . Security subsystem can check the system token against an access control list associated with the object and determine whether the thread has permission based on a comparison of information in the system token and the access control list. If security subsystem determines that the thread is authorized then the thread can be allowed to access the object.

Continuing with the description of in an embodiment the operating system core can include a graphics display interface GDI and input subsystem . Input subsystem in an example embodiment can be configured to receive user input from a client via the protocol stack instance for the virtual desktop session and send the input to operating system core . The user input can in some embodiments include signals indicative of absolute and or relative mouse movement commands mouse coordinates mouse clicks keyboard signals joystick movement signals etc. User input for example a mouse double click on an icon can be received by the operating system core and the input subsystem can be configured to determine that an icon is located at the coordinates associated with the double click. Input subsystem can then be configured to send a notification to runtime subsystem that can execute a process for the application associated with the icon.

Draw commands can be received from applications and or a desktop and processed by GDI . GDI in general can include a process that can generate graphical object draw commands. GDI in this example embodiment can be configured to pass the commands to remote display subsystem that can instantiate a display driver for the session. In an example embodiment remote display subsystem can be configured to include virtual display driver s that can be configured to receive the draw commands and send them to the client.

Also shown in is a configuration service . In an exemplary embodiment configuration service can be used to setup guest operating system to conduct virtual desktop sessions prior to connection by a client. For example configuration service can run within guest operating system and be executed when guest operating system boots. Since certain configuration settings require administrative privileges configuration service can be configured to run as a process with system wide privileges. Some of the exemplary actions configuration service can take include but are not limited to actions that add an account identifier for the user to a list of administrative users for guest operating system add the account identifier to a list of authorized virtual desktop users set registry values open guest operating system firewalls and open the port that remote presentation engine listens for connections on. Configuration service is described in more detail in the following paragraphs.

In an exemplary embodiment a communication channel can be established between virtualization platform and guest operating system in order to configure and control guest operating system . Since a remote user can have complete control of virtual machine security needs to be in place to ensure that any channel used to configure and control guest operating system can not also be used to attack virtualization platform or other computer systems connected to an internal network. Traditionally a networked communication channel is used to setup and control guest operating system . Network channels however are difficult to deploy when guest operating system is not in the same network domain as virtualization platform and virtualization platform is configured to deny incoming connection requests from outside the domain.

In an exemplary embodiment inter partition communication channel can be used to communicate with configuration server in order to configure and or manage the virtual desktop session. Inter partition communication channel can be configured to be implicitly trusted by virtual machine and not trusted by virtualization platform . In this example information e.g. data and or commands can be easily routed to guest operating system without any need to verify the information. On the other hand data received from virtual machine can be verified and authenticated before virtualization platform takes an action. Moreover because inter partition communication channel does not use networking guest operating system can be kept off the internal network.

Inter partition communication channel can be implicitly trusted by virtual machine i.e. information received via the channel is inherently authenticated validated because only virtualization platform can create inter partition communication channel . For example in an embodiment inter partition communication channel can be implemented at least in part as a region of memory shared between virtual machine and virtualization platform . Virtualization platform can cause a data structure indicative of a ring buffer or the like to be created in region of shared memory that can be used as a full duplex communication channel between virtualization platform and virtual machine . In an exemplary embodiment the inter partition communication channel can include features described in U.S. Pat. No. 7 689 800 entitled Partition bus the contents of which are herein incorporated by reference in its entirety.

Virtualization platform can write information to inter partition communication channel that can be read by virtual machine . In an exemplary embodiment inter partition communication channel can be message based. That is virtualization platform and virtual machine can be configured to write packets of data to inter partition communication channel . In the same or another exemplary embodiment inter partition communication channel can be event driven. In this configuration when information is written to the channel the receiver can be instructed to read the information from inter partition communication channel by for example hypervisor of .

Turning now to illustrated is a high level block diagram of a datacenter including virtual desktop server virtual desktop server licensing server broker server gateway and client . The datacenter can be configured to deploy virtual desktop sessions to clients. In the illustrated example virtualization platform virtual desktop server licensing server broker server and gateway can be part of an intranet and the user credentials used to log into these computers can be members of the same domain i.e. the infrastructure domain . Infrastructure domain is shown in dashed lines cutting virtual desktop server in half to illustrate that in an exemplary embodiment virtual machine can be part of a different domain or part of no domain.

The datacenter can include an internal network coupling a plurality of virtual desktop servers and which can include components similar to those illustrated by or to broker server and licensing server . As one of skill in the art can appreciate while two virtual desktop servers are shown the datacenter can have many more. Also while virtual desktop server is illustrated running one virtual machine each virtual desktop server can simultaneously host many virtual machines. Or put another way the datacenter can have M where M is an integer greater than 1 virtual desktop servers and each of the M virtualization hosts can host N where N is also an integer greater than 1 virtual machines.

Broker server can act as an interface to the intranet for client . Briefly broker server can include components similar to the components described with respect to . Broker server can have a network adapter that interfaces it to a public network such as the Internet and another network adapter that interfaces it to the internal network i.e. the intranet. In this example broker server can act as a gateway for the internal network thereby allowing virtual desktop servers and licensing server to be kept off the public network.

When user of client wants a virtual desktop session he or she can click on an icon and client can send one or more packets of information to broker server . Broker server can include a module of software instructions that upon execution cause a logical processor to select a suitable virtualization host to instantiate a virtual machine to host the virtual desktop session. A user credential e.g. a username and password combination can be collected and broker server can check session database to determine whether the datacenter includes any disconnected virtual desktop sessions associated with the user credential such as a username password combination. If session database includes a disconnected virtual desktop session associated with the user credential broker server can send a signal to the virtualization host that has the disconnected session and instruct it to execute the virtual machine. If session database does not have information indicative of a disconnected session for the user broker server can select a suitable virtual desktop server e.g. one that has the resources available to instantiate a virtual machine to host a virtual desktop session.

Virtualization platform can instantiate virtual machine and execute guest operating system on a virtual processor. Referring back to guest operating system can run remote presentation engine return an internet protocol IP address of virtual NIC to broker server and await a connection from client . Broker server can return the IP address of virtual NIC to client in a packet of information that causes a logical processor of client to redirect client to the IP address virtual machine . Gateway can receive the connection request and forward it to virtual NIC .

In an least one exemplary embodiment session manager can be configured to check to see if the client is associated with a valid license before starting the virtual desktop session. Remote presentation engine can receive a license from client or information associated with a license and send the information to virtualization platform which can send the license or the information associated with the license to licensing server . Licensing server can include license validation engine which can be configured to determine whether a license associated with client is valid. If the license is valid license validation engine can send a signal back virtual desktop server and a virtual desktop session can be started. At this point remote presentation engine can stream one or more packets of information indicative of a graphical user interface for guest operating system to client and receive one or more packets of information indicative of user input from client .

In an exemplary embodiment when virtualization platform receives a request from broker server to instantiate a virtual machine virtual desktop manager can execute and send commands and or information via inter partition communication channel to virtual machine to cause guest operating system to be configured to conduct a virtual desktop session. Configuration service can receive the commands and or information and configure guest operating system accordingly. For example virtual desktop manager can send the identity of the user attempting to connect desired settings for a firewall protecting guest operating system registry values a list of applications the user is allowed to operate commands to enable virtual desktop sessions and to add the identity of the user to a list of authorized virtual desktop users etc. Configuration service can execute on a virtual processor and change appropriate settings.

Once the virtual desktop session is running virtual desktop manager can manage a running virtual desktop session via inter partition communication channel . For example virtual desktop manager can issue commands to virtual machine such as commands that cause the guest operating system to shut down disconnect the user reset the guest operating system etc. In the same or another embodiment virtual desktop manager can manage the virtual desktop session receive state information for virtual machine status information from remote presentation engine and or send commands to control the virtual desktop session to configuration service . For example virtual desktop manager can receive state information for virtual machine that indicates whether virtual machine is running paused ready booting as well as a list of IP addresses that can be sent to the client. In addition virtual desktop manager can receive status information for guest operating system such as the identity of the user that is logged in for the virtual desktop session and communicate some or all of this information to broker server .

The computers depicted in may be similar to the computer depicted in . In a client communicates with a deployment which comprises authentication server connection broker gateway remote application server farm which in turn comprises two homogenously configured servers remote application servers and VM server farm which in turn comprises two homogenously configured VMs VMs .

Client has a workspace that comprises multiple remote resources served by one or more of remote application servers and VMs . Client may log into its workspace through an authentication server . Once authenticated the client s request to connect to its workspace is transmitted from authentication server to connection broker . Connection broker is configured to broker connections between client and the application servers and VMs that will serve remote resources with client and to effectuate this connection broker is configured to communicate with application servers and VMs to determine what resources they are currently serving including disconnected remote resources for a user of client .

Client may have a workspace that comprises multiple remote resources a remote resource comprising a remote application from remote application server and a remote resource that comprises a VM from VM . As depicted client does not have a remote resource with remote application server or VM . These may each serve different applications or desktops versions of an application or other permutations. For instance remote application server may be serving client with a remoted word processor application and VM may be serving client with a remote desktop.

As can be seen through this depiction when a user wishes to reconnect back to his or her workspace he may desire to reconnect to the remote resources of both remote application server and VM through one command rather than through one command performed three times. The user may perform this reconnect operation from client or from another client computer such as where client is the user s computer at work and the user wishes to reconnect from a computer at home during the weekend .

A user of client has previously had a workspace to remote server farm that involved accessing a remote resource from VM and this workspace is now disconnected. Before client even attempts to reconnect to the deployment authentication server publishes a document via communication to client identifying information about the deployment that client may use to access the remote resources of the deployment . Client later reconnects by sending communication to authentication server . Authentication server validates credentials of the user and or client such as a login and password . Where the credentials are validated authentication server communicates with connection broker to determine which remote resources here VM client is to reconnect to when reconnecting its workspace. Authentication server makes this determination by sending communication to connection broker and in response receiving back in communication a list of server farms here VM farm for client to reconnect to. This information indicated in communication is passed by authentication server to client in communication .

When client has the list of servers to reconnect to from authentication server client reestablishes a communication with each of those server farms. As depicted in that server farm is VM farm . Client communicates with gateway to access the remote resources of these server farms. Gateway processes communication and in turn communicates with connection broker to convey similar information. Connection broker takes the identification of the server farm from communication and from it identifies the machine VM within the farm that has that disconnected remote resource. Connection broker sends communication to VM instructing VM to reconnect the remote resource to client . VM reconnects with client by sending a communication indicative of the same to gateway which in turn sends a communication indicative of the same to client .

It may be appreciated that this is a simplified diagram to emphasize the present invention and that more or fewer server farms may be present and or reconnected to and that the communications passed may be more involved for instance it is shown that communications and establish a reconnection between VM and client where this may also involve communications that are send from client through gateway and to VM .

All of these variations for implementing the above mentioned virtual machines are just exemplary implementations and nothing herein should be interpreted as limiting the disclosure to any particular virtualization aspect.

Software antipiracy solutions often operate by binding the software license to the individual computer hardware by creating a hardware ID or thumbprint for the computer. Virtualization makes these solutions unreliable since the hardware is virtualized. The thumbprint can be edited or duplicated and thus the thumbprint can be exploited to copy or steal the software. For example a hardware profile snapshot used to activate a software application can be copied and used to illegally authorize additional copies. Furthermore typical server virtualization scenarios move the virtual machine from one host to another as needed. This can break software licensing solutions that bind to a hardware thumbprint.

Methods and systems are disclosed herein in which an inherited activation mechanism can be used to open a secure communication path from the host operating system OS to the guest OS. The license state of the software on the host may be passed through this channel and software installed in the guest may use this information to inform its own product activation process. The virtualized guest software may then activate without any outside communication when the license requirements for the host are met. Such a mechanism may be used to exchange activation information in a trusted manner between endpoints in a virtualized environment.

Activation may generally refer to technology that alters the functionality of software based on proof of purchase or some other event or action. In an embodiment an inherited activation mechanism may open a secure communication path from the host OS to one or more virtual machines. Licensing information including SKU license state and other data for software installed on the host may be passed through this channel and the guest may use this data to inform its own product activation process. For example when allowed by the installed licenses the OS installed in a guest may activate without any outside communication or user interaction when it receives proof that the host OS has been activated. Furthermore by inheriting the activation state of the host OS the guest OS can remain activated even when moved from host to host provided the host systems are properly activated.

Such an inherited activation mechanism may provide benefits for example to hosting providers and cloud computing vendors. With an inherited activation mechanism physical host computers can use any local infrastructure or other method for product activation. Virtual guests running on these hosts may inherit the activation data but will not need any visibility or access to the activation infrastructure used by the hosts. Sensitive data such as product keys need not be shared and customer assets can be protected.

In one embodiment the host OS may be configured to support an inherited activation mechanism. The host OS may gather or maintain license data for the OS itself and for any solution aware software. This data may be secured by the host OS and made available to running guest environments via a virtualization engine. This communication may be implemented as a query from the guest and response from the host. However the inherited activation mechanism is not limited to this communication model. The inherited activation mechanism may also support the license data being pushed unrequested from the host to the guest the data being presented as a readable table or other data store for ad hoc access and other communication models. The host may also use the inherited activation communications channel to pass policy information to the virtual machine.

The inherited activation mechanism is not limited to activating software applications in virtual machines. The mechanism may be used generally to activate virtual instances of a software application regardless of whether the application is executing in the context of a guest virtual machine partition. For example a web server may host virtualized sessions of Application X. Application X may also be installed locally and properly activated. The virtualized instances of Application X will remain activated when they are spawned by inheriting the license state of Application X on the host.

While the data being communicated can be secured to be trustworthy the inherited activation mechanism does not require a specific validation or encryption methodology. The communication path for exchanging the activation information can use secured methodologies such as PKI or a one way hash but any mechanism may be employed so long as the activation information is sufficiently trustworthy for the needs of the software publisher. In some embodiments the communication path may not employ a security mechanism if the application publisher does not require one. The security of the communication path may be a design decision made based on the needs of the application and the application publisher.

As described above the virtualization engine is the software on top of the host OS in which the virtual environment runs. In one embodiment the virtual engine may provide a secure channel for communication between the host OS and any running guest environments. Within the guest environment the guest OS may be configured to support the inherited activation functionality of the virtualization engine. This guest OS may be configured to allow access to the activation information via the virtualization engine to any software which supports inherited activation. This can include the OS itself as well as other applications.

For software on the host that supports inherited activation including the OS and other applications license specific data may be collected. The publisher of the software may determine which data is collected how the data is stored and secured and how the data is received and evaluated on the guest.

In typical software activation scenarios information may be collected and compared to rule sets embedded in XrML licenses or other trusted documents. These rule sets establish conditions that prove whether or not the software is properly licensed. Traditionally these conditions can include but are not limited to product keys connection to trusted hosts possession of secret information physical connection to crypto devices etc. The inherited activation mechanism may add to the scope of these rules by introducing the requirement that the system is running inside a virtual machine guest and that specific conditions exist that satisfy the licensing requirements. When these conditions are met the software may activate.

Events such as software start system boot login events or a timer can all start the process. To prevent theft activation may be frequently renewed. The frequency duration and trigger for any activation or reactivation may be determined by the software publisher.

In one embodiment the activation information may include a shelf life for the inherited activation. For example the information may include a time and date stamp that establishes an expiration for the activation. By using such an expiration an unauthorized copy of the activation information will have limited utility because of the time limited activation. Virtual machines using a trusted inherited activation can continue to receive updated shelf life information through the secured channel and thus continue to use the activated software as long as it is authorized to do so.

In an embodiment the host may use the exchanged information for asset management. For example the host can collect SKU data from the virtual machines and use the information to track the number of users of an application or service. This information may be used to manage and limit the overall number of activations.

In one illustrative example of an inherited activation mechanism depicted in a virtual machine host may implement a Virtual Service Provider VSP and a worker process for each virtual machine guest instance. The VSP may offer a connection to the virtual machine guest upon start up by leveraging the VMBus infrastructure . The VMBus infrastructure may expose an API set to allow communication between the root partition and the virtual machine guest. The host VSP may wait for a virtual machine guest client to connect and upon connection use the VMbus pipe handle to write and read data to and from the virtual machine guest . The VSP does not interpret the secure data read from the virtual machine guest but instead relays this data to the licensing application running on the host. Based on the information read from the virtual machine guest as well as the licensing state on the host machine a host licensing service creates a secure licensing state package which is returned to the VSP . The VSP writes this data back to the virtual machine guest through the VMBus pipe .

The guest virtual component of an inherited activation mechanism may be hosted inside the instance of the licensing application on the virtual machine guest. The client side component uses the VMBus infrastructure to enumerate connections from the host that matches a certain criteria which allows it to find and open a connection to the host VSP. This connection is exposed to the application in the guest virtual machine as a synthetic device. By using the APIs data can be read and written from and to the host via the synthetic device to exchange licensing related information. The license application running on the guest virtual machine uses the licensing state package which it obtains indirectly via the host VSP to determine if the guest virtual machine is properly licensed.

In one embodiment the inherited activation mechanism can be nested within a virtual machine architecture. For example a host virtual machine may send inherited activation information to a guest virtual machine. The guest virtual machine may in turn spawn one or more additional virtual machines each of which in turn may inherit the activation information and so on. In other embodiments the inherited activation mechanism may be configured to operate only with one host so that nesting of the activation information is not permitted.

The principles disclosed herein are not limited to the embodiments described above. The activation that is inherited need not be limited to a guest virtual machine. The inherited activation be used to activate a second virtualized instance of an activated product.

Any of the above mentioned aspects can be implemented in methods systems computer readable media or any type of manufacture. For example a computer readable storage medium can store thereon computer executable instructions for activating a software product in a virtualized computing environment. Such media can comprise a first subset of instructions for activating a first software product on a first parent partition in the virtualized computing environment wherein said activating is based on information derived at least in part on a configuration of said first parent partition a second subset of instructions for capturing said information and a third subset of instructions for using said information to activate a second software product in a child partition of the first parent partition. It will be appreciated by those skilled in the art that additional sets of instructions can be used to capture the various other aspects disclosed herein and that the presently disclosed subsets of instructions can vary in detail per the present disclosure.

The foregoing detailed description has set forth various embodiments of the systems and or processes via examples and or operational diagrams. Insofar as such block diagrams and or examples contain one or more functions and or operations it will be understood by those within the art that each function and or operation within such block diagrams or examples can be implemented individually and or collectively by a wide range of hardware software firmware or virtually any combination thereof.

It should be understood that the various techniques described herein may be implemented in connection with hardware or software or where appropriate with a combination of both. Thus the methods and apparatus of the disclosure or certain aspects or portions thereof may take the form of program code i.e. instructions embodied in tangible media such as floppy diskettes CD ROMs hard drives or any other machine readable storage medium wherein when the program code is loaded into and executed by a machine such as a computer the machine becomes an apparatus for practicing the disclosure. In the case of program code execution on programmable computers the computing device generally includes a processor a storage medium readable by the processor including volatile and non volatile memory and or storage elements at least one input device and at least one output device. One or more programs that may implement or utilize the processes described in connection with the disclosure e.g. through the use of an application programming interface API reusable controls or the like. Such programs are preferably implemented in a high level procedural or object oriented programming language to communicate with a computer system. However the program s can be implemented in assembly or machine language if desired. In any case the language may be a compiled or interpreted language and combined with hardware implementations.

While the invention has been particularly shown and described with reference to a preferred embodiment thereof it will be understood by those skilled in the art that various changes in form and detail may be made without departing from the scope of the present invention as set forth in the following claims. Furthermore although elements of the invention may be described or claimed in the singular the plural is contemplated unless limitation to the singular is explicitly stated.

