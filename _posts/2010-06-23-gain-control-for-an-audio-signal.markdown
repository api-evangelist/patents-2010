---

title: Gain control for an audio signal
abstract: A method and system for modifying an audio signal, the method comprising: receiving the audio signal at signal processing means; analysing the received audio signal to identify characteristic signal components in the audio signal; determining that another signal is input to the signal processing means, the input signal resulting from an activity which generates noise in the audio signal; and selectively applying an adjusted gain to the audio signal based on the determination that the input signal is input to the signal processing means, wherein the adjusted gain is generated in dependence upon the signal strength of the identified signal components.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09450555&OS=09450555&RS=09450555
owner: Skype
number: 09450555
owner_city: Dublin
owner_country: IE
publication_date: 20100623
---
This application claims priority under 35 U.S.C. 119 or 365 to Great Britain Application No. 0919673.4 filed Nov. 10 2009 and Great Britain Application No. 0920733.3 filed Nov. 26 2009. The entire teachings of the above applications are incorporated herein by reference.

This invention relates to gain control for an audio signal for example gain control for an audio signal comprising speech and noise.

An audio signal can be received at a computing system such as a personal computer or a telephone and the level of the audio signal can be adjusted by applying a gain to the audio signal. An Automatic Gain Control AGC mechanism can be used to automatically adjust the gain applied to the audio signal to ensure that the level of the audio signal is maintained within an acceptable range. The AGC mechanism effectively reduces the level of the audio signal if the received audio signal has a high signal strength and increases the level of the audio signal if the received audio signal has a low signal strength.

A user may enter into a call with another user such as a private call with just two users in the call or a conference call with more than two users in the call . The user s speech can be received at a microphone and then transmitted over a network to the other user s in the call. The audio signals received at the microphone will typically include speech components from the user and also noise from the surrounding environment. The AGC mechanism aims to adjust the gain applied to the audio signal based on the level of the received speech components of the audio signal without adjusting the gain based on the level of the noise in the received audio signal. In this way the level of the audio signal is automatically controlled such that the level of the speech in the audio signal is maintained within an acceptable range. In order to achieve this the AGC mechanism analyses the received audio signal to distinguish between speech components and noise. As part of this analysis AGC mechanisms often use some kind of signal classification in which specific characteristics of speech signals such as the pitch frequency spectral tilt zero crossing rate and other signal characteristics are used to identify components in the audio signal as speech components wherein only those identified components are used by the AGC mechanism to adjust the gain applied to the audio signal. In this way signal components such as background noise which do not have the specific characteristics of speech signals will not affect the adjustment of the gain applied to the audio signal.

The AGC mechanism is typically not perfect in identifying speech components in the received audio signal. For example if the AGC mechanism is too limited in the specific characteristics which are identified as speech components then fewer of the speech components in the audio signal will be identified as such resulting the in the AGC mechanism changing the level of the audio too slowly. On the other hand if the AGC mechanism is too broad in the characteristics which are identified as speech components then non speech sounds in the audio signal may be identified as speech components such that the level of the audio signal may be changed according to non speech signals which can be problematic.

When a user operates a computer noises are often generated. For example when a key on a computer keyboard is pressed there is a short mechanical sound i.e. a clicking sound . Similarly when the buttons on a mouse are pressed a clicking sound is produced. When a user is operating a peripheral device of a computer at the same time as partaking in a call the noise generated by the user s operation of the peripheral device may be included in the audio signal. For example clicking noise such as the sound from a key stroke on a keyboard might be picked up by the microphone. Keyboard tapping can be a problem for AGC mechanisms because the keyboard tapping can be mistaken for speech components in the audio. This can result in the AGC mechanism changing the level of the audio signal on the basis of the signal level of the keyboard taps in the audio signal.

In the case where the level of the keyboard tapping is lower than the level of the normal speech as received at the computing system but the keyboard tapping is audible and detectable and is mistaken for speech the AGC mechanism might increase the gain so that the level of the keyboard tapping is amplified to be within the acceptable range for speech signals. The keyboard tapping can then interfere with usage of the audio signal for example the amplified keyboard tapping can be quite disturbing for other users in a call. The gain applied by the AGC mechanism is therefore higher than is needed for the speech of the user such that when the user starts speaking his speech would be amplified more than normal which could interfere with the call. If the level of the speech is amplified too much the speech may overload the system resulting in clipping and or the need for compression o the speech signal which both will distort the speech. The AGC mechanism would have to reduce the gain to be better suited for the input speech level. This will take some time and during that time the level of the speech in the audio signal will be above the acceptable level which may disrupt the call.

Conversely in the case where the level of the keyboard tapping is higher than the level of the normal speech as received at the computing system such as in a laptop in which the microphone and the keyboard are integrated into the laptop body and the generated noise is mistaken as speech the AGC mechanism might decrease the gain so that the level of the keyboard tapping is reduced to be within the acceptable range for speech signals. When the user then speaks his speech will not be amplified sufficiently to fall within the acceptable range i.e. the speech might have a worse than necessary signal to quantization noise ratio . The AGC would then need to increase the gain to bring the level of the speech up to within the acceptable range. This will take some time and during that time the level of the speech in the audio signal will be below the acceptable level range which may disrupt the call. In an extreme case the gain applied by the AGC mechanism will be reduced so much due to the keyboard tapping that the speech will be too quiet to be identified as speech and so the AGC mechanism will be unable to increase the gain when the user is speaking and the call might not be able to continue because the speech cannot be heard without some kind of human intervention such as resetting the gain level manually.

One approach for reducing the effect of keyboard tapping on the gain level of the AGC mechanism is to use specific keyboard noise attenuation algorithms for attenuating keyboard noise. By attenuating the keyboard noise it is less likely that the keyboard noise will be mistaken for speech in the audio signal. Keyboard noise attenuation algorithms analyse the audio signal received at the microphone to detect and filter out components of the audio signal that are perceived to be keyboard clicking noise. However keyboard noise attenuation algorithms tend to introduce delay in the signal path if they are to reliably detect and attenuate keyboard tapping. Furthermore the keyboard attenuation algorithms will not typically be perfect such that some keyboard tapping is undetected and will therefore affect the gain applied by the AGC mechanism. Furthermore the detection and attenuation of keyboard tapping from the audio signal introduces additional computational complexity which can use up valuable processing resources in the computing system.

There is therefore a problem of applying a gain with an AGC mechanism to an audio signal received at a computing system in the presence of noise in that the noise in the audio signal can be mistakenly identified as speech resulting in inappropriate adjustment of the gain to be applied by the AGC mechanism.

In a first aspect of the invention there is provided a method of modifying an audio signal the method comprising receiving the audio signal at signal processing means analysing the received audio signal to identify characteristic signal components in the audio signal determining that another signal is input to the signal processing means the input signal resulting from an activity which generates noise in the audio signal and selectively applying an adjusted gain to the audio signal based on the determination that the input signal is input to the signal processing means wherein the adjusted gain is generated in dependence upon the signal strength of the identified signal components.

In a second aspect of the invention there is provided a computing system for modifying an audio signal the computing system comprising receiving means for receiving the audio signal input means for generating an input signal signal processing means for analysing the received audio signal to identify characteristic signal components in the audio signal and for determining that the input signal is input from the input means the input signal resulting from an activity which generates noise in the audio signal and gain control means for selectively applying an adjusted gain to the audio signal based on the determination that the input signal is input from the input means the adjusted gain being generated in dependence upon the signal strength of the identified signal components.

The problem of noise generated by the operation of input devices affecting the applied gains is addressed without adding any significant computational complexity. This is achieved by cancelling or reverting adjustments made by the AGC mechanism at times when noise generating activity is carried out on an input device. It is determined that the noise generating activity is carried out using event signaling obtained from the operating system of the computing system.

The operating system is typically informed of the presence of an input signal from a device driver associated with the input device at which the input signal is generated. Where the input signals are generated by a process that generates noise that noise may be picked up at the microphone such that it is included in the audio signal. Without analysing the received audio signal and without performing computationally complex operations on the audio signal the operating system of the computing system can report that the generated noise is likely to be present in the received audio signal by using the input signals received at the computing system. Any adjustments made by the AGC during a time period in which the noise generating activity is occurring are cancelled or reverted. In this way adjustments to the gain applied to the audio signal can only be made based on the audio signal received during periods in which no input signals are received which are associated with noise generating activities. The input signals are not audio signals. The input signals could be electrical signals but the signals could also be transmitted over a wireless connection. A software driver associated with the input device typically determines that the input signal has been generated and sends a message to the operating system to inform the operating system that the input signal has been generated.

Reference is first made to which illustrates a communication system such as a packet based P2P communication system. A first user of the communication system User A operates a user terminal which is shown connected to a network . The communication system utilises a network such as the Internet. The user terminal may be for example a personal computer PC including for example Windows Mac OS and Linux PCs a mobile phone a personal digital assistant PDA a television a remote control a gaming device or other embedded device able to connect to the network . The user device is arranged to receive information from and output information to a user of the device. The user terminal comprises a microphone for receiving audio signals. In a preferred embodiment the user device comprises a display such as a screen and input devices such as a keyboard mouse keypad buttons joystick and or touch screen.

The user terminal is running a communication client provided by a software provider. The communication client is a software program executed on a local processor in the user terminal .

The user terminal also includes microphone analogue to digital converter block buffer pre processor block and digital gain block . The pre processor block comprises analogue gain control means and digital gain control means . An output of the microphone is connected to an input of the analogue to digital converter block . An output of the analogue to digital converter block is connected to an input of the buffer . An output of the buffer is connected to an input of the pre processor block . An output of the pre processor block is connected to an input of the digital gain block . An output of the analogue gain control means is connected to an input of the analogue to digital convert block . The pre processor block and the digital gain block are implemented in software and are executed on the CPU . In some embodiments the pre processor block and the digital gain block are part of the client engine software block running on the CPU . The analogue to digital converter block and the buffer reside on a sound card in the computing system not shown in the Figure . The CPU analogue to digital converter block buffer pre processor block digital gain block and any drivers of the input means can be considered signal processing means of the user terminal .

With reference to there is now described a process for applying gain to an audio signal according to a first embodiment using the user terminal shown in . In step S an audio signal is received at the microphone of the user terminal . The audio signal may include speech from User A and may be for use in a communication event such as a call with User B over the network . The audio signal typically also includes noise. For example the acoustic noise that pressing a key on the keyboard generates will be captured by the microphone when the sound pressure wave has travelled the distance between the keyboard and the microphone . The keyboard and the microphone are generally both in close proximity to the user and so will typically be no more than 1 meter apart in which case the noise generated by the key stroke will typically arrive at the microphone less than 3 ms after the key is pressed on the keyboard . The audio signal received at the microphone passes to the analogue to digital converter block and is converted from the analogue domain to the digital domain. The audio signal is then passed to the buffer where it is stored.

The pre processor block reads the audio signal from the buffer . In step S the pre processor block analyses the audio signal to identify speech components. That is to say signal components having speech characteristics are identified in the audio signal. In step S the pre processor block generates an adjusted gain based on the signal strength of the identified components in the audio signal. The adjusted gain may be an analogue adjusted gain as determined by the analogue gain control means . Analogue gain is applied to the audio signal when the audio signal is in the analogue domain for example in the analogue to digital converter block as represented in the Figure with the arrow between the analogue gain control means and the analogue to digital converter block . Alternatively the adjusted gain may be a digital adjusted gain as determined by the digital gain control means . Digital gain is applied to the audio signal when the audio signal is in the digital domain for example in the digital gain block . In some scenarios the adjusted gain may comprise both an analogue adjusted gain to be applied to the audio signal in the analogue domain and a digital adjusted gain to be applied to the audio signal in the digital domain. The time delay between receiving the audio signal at the microphone and the generation of the adjusted gain in the pre processor block is a time tand is typically in the range 5 30 ms. This time delay is primarily due to the buffering of the audio signal in the buffer .

The audio signal passes from the pre processor block to the digital gain block . In step S the digital gain block applies digital gain to the audio signal. Where an adjusted digital gain has been generated in the pre processor the adjusted digital gain is applied to the audio signal. Where an adjusted digital gain has not been generated an unadjusted digital gain is applied to the audio signal in the digital gain block . The unadjusted digital gain is the digital gain applied by the digital gain block at the time when the audio signal is received at the microphone . This means that the unadjusted digital gain is the digital gain that has been previously generated in the pre processor block based upon the signal strength of the identified speech components in previously received portions of the audio signal. In this way the unadjusted digital gain is unaffected by portions of the audio signal received after the input signal is input to the computing system.

Similarly in step S where an adjusted analogue gain has been generated in the pre processor block the analogue to digital converter block is instructed to apply the adjusted analogue gain to portions of the audio signal that are subsequently received. Where an adjusted analogue gain has not been generated the analogue to digital converter block continues to apply the same analogue gain as it was applying before the audio signal was received i.e. an unadjusted analogue gain. The unadjusted analogue gain is the analogue gain that has previously been generated in the pre processor block based upon the signal strength of the identified speech components in previously received portions of the audio signal. In this way the unadjusted analogue gain is unaffected by portions of the audio signal received after the input signal is input to the computing system.

When it is necessary to alter the gain applied to the signal quickly altering the digital gain is often preferable to altering the analogue gain. The process of altering the digital gain takes less time than that of altering the analogue gain.

So in step S the adjusted gain which may be analogue gain digital gain or both is applied to the audio signal.

In step S it is determined at the operating system whether input signals have been input at a device or input means connected to the CPU such as the keyboard or the mouse . The input signals are not audio signals. The input signals indicate data from the device for example the input signals may represent key strokes on the keyboard . The input means which inputs the input signals to the CPU is not the microphone and does not receive audio signals. The input signals are typically caused by activity on the input means connected to the user terminal . Device drivers associated with the input device detect the generation of the input signal and inform the operating system of the input signal. For example keyboard activity on the keyboard will produce input signals to the operating system as the keys are pressed. When the keys on the keyboard are pressed audible clicking noise will be generated and this clicking noise may contribute to the noise in the audio signal received at the microphone . Operating systems generally allow software to monitor activity on inputs such as keyboard activity. One way to allow this is to look for events that are sent out by the operating system. Another way of detecting the input signals is with an Application Programming Interface API which allows the state of the input to be accessed for example the state of each key of the keyboard can be accessed through an API. By using such an API the pre processor block can be informed if a key is pressed. It is determined whether any of the detected inputs will generate noise that may be included in the audio signal received at the microphone and in that way it is determined whether noise generating activity is present at the input devices. This determination of whether noise generating activity is present does not rely on analysing the received audio signal and therefore avoids computationally complex signal processing.

The determination by the operating system that input signals have been generated on an input device takes a time twhich is typically within the range 50 to 100 ms from the time that the input signal is input to the computing system. It is apparent that the delay t involved in detecting an input signal 50 to 100 ms is greater than the delay t involved in generating the adjusted gain 5 to 30 ms as described above. Therefore where a noise generating activity causes an input signal to be generated e.g. a key is pressed on the keyboard the gain is adjusted and applied before the input signal is detected by the operating system. Therefore if noise generating activity is determined to be present in step S then the method passes to step S in which any gain adjustments made within a time period tbefore the detection of the input signal are reverted. In other words the gain applied to the signal both analogue and digital gain is reverted back to the unadjusted gain i.e. the gain that was applied a time tago discarding any gain adjustments that have been made since that time. The method then ends in step S. If no noise generating activity is present as determined in step S then the method passes straight from step S to step S without reverting any gain adjustments i.e. without performing step S.

With reference to there is now described a process for applying gain to an audio signal according to a second embodiment. Steps S to S correspond to steps S to S of the first embodiment described above with reference to . That is in step S an audio signal is received at the microphone of the user terminal . In step S speech components in the audio signal are identified and in step S adjusted gains are generated.

However in the second embodiment the adjusted gain is not applied as soon as it is generated. Instead the adjusted gain is only applied if it is subsequently determined that no noise generated by an activity resulting in an input signal to the user terminal is present in the audio signal. As described above the time taken to generate the adjusted gain tis typically shorter than the time taken to determine that an input signal has been input which is associated with a noise generating activity t. The method will wait for a time of at least tfrom receiving the audio signal before applying an adjusted gain which has been generated based on the received audio signal. This is achieved with the following steps S to S.

In step S it is determined whether noise generating activity is present based on the detection of input signals to the operating system . This is achieved in the same way as that described above in relation to step S of the first embodiment. If it is determined that noise generating activity is not present in step S then the method passes to step S. The time ttaken for the operating system to determine whether noise generating activity is present is known. In step S an adjusted gain generated based on audio signals received at the microphone at a time which is at least tago is applied. In this way the adjusted gain is applied after time t allowing time for it to be determined in step S that no noise generating activity is present in the audio signal on which the adjusted gain has been generated. Following step S the method ends in step S wherein the adjusted gain will be applied to subsequent audio signals received at the microphone .

If in step S it is determined that noise generating activity is present in the audio signal that was received a time tago then any adjusted gain that has been generated based on the audio signal that was received a time tago will not be applied to the audio signal. Instead the unadjusted gain i.e. the gain applied to the audio signal before the time at which the input signal was generated is applied to the audio signal. As described above the gain can comprise one or both of analogue gain and digital gain. Following step S the method ends in step S and the adjusted gain generated in step S is not applied to the audio signal.

The first embodiment described above in which gain adjustments are applied in step S when they are generated but then are reverted in step S if an input signal is detected is particularly suited for adjusting the digital gain applied by the digital gain block . A delay is undesired when applying the digital gain because a delay will interfere with the fast reacting properties that the digital gain block is required to possess. Applying adjusted digital gains and then reverting the digital gain adjustments when an input signal is detected will avoid adding unnecessary delay at the digital gain block . This will ensure that when input signals are detected any adjustments made on the basis of the noise generated by activity causing the input signal will be reverted i.e. the digital gain is set to that used before the input signal was generated. That is where there has been speech in the audio signal prior to the generation of the input signal the digital gain is based on speech signals that were received at the microphone prior to the generation of the input signal.

However the second embodiment described above in which gain adjustments are delayed before being applied is particularly suited for adjusting the analogue gain applied by the microphone which applies its gain before converting the signal from analogue to digital representation. In this case a delayed reaction enables gain adjustments generated in the pre processor block to be cancelled before being sent as a request to the operating system for changing the analogue gain setting in the microphone . The request to change the analogue gain settings can sometimes cause stalls and should be done only when considered necessary. Therefore the second embodiment in which a delay is added will have the desirable property of reducing the number of calls to the operating system requesting a new analogue gain setting.

It is possible to apply the process of the first embodiment for adjusting digital the gain and at the same time apply the process of the second embodiment for adjusting analogue the gain.

In the embodiments described above both an analogue gain using analogue to digital converter block and a digital gain using digital gain block are applied to the audio signal. In other embodiments only an analogue gain is applied to the audio signal. In still other embodiments only a digital gain is applied to the audio signal. In some embodiments the analogue gain may be applied using the microphone rather than the analogue to digital converter block .

In alternative embodiments to those described above the analysis of the audio signal to identify components having speech characteristics may be performed by means other than the pre processing block as would be apparent to a person that is skilled in the art.

The present invention is able to reliably revert any gain adjustments that are made by the AGC mechanism during times at which keyboard tapping or other noise generating activity which generates input signals detectable by the operating system is present. Any gain adjustments made within a time period less than 100 ms before the detection of the input signal may be reverted or not applied at all. The present invention does not rely on computationally expensive signal processing for detection of the generated noise and instead a polling function in the operating system notifies the AGC mechanism when the input signals are detected.

The present invention chooses between reverting any gain adjustments that were performed during times of detected keyboard tapping or adding a delay to the gain adjustments and cancelling adjustments that were generated during times of detected keyboard tapping such that the adjustments are not applied.

The signal processing means of the user terminal is used to analyse the received audio signal to identify signal components having speech characteristics in the audio signal and to determine that the input signal is input from the input means. Another input to the signal processing means may be from a fan or hard disk of the user terminal not shown in the figures . When the fan is switched on it will generate noise which may be picked up by the microphone . Similarly when the hard disk is operated it will generate noise which may be picked up by the microphone . The signal processing means can use input signals from the fan and the hard disk respectively to determine when the fan and or the hard disk are in use. In some embodiments the signal processing means can use the input signal from the fan and or hard disk in same way as an input signal from the keyboard or the mouse . In this way any adjustments made to the gain applied to the audio signal while the fan and or hard disk are generating noise can be cancelled or reverted in the same way as described above in relation to adjustments made when an input signal is input to the signal processing means from the keyboard or the mouse .

In the embodiments described above the audio signal is a speech signal comprising components having speech characteristics. In alternative embodiments the audio signal may be a different type of audio signal having different characteristic signal components. In those alternative embodiments the gain applied to the audio signal can be adjusted based on the signal strength of the characteristic signal components in the audio signal. Noise generated as a result of producing an input signal such as keyboard tapping might affect the gain applied to the audio signal. In the same way as described above in relation to a speech signal the affect of the generated noise on the applied gain can be advantageously reduced for the different types of audio signal. For example the audio signal may include music and the characteristic components may include sounds produced by one or more instruments.

In the embodiments described above the adjustments made to the gain during periods of noise generating activity resulting in input signals to the computing system are either cancelled before they are applied or reverted once the input signal is determined. However in alternative embodiments some of the adjustments made to the gain e.g. during periods of keyboard tapping may be applied. For example the changes made to the gain may be reduced in magnitude i.e. the gain change is only partially applied. This can be advantageous if the computing system is not sure whether a received audio signal is a keytap or speech. The decision of how large a part of the gain change to apply immediately may be dependent on one or more signal classification methods. Furthermore the gain may be adjusted during the periods in which input signals such as keytaps are received at the computing system but the gain may only be reduced during such periods. Alternatively the gain may only be increased during such periods.

While this invention has been particularly shown and described with reference to preferred embodiments it will be understood to those skilled in the art that various changes in form and detail may be made without departing from the scope of the invention as defined by the appendant claims. In particular the invention is described above in relation to the use of audio signals in a call between users over a P2P communication system but the invention may be equally applied to audio signals for use in other scenarios as would be apparent to a skilled person.

