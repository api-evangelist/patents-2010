---

title: Subscriber-based network traffic management
abstract: In general, the invention is directed to techniques for offloading per-subscriber traffic management from an access gateway to one or more upstream service nodes within a service provider network. For example, as described herein, an upstream service node receives a new packet flow for a subscriber and sends packet flow information, such as a network address, to a session and resource controller (SRC). The SRC maintains a table of subscriber attachment sessions and maps the packet flow information to a subscriber attachment session in the table to obtain a subscriber identifier for a subscriber. The SRC then determines subscriber-specific services to be applied to subscriber data traffic, transforms the services to a set of one or more enforcement policies, and returns the enforcement policies to the service node. In turn, the service node applies the enforcement policies for the subscriber-specific services to the subscriber data traffic in the packet flow.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08675488&OS=08675488&RS=08675488
owner: Juniper Networks, Inc.
number: 08675488
owner_city: Sunnyvale
owner_country: US
publication_date: 20100907
---
The invention relates to computer networks and more particularly to managing traffic within computer networks.

A network service provider offers services to subscribers that access a service provider core network using an access network. Services offered may include for example traditional Internet access Voice over Internet Protocol VoIP video and multimedia services and security services. The service provider network may support multiple types of access network infrastructures that connect to service provider network access gateways to provide access to the offered services.

Because the access gateways are positioned near the edge of the service provider network directly upstream from the subscribers and operate to provide an operational endpoint i.e. terminate the subscriber connections e.g. digital subscriber line or cable based connections into the service provider network the access gateways typically provide mechanisms for identifying subscriber traffic and providing subscriber specific services. For example the access gateways may include an integrated authentication authorization and accounting AAA component with which to authenticate individual subscribers. Conventionally the access gateways associate network traffic with a subscriber identity to map predefined policies for the subscriber or subscriber class to the associated network traffic. The access gateways then apply the subscriber policies to manage subscriber traffic on a per subscriber basis as such traffic traverses the service provider core network boundary.

In general this disclosure describes techniques for offloading per subscriber traffic management from the access gateways to one or more upstream service nodes within the service provider network. Heterogeneous access networks connect many thousands of subscribers to any number of access gateway types such as Broadband Remote Access Servers BRASs Cable Modem Termination Systems CMTSs and Gateway GPRS Support Nodes GGSNs that may have varying capabilities and scalability limitations and yet face ever increasing demands for both subscriber connection management and subscriber specific traffic management services. Although an access gateway as a connection terminus and thus a transport node for all subscriber traffic for a particular subscriber device is an established location at which to perform subscriber specific traffic management services coupling subscriber access and traffic management at an access gateway may restrict or prevent independent scaling and independent optimization of these disparate functions.

In accordance with the techniques described herein a service provider deploys one or more intermediate service nodes in the service provider SP network upstream from the access gateways to route traffic through the network. Although in some embodiments the service nodes provide a generalized layer three L3 forwarding infrastructure the service nodes include additional functionality that allow the service nodes to easily be dynamically configured by other components within the service provider network to apply services to subscriber traffic based on the subscriber identity. The service nodes are decoupled from the subscriber access management functions and thus may be optimized for service processing. The service nodes may implement the services as a set of enforcement policies selectively associated with a subscriber and or subscriber class.

Subscriber devices attach to the SP core network via an access network in an attachment session i.e. a communication session that couples a subscriber device to an access gateway to provide access to the SP core network. A session and resource controller SRC stores a description of each of the active attachment sessions upon receiving such descriptions from the access gateways via an access gateway manager. The description includes for each active subscriber session a subscriber identity and an IP address for the subscriber device. In addition the SRC maps a respective set of services to each of the subscribers that the service nodes are to apply to traffic for the subscriber.

To identify a subscriber to associate with subscriber traffic the service nodes employ a packet triggered subscriber and policy control PTSP interface to signal to the SRC when a particular service node detects a new packet flow. The SRC receives details of the new packet flow and associates the new packet flow with a subscriber identity when the subscriber has an active attachment session. The SRC then creates a subscriber session instantiates the services mapped to the subscriber as service sessions for the subscriber and installs policies for the respective service sessions to the service node handling the new packet flow. The service node thereafter applies the policies to manage the new packet flow in a subscriber specific manner. For example the policies may cause the service node to selectively redirect subscriber data traffic for a particular subscriber toward or away from a services complex that applies a service to the subscriber data traffic. In some instances an application server may interface with the SRC to direct the SRC to dynamically instantiate a new service for a subscriber and cause the service nodes to apply the new service.

In one embodiment the invention is directed to an intermediate network device for providing subscriber specific services upstream from an access network the intermediate network device comprising a network interface to exchange with a layer three L3 access device of an access network a plurality of packet flows that each carry subscriber data traffic for a respective one of a plurality of subscribers. The intermediate network device further comprises a packet triggered subscriber and policy interface PTSP client to send packet flow information for a first one of the packet flows to a session and resource controller SRC wherein the packet flow information comprises a network address for a subscriber device that operates as an end point of the first packet flow wherein the PTSP client receives from the SRC responsive to sending the packet flow information an enforcement policy wherein the enforcement policy represents a subscriber specific service mapped to the network address by the SRC. The intermediate network device also comprises a services unit to apply the enforcement policy to first subscriber data traffic carried by the first packet flow.

In another embodiment the invention is directed to a session and resource controller SRC comprising a session repository to store an attachment sessions table and a service sessions table wherein the attachment sessions table comprises one or more subscriber attachment records that each map a network address to a subscriber identifier and wherein the service sessions table comprises one or more service sessions records that each map a service to a subscriber identifier. The SRC further comprises a subscriber attachment front end to receive attachment notification messages for a plurality of subscribers wherein each attachment notification message includes a mapping of a respective network address to a respective subscriber identifier and wherein the subscriber attachment front end stores the mappings to the attachment sessions table as subscriber attachment records. The SRC also comprises a service activation engine to receive from one or more intermediate network devices network addresses that each characterizes a packet flow traversing one of the intermediate network devices wherein the service activation engine upon receiving a first network address from a first one of the intermediate network devices queries the attachment sessions table using the first network address to obtain a first subscriber identifier mapped to the network address queries the service sessions table using the first subscriber identifier to obtain a subscriber specific service to apply to the packet flow characterized by the first network address and sends service information for the subscriber specific service to the first intermediate network device to cause the first intermediate network device to apply the subscriber specific service to subscriber data traffic carried by the packet flow characterized by the network address.

In another embodiment the invention is directed to a method for applying policies with an intermediate network device to subscriber data traffic comprising the steps of exchanging with a layer three edge device situated between the intermediate network device and an access network a plurality of packet flows that each carry subscriber data traffic for a respective one of a plurality of subscribers. The method also includes the step of sending packet flow information for a first one of the packet flows from the intermediate network device to a session and resource controller wherein the packet flow information comprises a network address for a subscriber device that operates as an end point of the first packet flow. The method further comprises the step of receiving an enforcement policy with the intermediate network device from the session and resource controller wherein the enforcement policy represents a subscriber specific service mapped to the network address. The method further comprises the step of applying the enforcement policy with the intermediate network device to first subscriber data traffic carried by the first packet flow.

In another embodiment the invention is directed to a method comprising the steps of receiving with a session and resource controller SRC an attachment notification message from a first network device wherein the attachment notification message maps a network address to a subscriber identifier. The method also includes the steps of receiving with the SRC from a second network device a network address that characterizes a packet flow traversing the second network device and mapping the network address to the subscriber identifier. The method also includes the steps of determining a subscriber specific service to apply to subscriber data traffic for a subscriber identified by the subscriber identifier and sending service information for the subscriber specific service to the second network device to cause the second network device to apply the subscriber specific service to the subscriber data traffic carried by the packet flow for the subscriber.

In another embodiment the invention is directed to a system. The system comprises an access gateway of a service provider network a session resource controller and first and second intermediate network devices of a service provider network located upstream from the access gateway in the service provider network the first and second intermediate network devices each comprising a network interface to exchange a respective packet flow for a subscriber with the access gateway a packet triggered subscriber and policy control client to send packet flow information that characterizes the packet flow to the session resource controller and to receive an enforcement policy for packet flow and a service unit to apply the enforcement policy to the packet flow. The session resource controller comprises an attachment sessions table comprising one or more attachment session records that each map packet flow information to a subscriber identifier. The session resource controller also comprises a service sessions table comprising one or more service session records that each map a service to a subscriber identifier. The session resource controller also comprises a service activation engine to receive packet flow information from the first intermediate network device and to receive identical packet flow information from the second intermediate network device wherein the service activation engine uses the packet flow information to determine a subscriber identifier from the attachment sessions table wherein the service activation engine uses the subscriber identifier to determine a subscriber specific service from the service sessions table wherein the service activation engine sends an enforcement policy for the subscriber specific service to the first and second intermediate network devices and wherein the respective service units of the first and second intermediate network devices apply the enforcement policy to subscriber data traffic carried by the respective packet flow for the subscriber.

The techniques herein described may provide one or more advantages. For example decoupling traffic management from subscriber access management may allow independent scaling and development of the network resources that perform these respective functions. This may allow the service provider to offer additional services and yet avoid increasing the demand on access gateways which may otherwise require upgrading or replacing the gateways. In addition by pushing traffic management from the SP network edge to the service nodes the techniques support load balancing and redundant network paths for subscriber traffic. For while different packet flows for a particular subscriber may traverse multiple service nodes because of load balancing or redundancy for example the service nodes may nevertheless handle each of the packet flows on a per subscriber basis. Moreover the techniques may enable the service nodes to selectively redirect subscriber traffic along preferred network paths based on subscriber identity traffic characteristics and or subscriber device properties.

The details of one or more embodiments of the invention are set forth in the accompanying drawings and the description below. Other features objects and advantages of the invention will be apparent from the description and drawings and from the claims.

User equipment A N UE attach to SP network via access network to obtain services offered by SP network to subscribers. UE are subscriber devices and may each comprise for example a mobile phone a smart phone a desktop laptop computer a gaming console a video conferencing suite a workstation a wireless device a network ready appliance a file server print server a digital subscriber line DSL router a cable modem or another device with which to access services of SP network . A subscriber may represent for instance an enterprise a residential subscriber or a mobile subscriber. UE connect to access network via access links that comprise wired and or wireless communication link. The term communication link as used herein comprises any form of transport medium wired or wireless and can include intermediate nodes such as network devices. Each of access links may comprise for instance aspects of an asymmetric DSL network WiMAX a T 1 line an Integrated Service Digital Network ISDN or wired Ethernet.

Access network represents a network that aggregates data traffic from one or more subscribers for transport to from core network of SP network . Access network includes network nodes that execute communication protocols to transport control and user data to facilitate communication between UE and core network . Access network may comprise for example digital subscriber line access multiplexers DSLAM switches edge routers broadband remote access servers BRAS a gateway general packet radio service GPRS support node GGSN and other GPRS support node GSNs a Universal Mobile Telephone System UMTS having a UMTS Terrestrial Radio Access Network UTRAN and or a 3GPP Long Term Evolution LTE mobile access network employing for instance service gateways packet data network PDN gateways and eNodeBs. The elements of access network may support a variety of protocols such as Internet Protocol IP Frame Relay Asynchronous Transfer Mode ATM Ethernet Point to Point Protocol PPP Point to Point Protocol over Ethernet PPPoE GPRS tunneling protocol GTP among others. UE may have a dedicated subscriber interface e.g. an ATM virtual circuit VC or an Ethernet virtual local area network VLAN to access network .

A network service provider that administers SP network offers services to subscribers e.g. UE that access the service provider network. Services offered may include for example traditional Internet access Voice over Internet Protocol VoIP video and multimedia services and security services. Core network may support multiple types of access network infrastructures that connect to service provider network access gateways to provide access to the offered services.

Core network may represent a public network that is owned and operated by a service provider to interconnect a plurality of networks such as access network . Core network may implement Multi Protocol Label Switching MPLS forwarding and in such instances may be referred to as an MPLS network. In some instances core network represents a plurality of interconnected autonomous systems such as the Internet that offers services from one or more service providers.

Transport links couple service nodes to access network and core network . Service nodes may thus be considered as located behind the access network. All network traffic exchanged between access network and core network traverses at least one of service nodes . Service nodes and or transport links may constitute part of a backhaul network which may include land based transmission lines frequently leased by a service provider to transport data and control traffic between access network and core network . The backhaul network typically also includes switches aggregation devices and routers. In some embodiments service nodes constitute part of core network as intermediate network devices to transport packets between access network and other parts of core network .

Session and resource controller SRC of SP network ties the service layer to the network layer by applying policy and control functions to network traffic. Such policy and control functions may include for example policy management subscriber management and authentication authorization and accounting AAA as well as bandwidth management and network resource control. SRC maintains directories of subscriber profiles network resources policies and service configuration information that the SRC then uses to provision services and determine policies for subscribers. In some embodiments SRC is located within core network . SRC is a networked device and may comprise for instance a server a controller a service blade within or software executing on a router or other network device or a collection of such components.

In accordance with the techniques of this disclosure service nodes apply services to subscriber data traffic based on an identity of the subscriber. Such services may include forwarding filtering rate limiting marking accounting policy based routing and redirection advertisement insertion and traffic shaping for instance. Service nodes may comprise a network edge or core router that routes network packets to from access network . In some embodiments service nodes comprise one or more MX series routers manufactured by Juniper Networks Inc. of Sunnyvale Calif.

In another embodiment service nodes comprise a switching device that forwards layer two L2 traffic based on for example MAC layer addresses. L2 traffic may include Ethernet frames addressable by MAC layer addresses that may be used in accordance with the techniques herein described to identify a subscriber or subscriber class.

When one of UE attaches to SP network using access network SRC receives from access network a subscriber identity for the attached UE as well as an associated network address e.g. an IP address that the attached UE uses to source and receive subscriber data traffic to from SP network . SRC stores the subscriber identity and associated network address as a record of a currently active attachment session.

Any attached one of UE may begin exchanging data packets with core network and such packets traverse at least one of service nodes as members of at least one packet flow. The term packet flow refers to a set of packets originating from a particular source device and sent to a particular destination device as part of an application communication session between the source and destination device. A flow of packets in either the upstream sourced by UE or downstream destined for UE direction may be identified by the five tuple . This five tuple generally identifies a packet flow to which a received packet corresponds and depending on the flow direction a subscriber may be associated with either the source network address or the destination network address of the flow. Service nodes may identify an application using deep packet inspection DPI .

While service nodes may identify a new subscriber network address due to detection of a new packet flow a packet flow alone does not identify the subscriber associated with the subscriber network address. Therefore when one of service nodes detects a new packet flow the service node sends a network address of the packet flow that represents the subscriber to SRC via one of communication links . SRC associates a network address received from one of service nodes with a subscriber identity for a currently active attachment session. For example SRC uses the received network address to key into an active attachment session table maintained by SRC and comprising records for each of the active attachment sessions within SP network to obtain an associated subscriber identity for the network address.

SRC uses the subscriber identity to determine a subscriber profile to identify services that service nodes are to apply to the new packet flow. SRC translates any identified services to enforcement policies and sends the policies to the service node that transports the new packet flow. An enforcement policy includes a set of actions that a service node is to perform upon the occurrence of a condition that characterizes the packet flow in some way. For example a condition may relate to an application protocol or other application information or a source address. The actions implement the various exemplary services listed above that service nodes apply to subscriber data traffic. Upon receiving the policies the service node applies the subscriber specific enforcement policies to the new packet flow. In this way service nodes apply policies to packet flows based on the identity of the subscribers associated with the packet flows.

The described techniques may allow the AAA and other subscriber attachment functions performed by access network to be decoupled from application of various services to subscriber data traffic. That is by using SRC to maintain subscriber profiles and service information the techniques enable service nodes to avoid unnecessarily storing and managing subscriber service and other configuration information for subscribers that are not attached to SP network and services that are not instantiated by service nodes . As a result service nodes may handle each of the packet flows on a per subscriber basis despite a logical and geographical separation from access network . Service nodes may thus scale independently of access network components and thereby relieve infrastructure pressures on access network due to compounding service requirements for an increasing number of subscribers. In addition the described techniques may enable the service provider to distribute subscriber traffic to a plurality of service nodes and nevertheless apply services to the traffic on a per subscriber basis using the service nodes.

UE connect via access network to core network which transports data and control packets for services provided by application server . Exemplary services offered by application server include video and multimedia content services a VoIP service a bulk data delivery service web applications web services and or other applications. Application server connects to core network via one of application gateways A B application gateways which may each comprise for example a provider edge router.

Application gateways may be configured differently by a service provider or by another entity to apply different services to subscriber data traffic traversing the respective gateway. For example application gateway A may forward subscriber data traffic to a service complex that tailors the application data carried by the traffic to UE . As a result a service provider may provide differential services to subscriber data traffic that traverse core network .

Access gateway is a layer three network edge device that manages subscriber attachment sessions and routes subscriber data traffic to application gateways via service nodes . Access manager authenticates subscriber devices on behalf of access gateway authorizes the devices to access core network and provides network configuration information to the devices. When one of UE attempt to attach to core network access gateway authenticates the user equipment by interfacing to access manager using a AAA protocol such as Remote Authentication Dial In User Service RADIUS or the Diameter protocol to authenticate the subscriber device or a user thereof. Access manager may respond by assigning a network address to one of UE as part of an authentication authorization process. Access gateway comprises for example a GGSN an edge router such as a BRAS a CMTS a switch or another network device. Access manager may comprise a RADIUS server a Diameter server or other authorization device.

Upon granting access to one of UE access gateway sends attachment notification message to access manger which relays the message as attachment notification message to subscriber attachment front end of SRC . In this way SRC becomes aware of a new attachment session participated in by the newly attached UE. Attachment notification message includes information with which to identify a subscriber that has attached to core network and to associate the subscriber with a network address that is routable within core network . In some instances attachment notification message includes information with which to identify a subscriber class in which the newly attached subscriber is a member. Attachment notification message may also include other information to characterize an attachment session such as available bandwidth.

Subscriber identification information may include for example a user name an international mobile subscriber identity IMSI a device type identifier such as an international mobile equipment identity IMEI an access type identifier an integrated services digital network ISDN number or an access point name APN . To associate the subscriber or subscriber class with a routable network address attachment notification message also includes a network address for the attached subscriber such as an IPv4 or IPv6 network address. In embodiments of core network that provide VPN services where the newly attached one of UE participates in a VPN attachment notification message includes a VPN identifier to provide an appropriate scope in which the network address assigned to the UE is routable by core network .

Subscriber attachment front end of SRC receives attachment notification message and stores the subscriber identification and network address information as an attachment session record in session repositories of SRC . Session repositories stores attachment session records for those UE attached to access gateway in an attachment sessions table and may maintain the table in the form of one of a variety of data structures such as tables radix trees flat files and databases. An attachment session for a particular subscriber is uniquely identifiable by a network address. In instances in which the subscriber is a member of a VPN the attachment session is uniquely identifiable by a combination of a VPN identifier and a network address.

In accordance with the techniques of this disclosure service activation engines A C SAEs manage service sessions and policies for application by service nodes to subscriber data traffic on a per subscriber basis. SAEs expose a respective packet triggered subscriber and policy control PTSP interface A B that allows core network devices such as service nodes to signal to SAEs when new subscriber packet flows are detected and to allow SAEs to install subscriber specific policies to service nodes for application to the subscriber packet flows. The respective PTSP interfaces provided by each of SAEs may each comprise a Diameter or other server that enables service node clients to make requests and provide updates to the service activation engines. In some embodiments each of PTSP interfaces may comprise common open policy service COPS RADIUS or another type of interface.

In addition SAEs instantiate service sessions and install policies to service nodes for active packet flows traversing service nodes . One of SAEs manages the subscriber session for a subscriber which represents an attachment session for the subscriber and may map to one or more packet flows. Multiple different packet flows for a single subscriber may traverse both service node A and or B due to multiple network paths through core network . When one of service nodes detects a new packet flow the service node uses a respective one of PTSP interfaces to signal properties of the new packet flow to one of SAEs . In particular the service nodes send a source and or destination network address for the new packet flow that the SAE may use to identify a subscriber for service nodes do not manage attachment sessions for subscribers associated with any of the network addresses in the new packet flow. Rather access gateway manages subscriber attachment sessions. In some aspects the service nodes may also send a VPN identifier that specifies a scope of the network addresses in the new packet flow. In some embodiments each of service nodes is associated with a different one of SAEs based on geographical proximity for instance.

The SAEs query session repositories using packet flow properties to obtain an attachment session record for a subscriber having a network address that matches one of the packet flow properties. For example a packet flow may have as a destination address a network address assigned to UE during an attachment process. The one of SAEs that receives the packet flow properties from service nodes keys into the attachment sessions table of session repositories to obtain a subscriber identity for the packet flow. In this way SRC associates subscriber identities with individual packet flows transported by service nodes . In some embodiments SAEs query access manager for an attachment session record to associate an attached subscriber to a packet flow within core network .

In the illustrated embodiment the one of SAEs managing a subscriber session queries subscriber database illustrated as subscr. database to obtain subscriber specific policies for the session. That is using the subscriber identity for the subscriber session the managing one of SAEs queries subscriber database for policies mapped to the subscriber. Subscriber database comprises a database server that includes one or more databases to map policies and other subscriber related data such as geographic location and demographic information to subscribers. The managing one of SAEs then installs the policies to the service node that services the session and the service node applies the policies to the subscriber session. In some instances SAEs may install a default subscriber policy to service nodes for new subscriber sessions.

Session repositories additionally stores a mapping of service sessions to be applied by service nodes to subscriber sessions according to the particular subscriber. Session repositories maintains the mapping in a service sessions table having records for each of the services to apply to subscriber sessions for a particular subscriber. Session repositories may maintain the table in the form of one of a variety of data structures such as tables radix trees flat files and databases. For each subscriber session managed the managing one of SAEs translates service sessions stored in the service sessions table of session repositories to a set of one or more enforcement policies. An enforcement policy is a list of condition action rules. In general an enforcement policy condition matches network i.e. layer three of the Open Systems Interconnect OSI model and or application layer i.e. OSI layer seven data carried by the subscriber data traffic and causes service nodes to apply corresponding actions to subscriber data traffic matched by the service nodes. Exemplary actions specified by enforcement policies include forwarding filtering marking counting policy routing advertisement insertion and other manipulations of the data flows.

Advanced services gateway exposes an application programming interface for SRC by which third parties such as application server may request a service activation for a subscriber. In one example application server sends service activation request to advanced services gateway where service activation request includes a subscriber identifier e.g. a network address and a service identifier. In some aspects service activation request also includes a VPN identifier for the subscriber. Advanced services gateway may provide Simple Object Access Protocol SOAP procedures Common Object Request Broker Architecture CORBA methods Remote Procedure Calls RPCs a Diameter or RADIUS server and or a command line interface as examples by which a third party or the service provider may modify the subscriber specific service configuration in SRC .

Advanced services gateway receives service activation requests and inserts a record into the service sessions table of session repositories for the new service session to be applied to subscriber sessions for a subscriber. In response each of SAEs responsible for managing one or more subscriber sessions for the subscriber translates the new service session to a set of one or more enforcement policies. An SAE that manages such a subscriber session sends the translated enforcement policies to the service node that services the subscriber session via a respective one of PTSP interfaces . Because multiple SAEs may manage subscriber sessions for a particular subscriber identified for example by a network address each of SAEs independently determines whether it manages a subscriber session to which a new service session should be applied. In some embodiments session repositories updates each of SAEs with new service sessions received via advanced services gateway .

The service nodes apply received enforcement policies for subscriber sessions to subscriber data traffic for the respective subscriber sessions. In this way service nodes may apply services to subscriber data traffic on a per subscriber per service basis thereby allowing services nodes to scale independently of access gateway . In addition service nodes in cooperation with SRC may using the described techniques may apply subscriber specific services to subscriber data traffic for multiple packet flows that may take any number of paths through core network and thus be serviced by any one of service nodes .

In one example application of the techniques of this disclosure service node A may detect a new packet flow and send packet flow properties to SAE A via PTSP interface A. SAE A queries the attachment sessions table of session repositories to obtain an attachment record for the corresponding subscriber for the new packet flow. SAE A queries the service sessions table of session repositories to obtain default services for the subscriber. In this example a default service specifies redirection of subscriber data traffic to or away from a service complex that manipulates application data within the traffic to for example reformat the application data for a particular subscriber device. SAE A translates the default service to one or more enforcement policies and downloads the policies to service node A via PTSP interface A. Service node A applies the enforcement policies to the packet flow to redirect the subscriber data traffic to the service complex. In some instances the enforcement policies cause service node A to redirect the subscriber data traffic to a particular one of application gateways e.g. application gateway A. Application gateway A may then forward the subscriber data traffic to the service complex.

As another example application of the techniques of this disclosure service node B detects a new packet flow and sends packet flow properties to SAE B via PTSP interface B. SAE B queries the attachment sessions table of session repositories to obtain an attachment record for the corresponding subscriber for the new packet flow. SAE B then creates a new subscriber session for the new packet flow. Advanced services gateway receives a service activation request for the subscriber creates a new service session record for the affected subscriber session and stores the service session record to session repositories . SAE B as the manager for the subscriber session activates the service session translates the service session to enforcement polices and downloads the enforcement policies to service node B which applies the enforcement policies to the packet flow corresponding to the subscriber session.

After identifying an associated subscriber for the packet flow the managing one of SAEs creates a subscriber session for the packet flow and based on the subscriber identity determines services to apply to the subscriber session from the service session table of session repositories . The managing one of SAEs translates the services to enforcement policies and installs the policies to the service node that transports the packet flow for the subscriber session .

When an attachment session record for the packet flow is present in session repositories YES branch of SAE A successfully associates the subscriber attachment information with the packet flow to identify a subscriber for the packet flow . The SAE queries the service session table of session repositories to determine whether any subscriber specific services are to be instantiated for the subscriber session . Subscriber specific services may include services for a subscriber activated by a third party interfacing to SRC via advanced services gateway . SAE A then creates the subscriber session having the new services or if a default subscriber session for the packet flow already exists SAE A updates the subscriber session with the new services . In some instances updating the subscriber session involves installing enforcement policies to the service node using a PTSP interface session with the service node. In some embodiments SAEs query a subscriber database for subscriber specific policies to apply to a subscriber session.

Router comprises a control unit that includes a routing unit coupled to a forwarding unit . Routing unit provides an operating environment for routing protocols that perform routing operations. Routing unit is responsible for the maintenance of a routing information base RIB to reflect the current topology of a network and other network entities to which it is connected. In particular routing unit periodically updates RIB to accurately reflect the topology of the network and other entities.

In accordance with RIB forwarding unit maintains forwarding information base FIB that associates network destinations with specific next hops and corresponding interface ports. For example control unit analyzes RIB and generates FIB in accordance with RIB . Router includes interface cards A N IFCs that receive and send packets via network links and respectively. IFCs may be coupled to network links via a number of interface ports. Forwarding unit may comprise a switch fabric to forward the multicast packets to the interface cards based on the selected next hops.

Generally forwarding unit may relay certain packets received from IFCs to service cards . Specifically forwarding unit may include a flow steering unit to selectively direct packets to services unit for processing. That is flow steering unit receives incoming packet flows and determines whether to send the packets through the services unit for processing within one or more of service cards or whether to bypass the services units . An example forwarding plane configuration for separation of services and forwarding in an integrated services router may be found in U.S. patent application Ser. No. 12 235 677 entitled Forwarding Plane Configuration for Separation of Services and Forwarding in an Integrated Services Router filed on Sep. 23 2008 the entire contents of which is incorporated by reference herein.

Service cards receive packets from forwarding unit selectively provide services in accordance with the defined configuration data . In some case service cards may relay the packets or any response packets to control unit for forwarding by forwarding unit in accordance with FIB . A number of input and output logical interfaces may couple service cards to control unit .

Service cards of services unit may be installed along a backplane or other interconnect of router to perform a variety of services on the packets received from forwarding unit . In some cases a service card may issue commands to dynamically configure a flow table within flow steering unit of forwarding unit . For example flow steering unit receives a packet and analyzes the received packet to identify a packet flow associated with the packet e.g. using a flow based provisioning logic to identify an n tuple based on information carried in the header or body of the packet e.g. a five tuple and an input interface . Upon identifying the packet flow flow steering unit references an internal flow table to determine whether belongs to a new packet flow or a packet flow already recognized by the router .

Upon identifying a new packet flow flow steering unit sends characteristics of the new packet flow including a source and destination network address to PTSP client PTSP of router . PTSP client sends these characteristics as flow information to a session and resource controller SRC for the network that employs router . PTSP client receives enforcement policies for the new packet flow which may represent services described herein e.g. filtering redirection marking quality of service and the like and stores the enforcement policies to configuration data . PTSP client represents software executing on services unit that connects to a PTSP interface of an SRC to notify the SRC of new packet flows and receive enforcement policies for the packet flows as described herein. In some embodiments each of service cards comprises an instance of PTSP client .

If flow steering unit does not find a match in the flow table which indicates that the packet belongs to a new packet flow the flow steering unit directs the packet to service cards of services units . When the packet is directed to services units one of service cards applies subscriber specific enforcement policies as stored in configuration data to those packets that carry subscriber data traffic that requires services of the router. In addition the service cards may extract and assemble application layer data from the packet and a deep packet inspection DPI unit may perform application analysis to determine enforcement policies to apply.

Upon receiving and processing the packet or packets of a packet flow service cards may issue a command to install a dynamic filter within the flow table or FIB such as an exact match filter that indicates particular actions to be performed when a packet is received that matches the filter. For example the installed filter may specify one or more actions to be applied by forwarding unit for the specific packet flow in the data plane of router . In addition the filter may specify that forwarding unit is to direct any matching packets to services unit or to an external services complex for application of subscriber specific services. In the case that service cards determine no further services need be applied to a packet flow service cards may install a filter within flow steering unit to specify that subsequent packets of this packet flow session may be processed on a straight path that bypasses services units . When flow steering unit receives a subsequent packet of the same packet flow flow steering unit checks the flow table determines that the packet matches the new dynamic filter and directs the packet on the appropriate path according to the dynamic filter.

In one embodiment each of forwarding unit and routing unit may comprise one or more dedicated processors storage media hardware and the like and may be communicatively coupled by a data communication channel . The data communication channel may be a high speed network connection bus shared memory or other data communication mechanism.

In this way the operation of router can be viewed as segmented into a control plane a service plane and a data plane. The control plane may be seen as provided by routing unit and may include one or more software processes such as a management daemon and a routing protocol daemon executing on a computing environment provided by one or more microprocessors.

Router may further include a physical chassis not shown for housing control unit . The chassis has a number of slots not shown for receiving a set of cards including IFCs and service cards . Each card may be inserted into a corresponding slot of the chassis for electrically coupling the card to control unit via a bus backplane or other electrical communication mechanism.

The techniques described in this disclosure may be implemented at least in part in hardware software firmware or any combination thereof. For example various aspects of the described techniques may be implemented within one or more processors including one or more microprocessors digital signal processors DSPs application specific integrated circuits ASICs field programmable gate arrays FPGAs or any other equivalent integrated or discrete logic circuitry as well as any combinations of such components. The term processor or processing circuitry may generally refer to any of the foregoing logic circuitry alone or in combination with other logic circuitry or any other equivalent circuitry. A control unit comprising hardware may also perform one or more of the techniques of this disclosure.

Such hardware software and firmware may be implemented within the same device or within separate devices to support the various operations and functions described in this disclosure. In addition any of the described units modules or components may be implemented together or separately as discrete but interoperable logic devices. Depiction of different features as modules or units is intended to highlight different functional aspects and does not necessarily imply that such modules or units must be realized by separate hardware or software components. Rather functionality associated with one or more modules or units may be performed by separate hardware or software components or integrated within common or separate hardware or software components.

The techniques described in this disclosure may also be embodied or encoded in a computer readable medium such as a computer readable storage medium containing instructions. Instructions embedded or encoded in a computer readable medium may cause a programmable processor or other processor to perform the method e.g. when the instructions are executed. Computer readable storage media may include random access memory RAM read only memory ROM programmable read only memory PROM erasable programmable read only memory EPROM electronically erasable programmable read only memory EEPROM flash memory a hard disk a CD ROM a floppy disk a cassette magnetic media optical media or other computer readable storage media. It should be understood that the term non transitory computer readable storage media refers to physical storage media and not signals or carrier waves although the term computer readable media may include transient media such as signals in addition to physical storage media.

Various embodiments of the invention have been described. These and other embodiments are within the scope of the following claims.

