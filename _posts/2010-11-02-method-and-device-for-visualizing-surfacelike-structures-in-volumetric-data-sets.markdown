---

title: Method and device for visualizing surface-like structures in volumetric data sets
abstract: The present invention relates to a method and a device for visualizing surface-like structures in volumetric data sets, including defining local coordinate systems at sample points of the volumetric data set, transforming external parameters from a global coordinate system into the local coordinate systems, calculating the gradient vector components (Gai, Gbi, Gci) within the local coordinate systems of the sample points, and using the gradient vector components (Gai, Gbi, Gci) for calculating a surface normal at a given position of the volumetric data set, where the surface normal is important for conventional illumination models such as the Blinn-Phong shading model, preferably, the present invention is also calculating the external parameters from the global coordinate system at the given position by using the transformed external parameters of the local coordinate systems of the sample points, where the shading or illumination at the given position is then done by using a conventional illumination model, thereby using the calculated surface normal at the given position and the calculated external parameters at the given position.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08736609&OS=08736609&RS=08736609
owner: Tomtec Imaging Systems GmbH
number: 08736609
owner_city: 
owner_country: DE
publication_date: 20101102
---
The present invention relates to a method and a device for visualizing surface like structures in volumetric data sets such as volume rendering especially for illuminating these surface like structures especially for real time rendering of sampled data from ultrasound data acquisition. The present invention specifically relates to three dimensional medical imaging where two dimensional images are volume rendered from three dimensional data volumes.

Three dimensional ultrasound imaging but also CT or MR imaging generates three dimensional data which is usually formatted in a coordinate system which is not a Cartesian coordinate system. Such non Cartesian grid is e.g. an acoustic grid of an ultrasound probe which obtains images of e.g. the heart of a human being. Such data which represents a volume is usually scan converted along the Cartesian coordinate system before being volume rendered. When displaying the object scanned it is necessary to display a surface of the object wherein such surface shall be displayed as natural as possible . One way to do that is to use a virtual external light source and to incorporate the contribution of such external light source into the volume rendering integral. Such three dimensional shading is used to render such three dimensional data set thereby using application programming interfaces such as OpenGL or DirectX.

For these illumination models such as the Blinn Phong shading model it is usually necessary to define a surface normal in order to evaluate the shading model at a specific position. The Blinn Phong shading model is a modification of the Phong reflection model and is carried out on each point of the surface to be displayed. For this and other shading models it is usually necessary to define the light vector and the surface normal of a specific position of such surface in order to calculate the diffuse reflection and further vectors such as the eye vector or the camera vector in order to calculate the specular reflection.

A common way to approximate the surface normal on a specific position is to use a finite differencing scheme such as forward backward or central differencing. For volumetric data such surface normal is often calculated using the finite difference in all three dimensions spatial derivatives also called the spatial gradient vector 

The gradient of the scalar field is the direction of highest change so the surface normal of the isosurface at a certain position is equal to the normalized gradient 

In order to calculate the gradient of a sampled data volume a cheap and quick method is to calculate the central differences thereby using the neighbouring grid values. That is shown in of the present application 

In a three dimensional volumetric data set it is clear that it is then necessary to evaluate f which samples the three dimensional volumetric data at six positions. Together with the center sample f P which shall be used for the shading task it is necessary to conduct seven evaluations of f for each shaded position e.g. each voxel in the 3D voxel space.

It is known in prior art to speed up such calculation by pre computing the gradient vectors at each discrete position. At each discrete voxel position in a three dimensional Cartesian coordinate system the differences are computed and stored together with the original scalar value in a 4 tuple vector G G G f . In terms of performance that reduces the number of look ups when shading a surface within such three dimensional voxel space by just using the gradient vector components and the scalar value so that it is possible to illuminate these positions by using the pre calculated 4 tuple vector. The main drawback however is the increased data size. The volume data is expanded by at least the factor 4 which easily becomes a problem on machines with a low amount of memory.

For non Cartesian data the numerical computation of spatial derivatives the gradient and the resultant surface normal becomes more complicated lighting calculations are based on a global Cartesian coordinate system wherein light source viewers position camera position etc. are given in such Cartesian coordinate system. Several shading models such as Blinn Phong or Phong all use Cartesian coordinate systems for shading calculation.

For non Cartesian data such as ultrasound data which is e.g. given in so called acoustic coordinates it is not possible to directly use models such as Blinn Phong or the Phong reflection model thereby using the gradient vector as mentioned above at a given sample position thereby using any of the differencing schemes mentioned above. This is due to the fact that the coordinate system is not a Cartesian coordinate system. That is also shown in . The local coordinate system with axis a and axis b will not give the correct gradient vector component in direction a because the values f P and f P are not lying in such space. Hence in order to calculate the gradient vector G it would be necessary to first re sample the three dimensional data set into a Cartesian coordinate system in order to then compute the gradient components which is then given in the global Cartesian coordinate system.

A different approach is given in U.S. Pat. No. 7 037 263 B2 where the gradient is first determined from data in the acoustic domain and then transformed to the Cartesian coordinate or display screen domain. A transformation matrix is specified for each position within the sampled three dimensional acoustic data. The above mentioned solution requires an expensive re sampling step to a Cartesian geometry.

The invention provides a method and a device for visualizing surface like structures in volumetric data sets which are not given in a Cartesian coordinate system thereby enabling the use of known illumination or shading models. Specifically the present invention shall give a solution to fast gradient computation and surface lighting for real time graphic processing unit based volume rendering on acoustic grids.

The major advantage of the present invention is that it is not necessary to re sample the data into a Cartesian geometry and the present invention also performs much easier and faster calculations thereby enabling the use of known shading and illumination models.

The external parameters preferably comprise position coordinates and or vectors defining positions and or directions respectively which determine the visualization volume rendering of the data set. The external parameters may for example be the position of one or several light sources the observer position and or the light vector s used for the rendering and or the vector direction of the observer.

As it is desired that these external parameters may be varied in real time for example for visualizing the surface structures from different observer directions a fast algorithm as provided by the invention is important.

According to an embodiment the volumetric data set has been acquired by a medical imaging technique such as Ultrasound Computed Tomography Magnetic Resonance Imaging or Positron Emission Spectroscopy. The sample points are the points making up the data set.

The local coordinate systems are preferably coordinate systems which at each sample point are aligned with the coordinate system in which the volumetric data set is available for example the acoustic coordinate system. Thus the local coordinate systems are slightly different for each sample point preferably they vary smoothly from sample point to sample point.

The global coordinate system is a coordinate system in which the position and orientation of the volumetric data set and the external parameters required for the volume rendering step such as the position of one or several light sources the observer position and or the light vectors used for the rendering and or the direction of the observer are all defined in one and the same coordinate system. It is usually a Cartesian coordinate system but that is not a requirement.

By calculating the gradient vector components within said local coordinate systems of the sample points it is not necessary to transform the sample points and their respective gradient vector components into a global Cartesian coordinate system. In fact external parameters such as the light source or the position of the camera or observer are transformed from a global coordinate system into the local coordinate system of each or selected sample points. By defining such local coordinate system at the position to be shaded such transformation of external parameters is possible.

A possible local coordinate system is the tangent space and is e.g. used for local bump mapping calculations. Here a perturbation to the surface normal of the object to be rendered is looked up in a texture map at each sample point and applied before the illumination calculation is done. Thereby a richer more detailed surface representation is obtained see for instance Phong shading . Normal mapping and parallax mapping are the most commonly used bump mapping techniques. Here the tangent space is often used for defining the local coordinate system.

In order to create a tangent space for a surface it is necessary to calculate three perpendicular axes namely T B and N. T the tangent vector is parallel to the direction of increasing S or T on a parametric surface. N the normal vector is perpendicular to the local surface. B the bi normal is perpendicular to both N and T and like T also lies on the surface. It is a moving coordinate system that is attached to the surface and moves along with the sample points to be shaded.

In the case of acoustic coordinates the three perpendicular axes are preferably aligned with the three directions azimuth elevation and range. For example N may correspond to range T to elevation and S to azimuth. Preferably the local coordinate system at each sample point is aligned in the same way with the acoustic coordinates.

The present invention uses such technique wherein at each sample point the gradient vector components are calculated within the local coordinate systems of such sample point. Said sample points are preferably grid points of an acoustic grid which is a special coordinate system as the ultrasound images are scanned and the local coordinate system is then defined at such sample points for example in an at least 3 D coordinate system with perpendicular axes in the directions of an acoustic grid e.g. range elevation and azimuth. The calculation of the gradient vector components within said local coordinate system can for example be done by calculating the spatial derivatives in all dimensions preferably by finite differencing of sample points thereby using the discrete values of respective neighbouring sample points.

If a given position of said volumetric data set which can be a sample point or some voxel in between these sample points shall be illuminated it is then possible to calculate the surface normal at such given position by using the gradient vector components of the sample points. The given position is a position at which it is desired to calculate the light reflection in order to produce a volume rendered image. If the visualisation or volume rendering process is done by a ray casting technique the given position s will for example be on such ray if a slice based technique is used the given position s will be the pixel positions on these slices. Most if not all of the given positions are usually not identical with the sample points nor with the selected sample points or the points on a reference grid.

According to a preferred embodiment of the present invention said surface normal at a given position is calculated by first interpolating non normalized gradient vector components of neighbouring sample points and by then normalizing the interpolated gradient vector at such position.

When the surface normal at a given position shall then be calculated it is possible in accordance with a preferred embodiment of the present invention to interpolate non normalized gradient vector components of e.g. eight neighbouring sample points wherein the sample points are neighboured to such given position in such three dimensional voxel space. That will reduce the calculation to sample points only while all other voxel positions are calculated by interpolating the gradient vector components of respective neighbouring sample points.

According to an important aspect of the present invention not the normalized gradient vectors or the normal vectors of these sample points are interpolated to obtain respective gradient vectors at a given position but the non normalized gradient vector components are interpolated and the normalization is then performed afterwards at such given position.

According to an embodiment such interpolation between gradient vector components of neighbouring sample points is done without accounting for the fact that the gradient vector components exist in different local coordinate systems. In other words the interpolation is done as if the gradient vector components from all contributing sample points were in the same local coordinate system. This approximation can be done because at least in acoustic coordinates there are no sharp transitions in the geometric of the coordinate system i.e. the orientation of the local coordinate systems of neighbouring sample points differs only slightly. The situation would be different if sample points which are far away from each other had to be compared but as this is not the case the inaccuracies resulting from this procedure do not impair the result.

According to another aspect of the present invention the light source and other external parameters is then transformed into such local coordinate system at some points of the three dimensional data grid. These points may be selected sample points or they may be points of a reference grid which is defined within the acoustic grid but need not match the sample points of the acoustic grid. According to an embodiment of the invention the conversion transformation of the external parameters into the local coordinate systems is not done at every sample point as that would be very calculation intensive but only at some selected points of the data set for example at every 3to 50sample point in each dimension or at points of a pre defined reference grid wherein the reference grid may have a resolution which is less than the resolution of the sample points for example about 5 to 30 times less.

The transformation of the external parameters into the local coordinate system of a sample point or the point on a reference grid is done e.g. by calculating a transformation matrix between the global coordinate system and the respective local coordinate system and by mapping the external coordinates into the local coordinate system at the sample point or the reference point.

It is then possible according to a preferred embodiment of the present invention to calculate the external parameters from said global coordinate system at said given position also by using the transformed external parameters of said local coordinate system of the selected sample points or of the points of the reference grid preferably of neighbouring selected sample points or points of the reference grid. That will further reduce the calculation time as it is then not necessary to calculate a transformation of external parameters into local coordinate systems at each given position but it is only necessary to do such calculation for certain sample points within said three dimensional acoustic data grid. As stated above these sample points can also be grid points of a predefined reference grid as described in US 2005 0253841 A1. Thus according to an embodiment the transformation from Cartesian global coordinate system to acoustic local coordinate system geometry is not done for every sample point but at a much coarser level.

According to an embodiment the external parameters at the given positions are then interpolated from closest sample points or points of the reference grid for which the external parameters have been transformed into the local coordinate systems. This is an approximation but again since there is no sharp transition in the geometry a sufficiently smooth result is obtained using interpolation.

According to another preferred aspect of the present invention the shading of a given position is done by a conventional illumination model wherein the surface normal at said given position is used as well as the calculated external parameters from said global coordinate system at said given position.

In accordance with the present invention it is possible to use a volumetric data set which is derived from sampled raw ultrasound data wherein said gradient vector components within the local coordinate systems are calculated from each sample point of the raw ultrasound data and stored together with the scalar value of the sample point in a new data set containing 4 tupl vectors G G G F . For any given position these gradient vector components and such scalar value of neighbouring sample points are then used for calculating a surface normal at the given position. Thereafter the transformed external parameters of the local coordinate system of said sample points are used for calculating the external parameters at the given position and the given position may then be illuminated by a conventional illumination model by using the calculated external parameters and the calculated surface normal. A conventional Blinn Phong illumination model can be used since the relevant factors such as surface normal light vector viewers vector half normal or the reflection vector are existent in the local coordinate system of each sample point and interpolated for each given position.

According to the present invention the sampled raw ultrasound data is first transferred to a graphics processing unit and then computed there using a shader wherein the transforming of external parameters from a global coordinate system into a local coordinate system is e.g. performed by the graphic processing unit of an ultrasound computer system. The gradient vector components within the local coordinate systems are then calculated by using central differences sobel operators or other estimators.

The present invention also relates to a device for visualizing surface like structures in volumetric data sets with

Both processing units PU PU are preferably graphic processing units which will help the CPU to minimize processing time needed for the illumination or shading. The graphics processing unit displays the given position which is illuminated by a conventional illumination model by using the calculated external parameters and the calculated surface normal in a Cartesian coordinate system which is usually identical to the display screen domain. Here the graphics processing unit is usually also calculating the external parameters from the global coordinate system at the given position by interpolating the transformed external parameters of the local coordinate systems of neighbouring sample points in order to obtain the relevant transformed and interpolated external parameters at such local grid points which are either points of the acoustic grid or points in between these grid points or points of a reference grid as described in US 2005 0253841 A1.

US 2005 0253841 A1 discloses the deformation of a reference grid coordinate system as a function of a cut plane which is defined within the three dimensional data set. US 2005 0253841 A1 proposes to use the intersection points of a cut plane with a proxy geometry representing a scan volume wherein a vertex processor of a graphic processing unit then deforms the reference grid and determines Cartesian coordinates and the texture coordinates for respective grid points of the reference grid. However for the present invention it is not necessary to transform grid points into Cartesian coordinates.

The present invention also relates to a computer program product which comprises a program code which is stored on a computer readable media and which performs the above described method if such computer program product is run on a computer.

As described above the local gradient vector G is defined by local gradient vector components Gand Gof a sample point P wherein these components may be calculated by a differencing scheme as mentioned above.

Each sample point Phas a local gradient vector Gi with local gradient vector components Gand G. The first sample point Phas a first gradient vector component Gand a second gradient vector component G wherein axis of the first local coordinate system LCSis in parallel to beam while the second local coordinate system axis ais the tangent vector of row and perpendicular to the first coordinate system axis b.

The first local gradient vector Gis defined by using neighbouring sample points such as sample point Por other sample points thereby using well known differencing schemes such as central differencing schemes Formula 1 discrete convolution filters such as a sobel filter or continuous convolution filters such a cubic B spline and its derivatives 4 4 4 neighbours .

Similarly the normal vector N of a given position Q is calculated by using the gradient vector components G Gand Gof the first sample point Pas well as gradient vector components G Gand Gof the second sample point P not shown so it is not necessary to calculate the vectors necessary for the illumination models at each given position by transforming coordinate systems or external parameters but it is only necessary to calculate the transformation of external parameters at discrete sample points and to obtain the surface normal N and other vectors by interpolating the non normalized gradient vector components of respective sample points Pi at a given position Q. Again the external parameters are transformed into the local coordinate system LCSof the given position Q by interpolating already transformed external parameters from certain neighbouring sample points of the acoustic grid or said reference grid.

That way computation costs can be reduced by computing the light source LS only in local space and only at the grid points of the acoustic grid or a reference grid and using linear interpolation for in between points or pixels. Thereby it is possible to reduce a large part of the transformation calculation costs because of a much coarser grid.

The present invention uses a reduced computation model by transforming the external parameters only at some or all points of a grid acoustic grid reference grid or part or a combination of these grids thereby accepting that the values at each given position at each voxel within the three dimensional Cartesian voxel space are interpolated. Since such interpolation results are used only for illumination calculation it is believed that this is a legitimate approximation. The human eye is very sensitive to high frequency changes in illumination e.g. a sharp edge or hard cut off is easily visible . However since there is no sharp transition in the geometry it is possible to obtain a pretty smooth result by using the interpolation techniques of the present invention. The human eye will normally not notice any difference in the illumination result.

Raw data as shown in step I of is first transferred onto the GPU in its native format e.g. 8 bits per sample . In a second step II each sample is iterated and the gradient is computed. Central differences sobel operators or any other estimator can be used. Thereafter the un normalized gradient component G G G F are stored in a new three dimensional volume as shown schematically in . Here it is preferable to use a higher precision e.g. 16 or 32 bit floats in order to avoid any quantization artifacts.

According to the invention it is advantageous not to implement pre computed gradients normalized at this stage but to store the gradient vector components non normalized instead.

As shown in step III in the surface normal N at a given position Q is calculated by interpolating the gradient vector components of gradient Gof a first sample point P gradient Gof a second sample point P gradient Gof a third sample point Pand gradient Gof a fourth sample point P. Each gradient has respective gradient vector components which are all used to define the gradient vector at the given position Q which is only then normalized to obtain the surface normal N.

The present invention has the advantage that the method used fits well with reference grid implementations as there is less work load in the pixel shader stage which results in a high performance real time gradient rendering. Furthermore all lighting calculation is done in the local coordinate systems. The gradient volume in the acoustic space can be pre computed and stored so that illumination is sped up.

