---

title: Virtual provisioning space reservation
abstract: Guaranteeing space availability for thin devices includes reserving space without committing, or fully pre-allocating, the space to specific thin device ranges. Space may be held in reserve for a particular set of thin devices and consumed as needed by those thin devices. The system guards user-critical devices from running out of space, for example due to a “rogue device” scenario in which one device allocates an excessive amount of space. The system uses a reservation entity, to which a thin device may subscribe, which reserves space for the thin device without allocating that space before it is need to service an I/O request.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=09176677&OS=09176677&RS=09176677
owner: EMC Corporation
number: 09176677
owner_city: Hopkinton
owner_country: US
publication_date: 20100928
---
This application relates to storage devices and more particularly to the field of data management of data stored on storage devices.

Host processor systems may store and retrieve data using storage devices containing a plurality of host interface units host adapters disk drives and disk interface units disk adapters . Such storage devices are provided for example by EMC Corporation of Hopkinton Mass. and disclosed in U.S. Pat. No. 5 206 939 to Yanai et al. U.S. Pat. No. 5 778 394 to Galtzur et al. U.S. Pat. No. 5 845 147 to Vishlitzky et al. and U.S. Pat. No. 5 857 208 to Ofek which are incorporated herein by reference. The host systems access the storage device through a plurality of channels provided therewith. Host systems provide data and access control information through the channels of the storage device and the storage device provides data to the host systems also through the channels. The host systems do not address the disk drives of the storage device directly but rather access what appears to the host systems as a plurality of logical volumes. Different sections of the logical volumes may or may not correspond to the actual disk drives.

Thin provisioning also referred to as virtual provisioning storage systems present a large amount of storage capacity to a host but consume space only as needed from a shared pool. The devices of thin provisioning are known as thin devices or thin LUNs. With thin devices the host visible capacity e.g. storage perceived by the applications is larger than the actual allocated space on the storage system. This simplifies the creation and allocation of storage capacity. Thin devices may be sized to accommodate growth without regard for currently available assets. Physical storage is assigned to the server in a capacity on demand fashion from a shared pool.

To guarantee that sufficient allocated space is available when needed in a thin provisioning environment known techniques provide that extents on storage devices may be pre allocated when thin devices are bound to a thin storage pool. Binding a thin device to a pool associates the thin device with the pool. Users may pre allocate space to certain volumes of thin devices or may pre allocate entire thin devices. When space is pre allocated that space may be reserved for the thin device starting at the beginning of the thin device. For example if 100 MB is pre allocated when a thin device is bound to a storage pool the space for the first 100 MB of the thin device may be allocated in the storage pool. Any writes to the pre allocated area of the thin device do not result in additional allocation in the storage pool. This approach to guarantee allocation however may result in various storage space inefficiencies since it requires that the allocated thin device capacity be held in reserve and thereby reduces the thinness property of the thin device.

Accordingly it would be desirable to implement a system that guarantees space availability for thinly provisioned devices in a way that reduces the need for pre allocating space or otherwise committing space ahead of time to specific thin devices.

According to the system described herein a method for reserving storage space in a thin provisioning environment includes receiving a space reservation request from a first device wherein the space reservation request identifies an amount of space requested for reservation for the first device from a storage pool. A reservation entity is maintained that identifies reserved space in the storage pool corresponding to the request from the first device wherein the reserved space in the storage pool that is identified by the reservation entity is reserved for the first device and is not yet allocated to the first device. The reservation entity is used according to a policy in connection with allocating space to service an I O request involving the first device. Information in the first device may be maintained that identifies the reservation entity and the amount of space requested for reservation for the first device. The reservation entity may communicate with at least one device reserved list of a second device the at least one device reserved list identifying reserved storage space on the second device. The first device may include a thin device and wherein the second device may include a data device. The reservation entity may communicate with a plurality of device reserved lists for a plurality of second devices. The plurality of second devices may be contained in the same storage pool or may be contained across multiple storage pools. The policy may include using the reserved space of the reservation entity if free unallocated space in the storage pool is unavailable the free unallocated space being space that is not reserved by the reservation entity.

According further to the system described herein a non transitory computer readable medium stores software for reserving storage space in a thin provisioning environment. The software includes executable code that receives a space reservation request from a first device wherein the space reservation request identifies an amount of space requested for reservation for the first device from a storage pool. Executable code may be provided that maintains a reservation entity that identifies reserved space in the storage pool corresponding to the request from the first device wherein the reserved space in the storage pool that is identified by the reservation entity is reserved for the first device and is not yet allocated to the first device. Executable code may be provided that uses the reservation entity in connection with allocating space to service an I O request involving the first device. Executable code may be provided that maintains information in the first device that identifies the reservation entity and the amount of space requested for reservation for the first device. The reservation entity may communicate with at least one device reserved list of a second device the at least one device reserved list identifying reserved storage space on the second device. The first device may include a thin device and the second device may include a data device. The reservation entity may communicate with a plurality of device reserved lists for a plurality of second devices. The plurality of second devices may be contained in the same storage pool or across multiple storage pools. The policy may include using the reserved space of the reservation entity if free unallocated space in the storage pool is unavailable the free unallocated space being space that is not reserved by the reservation entity.

According further to the system described herein a method for allocating storage space in a thin provisioning environment includes receiving an allocation request from a first device to allocate space in a storage pool in connection with servicing an I O request. Space may be allocated according to a policy involving a reservation entity that identifies reserved space in the storage pool corresponding to the request from the first device wherein the reserved space in the storage pool that is identified by the reservation entity is reserved for the first device and is not yet allocated to the first device. The reservation entity may communicate with at least one device reserved list of a second device the at least one device reserved list identifying reserved storage space on the second device. The first device may include a thin device and wherein the second device includes a data device. The reservation entity may communicate with a plurality of device reserved lists for a plurality of second devices. The plurality of second devices may be contained in the same storage pool or across multiple storage pools. The policy may include using the reserved space of the reservation entity if free unallocated space in the storage pool is unavailable the free unallocated space being space that is not reserved by the reservation entity.

According further to the system described herein a non transitory computer readable medium stores software for allocating storage space in a thin provisioning environment. The software may include executable code that receives an allocation request from a first device to allocate space in a storage pool in connection with servicing an I O request. Executable code may be provided that allocates space according to a policy involving a reservation entity that identifies reserved space in the storage pool corresponding to the request from the first device wherein the reserved space in the storage pool that is identified by the reservation entity is reserved for the first device and is not yet allocated to the first device. The reservation entity may communicate with at least one device reserved list of a second device the at least one device reserved list identifying reserved storage space on the second device. The first device may include a thin device and the second device may include a data device. The reservation entity may communicate with a plurality of device reserved lists for a plurality of second devices. The plurality of second devices may be contained in the same storage pool or across multiple storage pools. The policy may include using the reserved space of the reservation entity if free unallocated space in the storage pool is unavailable the free unallocated space being space that is not reserved by the reservation entity.

The storage device may include one or more Remote Data Facility RDF adapter units RA s . An RDF product such as produced by EMC Corporation of Hopkinton Mass. may be used to copy data from one storage device to another. For example if a host writes data to a first storage device e.g. a local storage device it may be desirable to copy that data to a second storage device provided in a different location e.g. a remote storage device . The RA s are coupled to an RDF link and are similar to the HA s but may be used to transfer data between the storage device and other storage devices see and corresponding description that are also coupled to the RDF link . The storage device may be coupled to additional RDF links not shown in addition to the RDF link . For further discussion of RDF and the use thereof in data recovery and storage techniques see for example U.S. Pat. No. 5 742 792 to Yanai et al. entitled Remote Data Mirroring and U.S. Patent App. Pub. No. 2006 0069887 to LeCrone et al. entitled Triangular Asynchronous Replication which are incorporated herein by reference.

The storage device may also include one or more disks each containing a different portion of data stored on the storage device . Each of the disks may be coupled to a corresponding one of a plurality of disk adapter units DA that provides data to a corresponding one of the disks and receives data from a corresponding one of the disks . The disks may include any appropriate storage medium or mechanism including hard disks solid state storage flash memory etc. Note that in some embodiments it is possible for more than one disk to be serviced by a DA and that it is possible for more than one DA to service a disk. It is noted that the term data as used herein may be appropriately understood in various embodiments to refer to data files extents blocks chunks and or other designations that indicate a unit segment or collection of data.

The logical storage space in the storage device that corresponds to the disks may be subdivided into a plurality of volumes or logical devices. The logical devices may or may not correspond to the physical storage space of the disks . Thus for example the disk may contain a plurality of logical devices or alternatively a single logical device could span both of the disks . The hosts may be configured to access any combination of logical devices independent of the location of the logical devices on the disks . A device such as a logical device described above has a size or capacity that may be expressed in terms of device geometry. The device geometry may include device geometry parameters regarding the number of cylinders in the device the number of heads or tracks per cylinder and the number of blocks per track and these parameters may be used to identify locations on a disk. Other embodiments may use different structures.

One or more internal logical data path s exist between the DA s the HA s the RA s and the memory . In some embodiments one or more internal buses and or communication modules may be used. In some embodiments the memory may be used to facilitate data transferred between the DA s the HA s and the RA s . The memory may contain tasks that are to be performed by one or more of the DA s the HA s and the RA s and a cache for data fetched from one or more of the disks . Use of the memory is further described elsewhere herein in more detail.

The storage device may be provided as a stand alone device coupled to the hosts as shown in or alternatively the storage device may be part of a storage area network SAN that includes a plurality of other storage devices as well as routers network connections etc. The storage device may be coupled to a SAN fabric and or be part of a SAN fabric. The system described herein may be implemented using software hardware and or a combination of software and hardware where software may be stored in a computer readable storage medium and executed by one or more processors and a network on which the system may be implemented may include any suitable network including an intranet or the Internet.

The diagram also shows an optional communication module CM that provides an alternative communication path between the directors . Each of the directors may be coupled to the CM so that any one of the directors may send a message and or data to any other one of the directors without needing to go through the memory . The CM may be implemented using conventional MUX router technology where a sending one of the directors provides an appropriate address to cause a message and or data to be received by an intended receiving one of the directors . Some or all of the functionality of the CM may be implemented using one or more of the directors so that for example the directors may be interconnected directly with the interconnection functionality being provided on each of the directors . In addition a sending one of the directors may be able to broadcast a message to all of the other directors at the same time.

In some embodiments one or more of the directors may have multiple processor systems thereon and thus may be able to perform functions for multiple directors. In some instances at least one of the directors having multiple processor systems thereon may simultaneously perform the functions of at least two different types of directors e.g. an HA and a DA . Furthermore in some embodiments at least one of the directors having multiple processor systems thereon may simultaneously perform the functions of at least one type of director and perform other processing with the other processing system. In addition the memory may be a global memory in which all or at least part of the global memory may be provided on one or more of the directors and shared with other ones of the directors . The memory may be part of a global memory distributed across the processor systems of more than one storage device and accessible by each of the storage devices.

Note that although specific storage device configurations are disclosed in connection with it should be understood that the system described herein may be implemented on any appropriate platform. Thus the system described herein may be implemented using a platform like that described in connection with or may be implemented using a platform that is somewhat or even completely different from any particular platform described herein.

Providing an RDF mapping between portions of the local storage device and the remote storage device involves setting up a logical device on the remote storage device that is a remote mirror for a logical device on the local storage device . One or more of the hosts illustrated as a host may read and write data from and to the logical device on the local storage device and the RDF mapping causes modified data to be transferred from the local storage device to the remote storage device using the RA s and similar RA s on the remote storage device that are connected via the RDF link . In steady state operation the logical device on the remote storage device may contain data that is a copy of or at least substantially identical to the data of the logical device on the local storage device . The logical device on the local storage device that is accessed by the host may be referred to as the R volume or just R while the logical device on the remote storage device that contains a copy of the data on the R volume is called the R volume or just R . Thus the host reads and writes data from and to the R volume and RDF handles automatic copying and updating of the data from the R volume to the R volume and or from the R volume to the R volume in accordance with the system described herein

In an embodiment the system described herein may be used in connection with SRDF synchronous SRDF S transfers. For an SRDF S transfer data written from one of the hosts to the local storage device may be stored locally for example on one of the data volumes of the local storage device while being transferred from the local storage device to the remote storage device . Receipt by the remote storage device is then acknowledged to the local storage device which then provides an acknowledge of the initial write back to the appropriate one of the hosts . In other embodiments the system described herein may also be used in connection with or in combination with other modes of data transfer including for example asynchronous SRDF A transfers and or other appropriate data transfer systems and devices.

The volumes may be provided in multiple storage tiers TIERS that may have different storage characteristics such as speed cost reliability availability security and or other characteristics. Various techniques concerning the management of data between volumes on multiple storage tiers and or between multiple storage tiers within a single volume including the use of thin provisioning technology are discussed for example in U.S. patent applications U.S. Ser. No. 11 726 831 to Yochai et al. filed Mar. 23 2007 entitled Automated Information Life Cycle Management With Thin Provisioning and published on Mar. 12 2009 as U.S. Patent App. Pub. No. 2009 0070541 A1 U.S. Ser. No. 11 823 156 to Burke et al. filed Jun. 27 2007 entitled Fine Grained Tiered Storage With Thin Provisioning U.S. Ser. No. 11 823 152 to Burke filed Jun. 27 2007 entitled Storage Management For Fine Grained Tiered Storage With Thin Provisioning U.S. Ser. No. 11 903 869 to Veprinsky filed Sep. 25 2007 entitled Data De Duplication Using Thin Provisioning U.S. Ser. No. 12 586 837 to LeCrone et al. filed Sep. 29 2009 entitled Sub Tiering Data At The Volume Level and U.S. Ser. No. 12 592 988 to Martin et al. filed Dec. 7 2009 entitled Normalizing Capacity Utilization Within Virtual Storage Pools which are all incorporated herein by reference. Techniques similar to those discussed above may be implemented in one or more Virtual Provisioning products produced by EMC Corporation of Hopkinton Mass. such as EMC CLARiiON Virtual Provisioning and or EMC Symmetrix Virtual Provisioning and may be used in connection with the system described herein.

According to various embodiments each of the volumes may be located in different storage tiers. Tiered storage provides that data may be initially allocated to a particular fast volume tier but a portion of the data that has not been used over a period of time may be automatically moved to a slower and perhaps less expensive tier. For example data that is expected to be used frequently for example database indices may be initially written directly to fast storage whereas data that is not expected to be accessed frequently for example backup or archived data may be initially written to slower storage.

The thin devices may appear to a host coupled to the storage device as a logical volume logical device containing a contiguous block of data storage. Each of the thin devices may contain pointers to some or all of the data devices or portions thereof as further discussed elsewhere herein. As illustrated in some embodiments only one thin device may be associated with a data device while in other embodiments multiple thin devices may be associated with the same data devices. In some instances an implementation according to the system described herein may allow for hybrid logical devices where a single logical volume has portions that behave as a data device and or portions that behave as a thin device.

A thin device presents a logical storage space to one or more applications running on a host where different portions of the logical storage space may or may not have corresponding allocated physical storage space associated therewith. However the thin device may not be mapped directly to physical storage space. Instead for example portions of the thin storage device for which physical storage space exists may be mapped to one or more data devices which are logical devices that map logical storage space of the data device to physical storage space on the disk drives . As further discussed elsewhere herein an access of the logical storage space of the thin device may result in either a null pointer or equivalent indicating that no corresponding physical storage space has yet been allocated or results in a reference to a data device or section thereof which in turn references the underlying physical storage space.

Each of the entries of the table correspond to another table that may contain information for one or more sections of a logical volume such as a thin device logical volume. For example the entry may correspond to a thin device table . The thin device table may include a header that contains overhead information such as information identifying the corresponding thin device information concerning the last used data device and or other information including counter information such as a counter that keeps track of used group entries described below . The header information or portions thereof may be available globally to the storage device .

The thin device table may include one or more group elements that contain information corresponding to a group of tracks on the data device. A group of tracks may include one or more tracks the number of which may be configured as appropriate. In an embodiment herein each group has twelve tracks although this number may be configurable or dynamically adjustable based on criteria described elsewhere herein.

One of the group elements for example the group element of the thin device table may identify a particular one of the data devices having a track table that contains further information such as a header having overhead information and a plurality of entries corresponding to each of the tracks of the particular one of the data device sections . The information in each of the entries may include a pointer either direct or indirect to the physical address on one of the disk drives of the storage device or a remote storage device if the system is so configured that maps to the logical address es of the particular one of the data devices . Thus the track table may be used in connection with mapping logical addresses of the logical device sections corresponding to the tables to physical addresses on the disk drives of the storage device .

The tables may be stored in the global memory of the storage device . In addition the tables corresponding to particular logical device sections accessed by a particular host may be stored cached in local memory of the corresponding one of the HA s . In addition the RA s and or the DA s may also use and locally store cache portions of the tables .

If it is determined at the step that there is physical data corresponding to the logical tracks being read then processing proceeds to a step where one or more of the data devices associated with the logical tracks being read are identified from the group table . After the step processing proceeds to a step where the track table is read from the identified one or more of the data devices and the corresponding location of the physical data i.e. cylinder and track is determined. Logical storage space maps to physical storage space of the physical devices. After the step processing proceeds to a step where a request may be sent to one or more disk adapters corresponding to disk drives that provide the physical storage space associated with the identified one of the data devices and corresponding location information. After the step processing proceeds to a step where the physical data is read. Note that the data may be stored in a cache or other memory for example the memory in connection with being read. In some cases if the data being read is already in the cache then the processing at the step and following steps may not be necessary. Note also that reading the data may include updating any metadata used to provide the processing described herein such as the time last accessed the host user making the request frequency of use and or any other appropriate metric. After the step processing proceeds to a step where the data may be received by an appropriate one of the host adapters e.g. by reading the memory . After the step processing is complete.

Following the step is a test step where it is determined whether physical space had been previously allocated i.e. in a prior write operation for the tracks being written. If so then processing proceeds to a step where the data device that includes the tracks is identified. After the step is a step where the track table is read from the identified one or more of the data devices and the corresponding location of the physical data i.e. cylinder and track is determined. As further discussed elsewhere herein physical storage space may be provided in connection with one data device including a concatenation of multiple data device portions. Storage space of the physical devices maps to logical storage space of the data devices. Following the step processing proceeds to a step where the data being written is directed to the appropriate physical storage space. As further discussed elsewhere herein data may be written among multiple devices in a striping process in which data is advantageously striped across the multiple devices. After the step processing is complete.

If it is determined at the step that there is no physical storage that has been allocated for the logical track s being written then control transfers to a step where a next available data device identifier i.e. the data device is determined. This information may be obtained from the header of the device table .

After the step processing proceeds to a step where available physical storage space on the disk drives is determined. In an embodiment herein available physical storage space is allocated sequentially from one or more of the disk drives . Following the step is a step where a request may be sent to a disk adapter or possibly the RA s to allocate the physical storage space for the write. Also at the step header info is updated to reflect the newly allocated data device and physical tracks. After the step processing proceeds to the step discussed above where the data being written is directed to the one or more data device sections. After the step processing is complete.

After the above described read and write processes information concerning access of the data such as access frequency time of last access or use and or other characteristics and statistics may be updated and stored by the system described herein. The updated data access information or other characteristic information of the data and or any portion of the data may for example be stored as an entry in a group element of the thin device table for example the entry of the group element . Alternatively the data characteristic information may be stored in a memory such as the global memory of the storage device and a pointer to this information stored in the group element . Other implementations for storing and access of the data characteristic information are possible.

The allocation of the physical storage space for a thin device at the time of writing the data as well as the policies that govern the allocation may be transparent to a user. For example a user s inquiry into how much storage space is available on a particular thin device may indicate a maximum amount of physical storage space that could be made available for a thin storage device even though the corresponding physical storage space had not yet been allocated. In an alternative embodiment the policy for the thin device may be to report something less than the total maximum that could be allocated. In some embodiments used unavailable physical storage space may not exceed a predetermined level e.g. 30 of the thinly provisioned storage capacity that appears available to the user. Other methods and features involving reservation and allocation of space are further discussed elsewhere herein.

As discussed elsewhere herein the data devices may be associated with physical storage areas e.g. disk drives tape solid state storage etc. having different characteristics. In various embodiments the physical storage areas may include multiple sub tiers of storage in which each sub tier of storage areas and or disk drives that may be ordered according to different characteristics and or classes such as speed technology and or cost. The thin devices may appear to a host coupled to the storage device and or e.g. the storage device as a logical volume logical device containing a contiguous block of data storage as discussed herein. Each of the thin devices may correspond to a particular data device a portion thereof and or multiple data devices. Accordingly each of the thin devices may map to storage areas across multiple storage volumes. As a result although each of the thin devices may appear as containing a logically contiguous block of storage each of the thin devices may allow for blocks of data to be transparently stored and or retrieved from discontiguous storage pools made up of the varying classes of storage. In this way the granularity at which the storage system described herein operates may be smaller than at the file level for example potentially as small as a single byte but more practically at the granularity of a single logical block or collection of sequential data blocks. A data block may be of any size including file system or database logical block size physical block track or cylinder and or other size. Multiple data blocks may be substantially the same size or different sizes such as different size data blocks for different storage volumes or different sized data blocks within a single storage volume. It is also noted that in other embodiments the thin device may be a metavolume of concatenated thin volumes devices as further discussed elsewhere herein.

The thin device may map to the different storage volumes although as noted above the mapping may not be a direct mapping to physical storage space. A particular thin device may indicate a maximum amount of physical storage space that could be allocated for the thin device thin provisioned storage space even though the corresponding physical storage space has not yet been allocated. As discussed herein the granularity of the system described herein may be less than at the file level and allow for blocks of data of any size to be stored across multiple storage volumes in a process that is transparent to the host and or host application.

According to an embodiment of the system described herein a portion of the thin device may point to a portion of the data device in connection with a mapping of data stored on the storage volume to one of the physical storage areas of the volume . In an embodiment in connection with moving data from the volume to the volume the pointer from the thin device portion may be modified to point to a new portion of a data device that maps to the new location of the data on the physical storage areas of the volume . Data may be moved among volumes of one or more storage pools to normalize utilization of the storage volumes for purposes of appropriately striping data across volumes of the storage pool following the addition of new empty volumes to a storage system. It is also noted that in various embodiments the system described herein may also be appropriately used in connection with sparse cloning that allows for more than one thin device to point to a data device as way of providing an efficient cloning mechanism. In this way cloning operations may be almost instantaneous involving just the setting of pointers and initially consume little or no additional physical storage space.

It is noted that in various embodiments of RAID systems one or more of the storage devices may be a parity device that is used in connection with error correction capability of the RAID system including the use of parity information that is stored on the parity device. Alternatively it is also noted that parity information may be stored across the storage devices rather than being stored in one parity device. Furthermore in various embodiments operations involving communication between the storage devices of the RAID system may provide mirrored copies of the data blocks replicated across the multiple storage devices and or operations with portions of the data blocks that are distributed across the multiple storage devices i.e. striping . Although illustrated with discrete storage devices in various embodiments the storage system may include any number of different configurations of disks disk drives or other storage media coupled to one or more interconnected directors and it should be noted that other configurations and types of systems involving multiple redundant storage may be used in connection with the system described herein.

In an embodiment the system described herein provides methods features and or techniques for guaranteeing sufficient space allocation for thin devices. A mechanism may be implemented that guarantees space availability for thin devices including user defined critical thinly provisioned devices without committing or fully pre allocating the space to specific thin device ranges. According to the system described herein space may be held in reserve for a particular set of thin devices and consumed as needed by those thin devices. The system guards user critical devices from running out of space for example due to a rogue device scenario in which one device allocates an excessive amount of space but without actually fully pre allocating the guaranteed space to the thin devices.

According to an embodiment of the system described herein a method is provided to reserve track groups of data devices to exclude them from a regular allocation process and keep them in a reserved list for allocation by particular thin devices upon a special request. It should be noted that although track groups are principally discussed herein the system described herein may also be applied to other appropriate segments and or designations of data storage. Furthermore although thin devices are principally discussed herein as subscribing devices of the system described herein other appropriate types of devices may also be used in connection with the system described herein. As further discussed elsewhere herein a reserved list of a data device device reserved list may include unallocated track groups of the data device that may be extracted from a free list the free list being a listing of track groups of a data device that are available for use. The device reserved list may provide a base for the track group reservation processing for the data device according to the system described herein.

In an embodiment the device reserved list may include a generic double linked GPDV list infrastructure that may be created to provide all the operations manipulations related to the GPDV list. The GPDV infrastructure may include an application programming interface API and related procedure functions. Both the free list and the device reserved list may utilize the same low level operational module provided by the GPDV infrastructure. As a double linked list the GPDV list may include forward and backward scan options. An information structure corresponding to the device reserved list may be added to the data device header and include a pointer GPDV to the first track group in the list a track groups counter and or a track groups limit. In an embodiment the information structure may be cleared during volume table of contents VTOC processing after creation of the free list. Initialization of the device reserved list may be performed upon a request that may include a valid reserved track groups limit. The pointer to the first track group may be invalidated during initialization defining an empty list and the track groups counter may be set to zero. The API of the device reserved list may include functions for the list initialization creation deletion adding freeing of track groups and also reading writing and displaying of the device reserved list information.

To consume space from the device reserved list a subscription mechanism may be used according to an embodiment of the system described herein. A thin device may reserve space from a thin storage pool and each thin device that requires a space reservation may subscribe to a reservation entity such as a container or list according to a subscription and or other type of space reservation request. Various embodiments of the type of reservation entity to which a thin device may subscribe are further discussed elsewhere herein. Subscription information of the thin device may be added to the thin device header for example as part of the thin device table discussed elsewhere herein. The subscription information may include a reservation entity ID a reservation entity type a subscribed reserved track groups counter a user reserved track groups counter and or other appropriate subscription information. A subscription request from a thin device may include a number of track groups that the thin device needs reserved.

In an embodiment the reservation entity subscribed to by the thin device may include a pool reservation container. The pool reservation container may contain a value that represents a number of reserved groups that may be consumed by any thin device subscribed to that pool reservation container. Reserved groups may be consumed from one or more or all of device reserved lists in a given pool. The reserved groups may be consumed according to a policy such as a round robin policy and or other appropriate policy. It is noted that multiple pool reservations containers may exist for each pool. The total number of reserved track groups defined by all pool reservation containers for a given pool may not exceed the total reserved capacity of the pool as defined by the total number of reserved groups in all the devices reserved lists in the pool. In an embodiment it may be noted that the pool reservation container may not actually contain any specific reserved track groups but rather may indicate a present reserved capacity which may be drawn upon. Accordingly reservation of track groups by a thin device using the pool reservation container may correspond to a particular percentage of reserved track groups e.g. 5 10 etc. that are reserved for each subscribing thin device.

In the illustrated example the pool reservation container pool reservation container indicates track groups are reserved for use from the unallocated track groups of the pool and the pool reservation container pool reservation container indicates track groups. Each of the device reserved lists of the data devices may include entries corresponding to both of the pool reservation containers . The entries of the device reserved lists may identify reserved space on each of the data devices for each pool reservation container . Thin devices may subscribe to the pool reservation containers .

In an embodiment only thin devices bound to the pool may be subscribed to the one or more pool reservation containers of that pool. A subscription request from each thin device may include a number of track groups to be reserved for the device although the actual number may be adjusted according to the number of track groups remaining in one or more device reserved lists associated with the request. It is further noted that a pool reservation container may be created upon a first subscription request from a bound thin device if a pool reservation container does not currently exist.

For example the thin devices may subscribe to the pool reservation container container which information may be included in header entries of the thin devices . Accordingly the 39 unallocated track groups reserved by the pool reservation container may be available to the thin devices . Further the thin devices may include header entries with information of the track groups reserved by the thin devices e.g. as included in the subscription requests sent by each of the thin devices . The thin device is illustrated as indicating reserved track groups in the header entry and the thin device is illustrated as indicating reserved track groups in the header entry . Similarly the thin device may subscribe to the pool reservation container container which information may be included in a header entry of the thin device . Accordingly the 23 unallocated track groups reserved by the pool reservation container may be available to the thin device . The thin device may include a header entry with information of the track groups reserved by the thin device e.g. as included in the subscription request sent by the thin device . The thin device is illustrated as indicating reserved track groups in the header entry . Although not shown other information as further discussed elsewhere herein may also be included in the thin device headers.

The total number of reserved track groups for each of the pool reservation container for a given pool may not exceed the total reserved capacity of the pool as defined by the total number of reserved groups in all the device reserved lists for each pool reservation in the pool. For example as shown entries for the device reserved lists corresponding to the pool reservation container container each indicate reserved tracks groups on the data devices i.e. and track groups that equal the total track groups indicated by the pool reservation container that are available to thin devices subscribed to pool reservation container . Similarly entries for the device reserved lists corresponding to the pool reservation container container each indicate reserved tracks groups on the data devices i.e. and track groups that equal the total track groups indicated by the pool reservation container that are available to the thin device subscribed to pool reservation container .

Further each of the pool reservation containers may indicate the number of track groups that have been reserved by subscribed thin devices . For example as shown of the 39 total track groups indicated as reserved from the pool by the pool reservation container container track groups are identified as reserved by the subscribing thin devices . Similarly of the 23 total track groups indicated as reserved from the pool by the pool reservation container container track groups are indicated as reserved by the subscribing thin device . Although not shown other information as further discussed elsewhere herein may also be included in the pool reservation containers . Additionally in various embodiments one or more of the thin devices may subscribe to multiple pool reservation containers and the information reflecting multiple subscriptions may be appropriately identified in headers of the thin devices .

The default reservation container may be created upon a first subscription request from a bound thin device if the default reservation container does not exist yet. Information of the default reservation container may be added to the pool data structure and or a separate data structure accessed by the pool and may include a default reservation container ID associated with the pool a total reserved track groups counter in the pool and a used subscribed reserved track groups counter in the pool . For example the default reservation container is shown as identifying 62 total track groups reserved from the pool .

The thin devices may subscribe to the default reservation container which information may be included in header entries of the thin devices shown as ID . In an embodiment since only one default reservation pool container may be contained in the pool an identification of the pool e.g. the pool number may be used as the container ID stored in the header entries of the subscribing thin devices . Accordingly the 62 unallocated track groups reserved by the default reservation container may be available to the thin devices . Similarly to the discussion involving the pool reservations containers the thin devices may include header entries with information of the track groups reserved by the thin devices e.g. as included in the subscription requests sent by each of the thin devices with respect to the default reservation container . For example the thin device is illustrated as indicating reserved track groups in the header entry the thin device is illustrated as indicating reserved track groups in the header entry and the thin device is illustrated as indicating reserved track groups in the header entry . Although not shown other information as further discussed elsewhere herein may also be included in the thin device headers. The 46 track groups reserved by the subscribing thin devices is shown in the information contained in the default reservation container .

One or more thin devices e.g. the thin device may subscribe to the global reservation list according to a reservation policy defined for the thin device as further discussed elsewhere herein. A subscription request from the thin device may include a number of track groups reserved for the thin device . The information structure of the global reservation list may be included in the global memory of one or more of storage devices according to the system described herein and or in any other appropriate storage location as further discussed elsewhere herein. The data for the global reservation list may include numbers of device reserved lists of data devices included in the global reservation list a total reserved track groups counter in the global reservation list a used subscribed reserved track groups counter in the global reservation list a track groups limit in the global reservation list and or other appropriate information. As shown in the illustrated embodiment the global reservation list identifies four device reserved lists across the multiple pools .

One or more reservation policies per thin device may be used according to the system described herein that define whether a particular thin device is allowed to subscribe to a reservation entity. For example a default reservation policy may be that a thin device cannot subscribe to a pool to which the thin device is not bound. Other reservation policies may however be used in connection with the system described herein with respect to one or more thin device devices.

After the step processing proceeds to a step where track groups from one or more pools are reserved for allocation according to the requirements of the subscription request. In various embodiments the device reserved lists on one or more of the data devices may be updated to indicate a number of track groups that are now reserved for the subscribing thin device by modifying header information of the data device. As further discussed elsewhere herein the track groups reserved may include non specific track groups and or may include specific track group ranges depending upon the type of reservation entity to which the thin device is subscribed. After the step processing is complete.

According to various embodiments one or more allocation policies may be used according to the system described herein that defines the order relative to the free list in which the reserved track groups are allocated to thin devices i.e. consumed during the allocation process. For example a default allocation policy may include that the reserved track groups are allocated last during the allocation process. That is in an embodiment an allocation request under normal allocation processing to service I O operations of a thin device may be filled initially if possible from the free list of a data device before drawing upon the device reserved list for a particular thin device. It is noted however that other appropriate allocation policies may be used in connection with the system described herein with respect to one or more thin device devices.

If at the test step it is determined that the allocation request cannot be serviced from the one or more free lists then processing proceeds to a test step where it is determined whether the requesting thin device is subscribed to a reservation entity i.e. container list corresponding to the identified data devices according to the system described herein. If not then processing proceeds to a step where error processing and or alternative processing is performed with respect to the allocation request of the requesting thin device. After the step processing is complete. If at the test step it is determined that the requesting thin device is subscribed to the reservation entity then processing proceeds to a step where track groups from the reservation entity corresponding to the requesting thin device are used to service the allocation request of the requesting thin device according to the system described herein. It is noted that in other embodiments and depending on a particular allocation policy the test step may be modified and or eliminated if allocation requests are not to be serviced from the one or more free lists before applying the reservation entity processing according to the system described herein. After the step processing is complete.

Various embodiments discussed herein may be combined with each other in appropriate combinations in connection with the system described herein. Additionally in some instances the order of steps in the flowcharts flow diagrams and or described flow processing may be modified where appropriate. Further various aspects of the system described herein may be implemented using software hardware a combination of software and hardware and or other computer implemented modules or devices having the described features and performing the described functions. Software implementations of the system described herein may include executable code that is stored in a computer readable storage medium and executed by one or more processors. The computer readable storage medium may include a computer hard drive ROM RAM flash memory portable computer storage media such as a CD ROM a DVD ROM a flash drive and or other drive with for example a universal serial bus USB interface and or any other appropriate tangible storage medium or computer memory on which executable code may be stored and executed by a processor. The system described herein may be used in connection with any appropriate operating system.

Other embodiments of the invention will be apparent to those skilled in the art from a consideration of the specification or practice of the invention disclosed herein. It is intended that the specification and examples be considered as exemplary only with the true scope and spirit of the invention being indicated by the following claims.

