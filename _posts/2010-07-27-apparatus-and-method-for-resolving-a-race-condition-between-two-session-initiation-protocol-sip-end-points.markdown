---

title: Apparatus and method for resolving a race condition between two session initiation protocol (SIP) end points
abstract: An apparatus and method are described for resolving a glare condition between two SIP endpoints. The method allows a third party call control controller to resolve the glare condition when the ownership status of each dialog is the same, by initiating a back-off period of time at the apparatus based on the ownership status of the SIP dialog and re-sending a re-INVITE message to the end point after expiry of the back-off period of time.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08626849&OS=08626849&RS=08626849
owner: BlackBerry Limited
number: 08626849
owner_city: Waterloo, Ontario
owner_country: CA
publication_date: 20100727
---
This application claims the benefit of U.S. Provisional Application No. 61 328 400 filed Apr. 27 2010 the entirety of which is hereby incorporated by reference.

The disclosure relates to Session Initiation Protocol SIP sessions and in particular to resolving race conditions in SIP sessions established through an intermediary.

With the growth of the networks and the Internet Internet Protocol IP telephony is becoming increasingly popular. Often referred to as Voice over IP VoIP it can be used to establish communication between two end points.

In order to establish the communication the two endpoints exchange messages in order to establish a dialog that describes the characteristics of the communication. The dialog may establish the type of media to be exchanged for example video and or audio as well as the protocol used to transfer the communication.

When two endpoints attempt to modify an existing dialog at approximately the same time a race condition exists. The condition is often referred to as a glare condition and can be resolved using a back off time when the two endpoints establish the call between each other directly.

When an intermediary is used to establish the call between two endpoints it may be difficult to resolve the glare condition. Various attempts of addressing this glare condition have been considered however these have included modifying the Session Initiation Protocol SIP used to control VoIP calls. Therefore there is a need for an improved method and apparatus for addressing glare conditions in SIP.

In one aspect the present disclosure provides a method of resolving at an intermediary server a glare condition between two end points exchanging media each endpoint having a session initiation protocol SIP dialog with the intermediary server the intermediary server having the same ownership status of each SIP dialog. The method comprises receiving a first re INVITE message from a first end point of the two end points receiving a second re INVITE message from a second end point of the two end points sending a first 491 Request Pending message to the second endpoint in response to the received second re INVITE message receiving a second 491 Request Pending from the second endpoint initiating a back off period of time based on the ownership status of the second SIP dialog and re sending the first re INVITE message to the second end point after expiry of the back off period of time.

In another aspect the present disclosure provides an apparatus for resolving a glare condition between two end points exchanging media each endpoint having a session initiation protocol SIP dialog with the apparatus the apparatus having the same ownership status of each SIP dialog. The apparatus comprises a memory for storing instructions and a processor coupled to the memory for executing the instructions stored in the memory. The instructions configure the apparatus to receive a first re INVITE message from a first end point of the two end points receive a second re INVITE message from a second end point of the two end points send a first 491 Request Pending message to the second endpoint in response to the received second re INVITE message receive a second 491 Request Pending from the second endpoint initiate a back off period of time based on the ownership status of the second SIP dialog and re send the first re INVITE message to the second end point after expiry of the back off period of time.

In yet another aspect the present disclosure provides a computer readable media storing instructions for execution by a processor the instructions for implementing a method of resolving at an intermediary server a glare condition between two end points exchanging media each endpoint having a session initiation protocol SIP dialog with the intermediary server the intermediary server having the same ownership status of each SIP dialog. The method comprises receiving a first re INVITE message from a first end point of the two end points receiving a second re INVITE message from a second end point of the two end points sending a first 491 Request Pending message to the second endpoint in response to the received second re INVITE message receiving a second 491 Request Pending from the second endpoint initiating a back off period of time based on the ownership status of the second SIP dialog and re sending the first re INVITE message to the second end point after expiry of the back off period of time.

Other aspects of the present disclosure will be apparent to those of ordinary skill in the art from a review of the following detailed description in conjunction with the drawings. Embodiments of the present disclosure are not limited to any particular operating system mobile device architecture server architecture or computer programming language.

The present disclosure relates to the control and management of communications. Although reference may be made to calls in the description of example embodiments below it will be appreciated that the described systems and methods are applicable to session based communications in general and not limited to voice calls.

A call can be established between two SIP end points through a third party. This is referred to as 3PCC. In 3PCC the 3PCC controller establishes respective SIP dialogs with each SIP end point by exchanging control messages with the end points . Each SIP dialog describes the characteristics of the call and may be described in accordance with Session Description Protocol SDP . SDP may be used to describe the media for example audio and or video streams to exchange between the two end points. Once the dialogs have been established between the end points and the 3PCC controller media can be exchanged directly between the SIP end points . Although the media is described as being exchanged directly between the SIP endpoints it will be appreciated that this is with regards to the 3PCC controller . That is the media exchanged between the SIP endpoints may pass between various servers routers switches etc however it does not need to pass through the 3 PCC controller .

As depicted in the 3PCC controller sends an INVITE message to the first SIP endpoint . The INVITE does not contain an SDP. The first SIP endpoint responds with a 200 OK message assuming the party wishes to establish the call. The 200 OK message includes an offer from the SIP endpoint. The offer specifies the characteristics of the call the endpoint wishes to establish. The offer may be described using Session Description Protocol SDP and may include information about different content streams such as the type of media codecs used locations and ports of the stream etc. The particular offer is depicted as SDP in . The requirements of defining an offer using SDP are described in RFC 2327 which is hereby incorporated by reference in its entirety. The 3PCC controller receives the offer from the first SIP endpoint and sends an INVITE message to the second SIP endpoint . The second INVITE includes the offer sent from the first SIP endpoint SDP . The second SIP endpoint receives the INVITE and assuming the party wishes to establish the call responds with a 200 OK message . The 200 OK message includes an answer to the offer received in the INVITE. The answer similar to an offer specifies the characteristics of the call the endpoint is willing and or able to establish. The answer may be described in accordance with SDP and is depicted as SDP in . The 3PCC controller sends an ACK message back to the second SIP endpoint . After receiving the answer SDP from the second SIP endpoint the 3PCC controller responds to the first 200 OK message initially sent from the first endpoint with an ACK message . The ACK message includes the answer SDP from the second SIP endpoint. Each endpoint now has the call characteristics the other endpoint can establish such as the location of a media stream and so an exchange of media between the two endpoints can be established. The media may be exchanged using real time transport protocol RTP messages as depicted. However other types of messages can be exchanged if described in the respective SDPs sent by the endpoints.

The message flow of depicts one possible way of establishing a call between two SIP endpoints through a 3PCC controller. It will be appreciated that other message flows are possible. Furthermore the call does not need to be initiated by the 3PCC controller and may be initiated by one or both of the endpoints initiating a dialog with the 3PCC controller.

Once a SIP call has been established between two endpoints either endpoint may attempt to modify the characteristics by sending a re INVITE message that includes a new SDP description. The other endpoint may accept the modification by sending a 200 OK message that includes its SDP. This may be used for example to provide music on hold functionality.

A problem may arise when both endpoints attempt to modify the characteristics at the same time for example both endpoints send re INVITE messages at the same time or before receiving the re INVITE from the other endpoint. This is referred to as a glare condition and can be addressed using a 491 Request Pending message. Upon receiving a 491 Request Pending message a SIP end point will wait a period of time referred to as the back off time period before retrying the re INVITE. In order to ensure that the two SIP endpoints do not retry the re INVITE at the same time the back off time period used by each endpoint is determined based on ownership status of the SIP dialog. That is if the SIP end point owns or initiated the dialog. If the SIP endpoint did not initiate the call the back off time is selected between 0 and 2 seconds. If the SIP endpoint initiated the call the back off time is selected between 2.1 and 4 seconds. This works well as long as the ownership of the dialogs is different for each endpoint. However in 3PCC the ownership of each dialog may be the same at each endpoint.

As seen in after the two SIP dialogs have been established both endpoints attempt to modify the characteristics by sending a re INVITE message to the 3PCC controller. The first SIP endpoint sends a re INVITE message with a new offer specifying the new characteristics SDP . The 3PCC controller forwards the re INVITE request with SDP onto the second end point . However before the re INVITE SDP arrives at the second endpoint the second endpoint also sends a re INVITE message . The re INVITE message sent from the second endpoint includes a new offer specifying the new characteristics SDP . The 3PCC controller receives the re INVITE SDP message from the second SIP endpoint before receiving the expected 200 OK message. As such the 3PCC controller sends a 491 Request Pending message to the second SIP endpoint which the second SIP endpoint responds to with an ACK . Similarly the second SIP endpoint receives the re INVITE SDP prior to receiving the expected 200 OK message and so sends a 491 Request Pending message to the 3PCC controller. The 3PCC controller sends an ACK back to the second SIP endpoint and forwards the 491 Request Pending message onto the first SIP endpoint. The first SIP endpoint sends an ACK message back to the 3PCC controller.

Upon receiving the 491 Request Pending messages both the SIP end points initiate a back off time . However since both dialogs between the endpoints and the 3PCC controller are owned by the 3PCC controller the back off time is selected from within the same interval. As such the back off time selected by each end point may be the same either because the SIP endpoint does not select a random back off time or because the randomly selected back off time selected by each endpoint happens to be the same. After the back off time has expired each endpoint retries the respective re INVITE message . This results in the same glare condition existing.

The method as described above resolves the glare condition at a 3PCC controller. Since the 3PCC controller and the second endpoint will not have the same ownership state of the dialog as it is not possible for both the second endpoint and the 3PCC controller to have initiated the dialog each will select a back off time from a different time window as required by SIP.

The system and methods described above can advantageously provide shorter audio recovery times when resolving glare conditions at a 3PCC controller. Furthermore the method does not require modification to SIP endpoints and as such as long as the SIP endpoints correctly implement the SIP protocol the glare conditions can be resolved.

As will be appreciated the 3PCC controller apparatus and method described above may be implemented in various environments. For example a web server that provides click to dial functionality may include the 3PCC controller functionality described herein. Additionally or alternatively the 3PCC controller functionality may be included in an enterprise network that provides for the control and management of communications.

The enterprise network may be connected often through a firewall to a wide area network WAN such as the Internet. The enterprise network may also be connected to a public switched telephone network PSTN via direct inward dialing DID trunks or primary rate interface PRI trunks.

The enterprise network may also communicate with a public land mobile network PLMN which may also be referred to as a wireless wide area network WWAN or in some cases a cellular network. The connection with the PLMN may be made via a relay as known in the art.

The enterprise network may also provide a wireless local area network WLAN featuring wireless access points. Other WLANs may exist outside the enterprise network . For example WLAN may be connected to WAN .

The system may include a number of enterprise associated mobile devices only one shown . The mobile devices may include devices equipped for cellular communication through the PLMN mobile devices equipped for Wi Fi communications over one of the WLANs or dual mode devices capable of both cellular and WLAN communications. WLANs may be configured in accordance with one of the IEEE 802.11 specifications.

It will be understood that the mobile devices include one or more radio transceivers and associated processing hardware and software to enable wireless communications with the PLMN and or one of the WLANs . In various embodiments the PLMN and mobile devices may be configured to operate in compliance with any one or more of a number of wireless protocols including GSM GPRS CDMA EDGE UMTS EVDO HSPA 3GPP LTE or a variety of others. It will be appreciated that the mobile device may roam within the PLMN and across PLMNs in known manner as the user moves. In some instances the dual mode mobile devices and or the enterprise network are configured to facilitate roaming between the PLMN and a WLAN and are thus capable of seamlessly transferring sessions such as voice calls from a connection with the cellular interface of the dual mode device to the WLAN interface of the dual mode device and vice versa.

The enterprise network typically includes a number of networked servers computers and other devices. For example the enterprise network may connect one or more desktop or laptop computers one shown . The connection may be wired or wireless in some embodiments. The enterprise network may also connect to one or more digital telephone sets one shown .

The enterprise network may include one or more mail servers such as mail server for coordinating the transmission storage and receipt of electronic messages for client devices operating within the enterprise network . Typical mail servers include the Microsoft Exchange Server and the IBM Lotus Domino server. Each user within the enterprise typically has at least one user account within the enterprise network . Associated with each user account is message address information such as an e mail address. Messages addressed to a user message address are stored on the enterprise network in the mail server . The messages may be retrieved by the user using a messaging application such as an e mail client application. The messaging application may be operating on a user s computer connected to the enterprise network within the enterprise. In some embodiments the user may be permitted to access stored messages using a remote computer for example at another location via the WAN using a VPN connection. Using the messaging application the user may also compose and send messages addressed to others within or outside the enterprise network . The messaging application causes the mail server to send a composed message to the addressee often via the WAN .

The relay serves to route messages received over the PLMN from the mobile device to the corresponding enterprise network . The relay also pushes messages from the enterprise network to the mobile device via the PLMN .

The enterprise network also includes an enterprise server . Together with the relay the enterprise server functions to redirect or relay incoming e mail messages addressed to a user s e mail address within the enterprise network to the user s mobile device and to relay incoming e mail messages composed and sent via the mobile device out to the intended recipients within the WAN or elsewhere. The enterprise server and relay together facilitate push e mail service for the mobile device enabling the user to send and receive e mail messages using the mobile device as though the user were connected to an e mail client within the enterprise network using the user s enterprise related e mail address for example on computer .

As is typical in many enterprises the enterprise network includes a Private Branch eXchange although in various embodiments the PBX may be a standard PBX or an IP PBX for simplicity the description below uses the term PBX to refer to both having a connection with the PSTN for routing incoming and outgoing voice calls for the enterprise. The PBX is connected to the PSTN via DID trunks or PRI trunks for example. The PBX may use ISDN signalling protocols for setting up and tearing down circuit switched connections through the PSTN and related signalling and communications. In some embodiments the PBX may be connected to one or more conventional analog telephones . The PBX is also connected to the enterprise network and through it to telephone terminal devices such as digital telephone sets softphones operating on computers etc. Within the enterprise each individual may have an associated extension number sometimes referred to as a PNP private numbering plan or direct dial phone number. Calls outgoing from the PBX to the PSTN or incoming from the PSTN to the PBX are typically circuit switched calls. Within the enterprise e.g. between the PBX and terminal devices voice calls are often packet switched calls for example Voice over IP VoIP calls. The PBX may provide the SIP endpoints described above and bridge them with external or internal communication devices such as phones connected to PSTN .

The enterprise network may further include a Service Management Platform SMP for performing some aspects of messaging or session control like call control and advanced call processing features. The SMP may implement the 3PCC controller functionality described above . The SMP may in some cases also perform some media handling. Collectively the SMP and PBX may be referred to as the enterprise communications platform generally designated . It will be appreciated that the enterprise communications platform and in particular the SMP is implemented on one or more servers having suitable communications interfaces for connecting to and communicating with the PBX and or DID PRI trunks. Although the SMP may be implemented on a stand alone server it will be appreciated that it may be implemented into an existing control agent server as a logical software component.

The enterprise communications platform implements the switching to connect session legs and may provide the conversion between for example a circuit switched call and a VoIP call or to connect legs of other media sessions. In some embodiments in the context of voice calls the enterprise communications platform provides a number of additional functions including automated attendant interactive voice response call forwarding voice mail etc. It may also implement certain usage restrictions on enterprise users such as blocking international calls or 1 900 calls. In many embodiments Session Initiation Protocol SIP may be used to set up manage and terminate media sessions for voice calls. Other protocols may also be employed by the enterprise communications platform for example Web Services Computer Telephony Integration CTI protocol Session Initiation Protocol for Instant Messaging and Presence Leveraging Extensions SIMPLE and various custom Application Programming Interfaces APIs as will be described in greater detail below.

One of the functions of the enterprise communications platform is to extend the features of enterprise telephony to the mobile devices . For example the enterprise communications platform may allow the mobile device to perform functions akin to those normally available on a standard office telephone such as the digital telephone set or analog telephone set . Example features may include direct extension dialing enterprise voice mail conferencing call transfer call park etc.

Certain adaptations and modifications of the described embodiments can be made. Therefore the above discussed embodiments are considered to be illustrative and not restrictive.

