---

title: Method and apparatus for filtering E-mail
abstract: A server is disclosed for filtering e-mail messages. The server receives requests to retrieve e-mail messages on behalf of a client and then retrieves e-mail messages from a mail server on behalf of the client. The server then filters the e-mail messages based on one or more rules and transfers the filtered e-mail messages to the client. In addition, the server continues to filter the e-mail messages after the client has disconnected from the server. In one embodiment of the invention the e-mail message recipient is sent a notification by the server indicating that messages have been filtered. The recipient is then able to scan the filtered messages and insure that the messages have been filtered correctly. In another embodiment, a third party scans the e-mail messages on behalf of the e-mail user to make this determination. Also disclosed is an e-mail filter comprising an application programming interface and a plurality of dynamically loaded rule modules adapted to interface with the API. The rule modules are activated and deactivated based on usage. Specifically, rule modules which have not been used for a predetermined period of time are deactivated. In addition, different rule modules are assigned different weighted values based on the probability that the rule module will accurately filter e-mail messages and/or on the content of the e-mail messages.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=RE041940&OS=RE041940&RS=RE041940
owner: Symantec Corporation
number: RE041940
owner_city: Mountain View
owner_country: US
publication_date: 20100131
---
This invention relates to the filtering of electronic mail hereinafter e mail . More particularly the present invention relates to a method and apparatus by which dynamic filtering techniques are applied to filter out unwanted e mail messages at various stages of transmission across one or more networks.

The rapid increase in the number of users of e mail and the low cost of distributing electronic messages via the Internet and other electronic communications networks has made marketing via the Internet an attractive medium for productivity workflow advertising and business and personal communication. Consequently e mail and Internet newsgroups are now frequently used as the medium for widespread marketing broadcasts. These unwanted messages are commonly referred to as spam. 

Spam is more than just an annoyance to Internet users it represents a significant threat to the stability of vast numbers of computers and networks which comprise the Internet community. Internet service providers hereinafter ISPs online services and corporations spend millions of dollars each year attempting to control spam. In fact some spam distributions are so large in scope that they have the ability to crash large ISP and corporate servers. One of the reasons why spam is so pervasive is that spammers require only a computer an address list and Internet access to distribute spam to potentially millions of Internet users. In sum if not properly controlled spam is capable of disabling significant portions of the Internet.

There are a number of known methods for filtering spam including Realtime Blackhole List RBL filtering Open Relay Blocking System ORBS and Procmail rules and recipes. Frequently these methods are designed to block spam from particular e mail addresses from which spam is known to originate. For example filtering methods used by America On Line and Prodigy use exclusion filters which block e mail messages received from addresses that are suspected sources of spam. However this approach is vulnerable to rapid changes in the source of unsolicited e mail. Furthermore because online services will generally not automatically block e mail addresses from their members these services are provided only if the user requests them.

One additional known e mail filtering techniques are based upon an inclusion list such that e mail received from any source other than one listed in the inclusion list is discarded as junk. However these methods require the user or the service provider to continually update the inclusion list manually because like viruses spam is constantly being modified to bypass static filters. If the inclusion list is not updated regularly the list will quickly become outdated resulting in the exclusion of desired e mail messages from new sources and the continued inclusion of spam from old sources.

The Assignee of the present invention has developed improved techniques for filtering e mail. Some of these techniques are described in related U.S. patent applications entitled UNSOLICITED E MAIL ELIMINATOR U.S. Pat. No. 5 999 992 and APPARATUS AND METHOD FOR CONTROLLING DELIVERY OF UNSOLICITED ELECTRONIC MAIL U.S. Pat. No. 6 052 709.

The present application sets forth additional techniques for filtering e mail. What is needed is an improved system and method for dynamically updating e mail filter technology to meet the threat posed by ever changing varieties of spam. In addition what is needed is a system and method for filtering e mail which can be easily implemented by the typical e mail user. What is also needed is an anti spam system and method which can be applied without the need to upgrade computer systems and networks currently available.

Disclosed is a server having a processor and a memory coupled to the processor the memory having stored therein sequences of instructions which when executed by the processor cause the processor to perform the steps of 1 receiving a request to retrieve e mail messages on behalf of a client 2 retrieving one or more e mail messages from a mail server on behalf of the client and 3 filtering the e mail messages based on one or more rules to produce one or more filtered e mail messages.

Also disclosed is a first server having a processor and a memory coupled to the processor the memory having stored therein sequences of instructions which when executed by the processor cause the processor to perform the steps of retrieving messages from a second server on behalf of a client sorting messages into two or more groups based on one or more rules and forwarding messages sorted into one of the groups to the client.

Also disclosed is an e mail filter comprising an application programming interface API and a plurality of rule handling filter modules adapted to interface with the API.

Depending on the system configuration however one of ordinary skill in the art will readily recognize from the following discussion that different types of mail servers clients and software could be employed without departing from the underlying principles and scope of the present invention. Accordingly while the embodiment discussed below uses an Internet communication channel for communication between clients and mail server numerous other communication schemes such as a direct connection to mail server etc. could be implemented as well.

The following is a general description of how client sends e mail to client . Each client is capable of executing e mail application programs generally illustrated in as user agent and user agent . User agents are capable of accepting commands for composing receiving and replying to e mail messages. E mail user agents known in the art include Microsoft Outlook Lotus cc mail Lotus Notes Eudora Novell Groupwise and Netscape Communicator . To send an e mail to client client provides its user agent with a message and a destination address. The destination address uniquely identifies client s mailbox on mail server . Server in this embodiment provides a message transport system hereinafter MTS for receiving and storing incoming e mail messages in mailbox . E mail is sent over the Internet from client to mail server via a TCP connection to port . At the application level the protocol used to send e mail is usually the Simple Mail Transfer Protocol hereinafter SMTP .

If client is connected to the same LAN as mail server client s user agent may continually check mailbox e.g. every 10 minutes for new e mail messages. Alternatively client may need to connect to mail server by dialing out over a telephone line using a modem i.e. either by dialing directly to mail server or dialing out and connecting to mail server over the Internet . This would typically be the case for a home computer user who has an account with an Internet Service Provider or online service or a user who must dial out to connect to his corporate LAN.

For the purposes of the following discussion when client dials out to connect to mail server to check mailbox it communicates with mail server using Post Office Protocol 3 hereinafter POP3 . It should be noted however that different standard and proprietary mail protocols such as the Interactive Mail Access Protocol hereinafter IMAP the Distributed Mail System Protocol hereinafter DMSP X.400 and Lotus Notes may be implemented without departing from the scope of the present invention.

In the transaction state user agent sends mail server a LIST command at . If there is new mail in mailbox server responds to the LIST command with the number of new messages 100 in the example at . User agent then retrieves the e mail messages one at a time using a RETR command starting at . Finally after user agent has received all messages user agent issues the QUIT command at and the POP3 connection is terminated at . This final state is the referred to as the update state. During the update state mail server updates mailbox by removing all messages marked as deleted and releases its lock on mailbox .

If client previously sent an e mail message to client as described above client s e mail will be one of the 100 messages retrieved from mail server . However if client is a spammer sending client an unwanted solicitation client will have wasted hard drive space line access time cost and personal time downloading the e mail message. This inefficiency and waste becomes more significant if a substantial percentage of all 100 e mail messages stored in mailbox are spam. Moreover if client is communicating with mail server through a modem dial up connection rather than over a LAN the time and cost associated with downloading unwanted content is even more significant given the current speed limitations of modems currently less than 56 000 bits sec and the access cost of ISPs. Accordingly it would be beneficial to provide an e mail filter to remove spam from mailbox before time is wasted downloading and storing it.

As set forth in U.S. Pat. No. 6 052 709 entitled APPARATUS AND METHOD FOR CONTROLLING DELIVERY OF UNSOLICITED E NAIL rules applied to filter module may be established based on information collected using spam probes. A spam probe is an e mail address selected to make its way onto as many spam mailing lists as possible. It is also selected to appear high up on spammers lists in order to receive spam mailings early in the mailing process e.g. using the e mail address aardvark aol.com ensures relatively high placement on an alphabetical mailing list herein incorporated by reference.

Spam collected from various spam probes is then analyzed and rules are established based on this analysis. For example in one embodiment source header data from incoming e mail is analyzed. If the network address contained in the source header is identified as the network address of a known spammer a rule will be established to filter all incoming e mail from this network address into the spam storage area . Rules may also be established which identify spam based on a mathematical signature e.g. a checksum of the spam e mail body or portions of the e mail body . Any incoming message which contains the identified signature will subsequently be forwarded into the spam storage area . Rules based on keywords in the subject or body of spam e mail may also be established. For example all e mails containing the two words sex and free may be identified as spam and filtered. In one embodiment mail marked as potential spam is transferred to a control center where it is inspected e.g. by a computer technician before being sent to the spam storage area .

In addition a dynamically updated inclusion list may be generated at server . The inclusion list initially screens e mail header fields of all incoming e mail messages. All messages that appear on the list are passed through to mailbox . E mail received from sources other than those on the inclusion list are processed by additional anti spam rules as described herein. In one embodiment the inclusion list is simply one of the plurality of rules acting on filter module. In another embodiment the inclusion list is a separate software module executing on server . The end result is the same regardless of which embodiment is used.

Because spam is continuously being created and modified by spammers a system is needed in which rules for filtering spam can be easily updated. In addition an e mail filtering system is needed which is easily modified to suit the unique preferences of individual e mail users and which can be easily adapted to run on proprietary e mail systems. To address these and other issues an improved filter module is illustrated in FIG. . The improved filter module includes an anti spam application programming interface hereinafter API which runs on a message transfer agent or other components of an e mail transmission system including a POP3 server. As is known in the art an API includes a plurality of subroutines which can be invoked by application software i.e. software written to operate in conjunction with the particular API . Thus in rule handling filter modules and are dynamically loaded into memory to meet the needs of new filtering or e mail processing methods. The modules interface with API by making calls to the API s set of predefined subroutines. In one embodiment a portion of the API subroutines and a set of prefabricated rule handling filter modules can be marketed as a Software Development Kit hereinafter SDK . This will allow ISPs corporations and or end users to customize the type of e mail filtering which they require. In addition because modules are dynamically linked they may be loaded and unloaded without having to shut down the application or reboot the system on which the filter module is executed.

Referring again to in one embodiment each one of the rule handling filter modules filters spam based on different criterion. For example filter module RS A may filter spam based on a specific keyword search whereas filter module RS B may filter spam based on a mathematical signature e.g. a checksum RS E may perform a virus check on incoming e mail messages and RS C may be an inclusion list. Other contemplated rule handling filter modules will filter e mail based on 1 word or letter frequency analysis 2 IP source frequency analysis 3 misspelling analysis unwanted e mail often contains misspelled words 4 word or letter combination analysis 5 technical or legal RFC822 header compliance and 6 feature extraction analysis e.g. based on phone numbers URL s addresses etc. . It should be noted that all of the rule handling filter modules described herein may be combined or applied over a distributed array of filters throughout a network.

Referring again to if a spammer makes a slight modification to his message in order to circumvent for example the mathematical signature module RS B the module can be updated to include the new mathematical signature of the spammer s modified message without affecting the remaining modules. Thus an improved filter module is described which allows continuous user specific modifications to a plurality of rule modules .

It should be noted that the rule based filtering method and apparatus described herein can be implemented at virtually any point along the e mail transmission path from client to server to client . For example on mail server an embodiment of filter module can be located at a point in server where e mail messages are transmitted to client or at a point where the messages are received as shown in FIG. . In an alternative embodiment mail server initially stores all incoming messages in a message store and periodically applies filter to all message in the message store.

In addition Client can itself contain an embodiment of filter module . Therefore Client can apply filter module periodically as described above with reference to server or alternatively can apply filter module to all incoming e mail messages. Filter module can also be applied within a mail relay residing on network . In sum filter module may be applied at any node through which e mail messages are transmitted.

In another embodiment the rules used by filter module are continually monitored by server . If a rule has not been used to filter spam for a predetermined length of time e.g. a month that rule may be moved from an active to an inactive state and no longer applied to filter unless the type of spam for which it was created reappears . This type of rule aging system is useful given the fact that older types of spam are continually replaced with new types. If not removed as described above the number of outdated rules would build up an unmanageable level and filter module may become inefficient at removing spam applying numerous obsolete rules to the incoming e mail stream .

Additionally in one embodiment rules applied to filter module are weighted based on one or more variables including but not limited to spam content probability of positive spam identification and frequency of use. For example a rule which is geared towards screening e mail messages containing sexual content e.g. in a home where children use the computer which filters e mail based on the keywords sex and free may be given a weight value of 10 on a scale from 1 to 10. However a rule which screens e mail based merely on the keyword free may be weighted with e.g. a weight value of 2.

E mail messages can also be weighted based on the probability that the filter has correctly identified the filtered e mail message as spam. For example a positive spam identification under a mathematical analysis e.g. a checksum will generally be accurate. Thus an e mail message identified as spam based on a mathematical calculation will be given a higher weighted value than for example a keyword identification.

In addition the rules applied to filter module may be additive such that it may take several rules to fire to allow filter module to decide that a message is spam. In such an embodiment the relative weights of the rules which identify the message as spam can be added together to establish a cumulative weighted value. Moreover a filter module in this embodiment may be configured based on how aggressively filter module should screen e mail messages. For example filter module may configured to screen all e mail messages with a cumulative weighted value of 6.

In one embodiment rules have two weights associated with them 1 a spam weight this weight indicates the certainty that if a rule fires successfully against a message the message is Spam and 2 a priority weight this weight indicates the frequency of use and most recent use of a rule. In addition in this embodiment two different priority weights may be associated with a rule a global priority weight and a local priority weight.

Spam Weight is an arbitrary weight chosen by a rule designer based on internal heuristics to reflect the certainty that the rule will correctly identify Spam. General rules for example that don t definitively identify Spam but are designed to detect typical Spammer practices may be provided lower weights that rules which target a specific type of spam. Thus because of their low assigned weight general rules may need to fire along with other rules general or not for spam to be filtered by filter module or .

In this embodiment new rules are assigned the highest Priority Weight. As statistics on rule usage are compiled the priority weight may change to reflect how often the rule is used. For example if a new rule is generated and isn t used within a configured period of time the rule s priority weight will decrease. Similarly if a rule has been used recently or frequently within a designated interval the priority weight will be increased. Global priority weight reflects a rule s usage at all known filter modules across a network e.g. network whereas local priority weight reflects a rule s usage at a specific node e.g. filter module .

The spam weight and priority weight of a set of rules may be combined mathematically to prioritize rules within the set. In one embodiment the spam weight and priority weight of each rule within the set are multiplied together and the results of the multiplications are ordered sequentially. Those rules associated with numerically higher results i.e. which are used more frequently and are more likely to correctly identify spam are assigned higher priorities within the set.

Moreover rules assigned higher priorities will tend to be executed earlier against messages applied to the filter module resulting in a more efficient spam filtration system. In other words spam will be identified more quickly because rules with a higher usage frequency and detection accuracy will be implemented first. In addition both the Global and Local Priority weights may be multiplied with a rule s Spam Weight as described above to evaluate new orderings within the set of rules.

One problem associated with the implementation of filter modules and as described above is that in order for client to receive the benefit of a server side filter module it must be set up and maintained by the administrator of server . For example if the user of client belongs to an online service say for example Netcom that user will not be able to implement a server side filter if Netcom does not provide one. Moreover assuming arguendo that Netcom offers a server side e mail filter the user of client will be limited to the type of filter offered. If the filter is merely a static filter the user will not be able to significantly tailor it to his specific preferences.

As described above user agent executed on client allows client to check for e mail in mailbox on mail server . E mail user agents known in the art include Microsoft Outlook Lotus cc mail Lotus Notes Novell Groupwise Eudora and Netscape Communicator . In order for any one of these user agents to retrieve mail from mailbox on mail server the user agent must be configured with the correct network address e.g. mail.isp.com as shown in and the correct mail protocol e.g. POP3 in our example . If configured properly user agent will initially send a user name and password to open communication with mail server mail.isp.com during the POP3 authentication stage as described in detail above with reference to FIG. .

Thus referring now to as well as when user agent is executed it initially sends its user name to mail.proxy.com rather than mail.isp.com where its mailbox resides signal . Proxy server then communicates the user name to mail server on behalf of client signal . Once mail server responds with a positive indication signal proxy server passes on the response to client signal . Client then transmits a password associated with the user name to proxy server . Once again proxy server forwards this information to mail server on behalf of client signal and forwards the response from mail server signal on to client signal . In another embodiment proxy server requests both the password and the user name from client before initiating contact with mail server .

Referring now to client sends a LIST command to proxy server signal requesting a list of current e mail messages and proxy server forwards the command to mail server signal on behalf of client . In response to the list signal mail server sends a response to proxy server that there are currently 100 messages stored in mailbox signal . Proxy server then begins retrieving each of the 100 messages starting with the RETR signal to retrieve message . Upon receiving message signal proxy server applies filter module to the incoming message to determine whether message is spam or legitimate e mail. In one embodiment filter module also scans message for computer viruses and processes message accordingly. If message is legitimate it is stored in mail storage module to be subsequently transferred to client . However if message is spam it is filtered into spam storage module . Similarly if message contains a computer virus it can be filtered into a virus storage module not shown .

In one embodiment client may send a request to proxy server to view messages which have been filtered into spam storage module or into a virus storage module . Client can then insure that legitimate messages have not been inadvertently filtered by filter module . As such in this embodiment proxy server will store spam in spam storage module for a predetermined length of time. Alternatively client may be allocated a predetermined amount of memory in spam storage module . When this memory has been filled up with spam the oldest spam messages will be forced out to make room for new spam messages. In addition client may be periodically notified that spam has been filtered into spam storage module . Once client has checked spam storage area to view messages which have been filtered the user may choose to redirect one or more filtered messages back into mail storage module illustrated as signal of FIG. . Once this decision has been made the user may modify one or more rule based filter modules to ensure that this type of e mail message is no longer filtered.

Proxy server continues to retrieve messages from mail server one at a time signals et seq. until the last message e.g. message not illustrated in FIG. has been retrieved. Filter module applies its set of rules to identify spam computer viruses or other types of e mail messages and sorts the retrieved messages accordingly. In the embodiment illustrated in e mail is filtered into either spam storage module or mail storage module .

At some predetermined point in time represented by the dashed line in client will require a response from proxy server . In one embodiment this time period hereinafter timeout period is based on how long user agent on client will wait for a mail server response before timing out and possibly issuing an error message to the user . In another embodiment the timeout period is determined by how long a typical user will tolerate waiting for an initial response from his her mail server. Regardless of how the timeout period is calculated once it has been reached proxy server transfers all legitimate e mail messages which have been processed i.e. messages which have been identified as non spam and virus free by filter module and transferred to mail storage module to client .

In the signal diagram shown in timeout period is reached after proxy server has processed 4 of the 100 e mail messages from mail server . Of these four messages messages and signals and have been identified as spam and transferred to spam storage area . Messages and signals and however have been identified as legitimate. Thus following timeout period only legitimate messages and are presented to user agent in response to user agent s LIST command presented as messages and . In response client retrieves messages and identified by client as messages and from mail storage module on proxy server signals through . Client then sends the QUIT command signal and ends the e mail retrieval session with proxy server .

Following timeout period however proxy server continues retrieving and processing the 96 e mail messages remaining on mail server as described above. At some point after proxy server has completed processing the remaining 96 messages user agent on client sends another LIST command to proxy server thereby requesting a list of current e mail messages signal . At this point proxy server has processed the 96 additional e mail messages following timeout period . For the purposes of the following discussion it will be assumed that of the 96 messages processed after timeout period were identified as spam by filter module . Thus by the time client sends LIST signal filter module has transferred 48 messages into spam storage module and 48 messages into mail storage module .

Upon receiving the LIST signal from client proxy server sends a second list signal to mail server to determine whether additional e mail messages addressed to client have been received at mailbox since proxy server and mail server last communicated. In the example illustrated in server sends signal indicating that one additional message has been received during this period. Accordingly proxy server retrieves the additional e mail message signals and and determines that it is legitimate by passing it through filter module . Proxy server then terminates communication with mail server by issuing the QUIT command signal .

Thus in response to client s LIST command proxy server sends a response signal indicating that 49 e mail messages are currently available all of which are legitimate e mail messages. Client will subsequently proceed to retrieve each of the 49 remaining messages from mail storage module on proxy server although these signals are not illustrated in the signal chart of FIG. . The end result is that client only downloads legitimate e mail and thereby conserves time access cost and hard drive space. In addition client is able to implement the current system and method without modifying his ISP account online service provider account or corporate mail server account all of which are represented by mail server . In other words because proxy server sends the user name and password of client to mail server mail server assumes that it is client connecting in to retrieve mail. As such no modification is required to client s account on mail server .

In one embodiment proxy server will store cleaned e mail messages in mail storage module even after the messages have been downloaded by client . This is done so that the messages do not have to be filtered a second time if client need to access the messages again e.g. if the user of client attempts to check e mail from a different computer .

Referring now to in one embodiment two or more user accounts may be established on server or proxy server such that one user reviews the filtered e mail of another user. Thus user is assigned a personal mail storage area which contains e mail messages which have passed through filter module and have been identified as legitimate . User also has access to a personal spam storage area which contains e mail messages identified as spam by filter module . In addition user can view messages stored in a spam storage area assigned to user and select via control unit messages to pass through to user s mail storage . Thus in this embodiment user may be a parent who sets filter module to aggressively filter messages i.e. to trigger at a low threshold as described above addressed to his her child user . User can then review the messages before allowing the child user to access the messages. Alternatively user may be a corporate network administrator reviewing filtered messages for an employee to determine whether the filtered messages have been filtered correctly.

In another embodiment once a particular e mail message has been identified as spam only a single copy of that message is stored in spam storage module regardless of how many different e mail users the message is addressed to. This technique of caching only one copy of a spam message in spam storage module allows proxy server to conserve significant space in spam storage area given the fact that spam is commonly distributed to thousands of e mail users at a time.

One of ordinary skill in the art will readily recognize from the following discussion that alternative embodiments of the structures and methods illustrated herein may be employed without departing from the principles of the invention. Throughout this detailed description numerous specific details are set forth such as specific mail protocols i.e. POP3 and filter applications e.g. spam removal in order to provide a thorough understanding of the present invention. It will be appreciated by one having ordinary skill in the art however that the present invention may be practiced without such specific details. In other instances well known software implemented communication techniques have not been described in detail in order to avoid obscuring the subject matter of the present invention. The invention should therefore be measured in terms of the claims which follow.

